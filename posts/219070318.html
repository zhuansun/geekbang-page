<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>13 ｜让AI帮你写测试，体验多步提示语 | geekbang</title><meta name="author" content="码农张三"><meta name="copyright" content="码农张三"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="13 ｜让AI帮你写测试，体验多步提示语你好，我是徐文浩。 上一讲，我们一起通过ChatGPT做了一个小应用。不过，这个过程并不是一个“自动档”的。我们尝试一步一步输入我们的需求，给到ChatGPT，并根据拿到的指示尝试运行代码。通过和ChatGPT不断地交互，我们最终完成了一个小应用。 虽然这在我们探索性地开发一些功能的时候，已经极大地提高了我们的效率。但是这个过程并不能做成一个产品。我们理想中">
<meta property="og:type" content="article">
<meta property="og:title" content="13 ｜让AI帮你写测试，体验多步提示语">
<meta property="og:url" content="https://zhuansun.github.io/geekbang/posts/219070318.html">
<meta property="og:site_name" content="geekbang">
<meta property="og:description" content="13 ｜让AI帮你写测试，体验多步提示语你好，我是徐文浩。 上一讲，我们一起通过ChatGPT做了一个小应用。不过，这个过程并不是一个“自动档”的。我们尝试一步一步输入我们的需求，给到ChatGPT，并根据拿到的指示尝试运行代码。通过和ChatGPT不断地交互，我们最终完成了一个小应用。 虽然这在我们探索性地开发一些功能的时候，已经极大地提高了我们的效率。但是这个过程并不能做成一个产品。我们理想中">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg">
<meta property="article:published_time" content="2023-10-20T09:48:40.000Z">
<meta property="article:modified_time" content="2023-12-13T10:43:13.987Z">
<meta property="article:author" content="码农张三">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhuansun.github.io/geekbang/posts/219070318"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '13 ｜让AI帮你写测试，体验多步提示语',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-12-13 10:43:13'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="geekbang" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://pic.imgdb.cn/item/653470a0c458853aef5813f1.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">804</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">geekbang</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">13 ｜让AI帮你写测试，体验多步提示语</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-10-20T09:48:40.000Z" title="发表于 2023-10-20 09:48:40">2023-10-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AI%E5%A4%A7%E6%A8%A1%E5%9E%8B%E4%B9%8B%E7%BE%8E/">AI大模型之美</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="13-｜让AI帮你写测试，体验多步提示语"><a href="#13-｜让AI帮你写测试，体验多步提示语" class="headerlink" title="13 ｜让AI帮你写测试，体验多步提示语"></a>13 ｜让AI帮你写测试，体验多步提示语</h1><p>你好，我是徐文浩。</p>
<p>上一讲，我们一起通过ChatGPT做了一个小应用。不过，这个过程并不是一个“自动档”的。我们尝试一步一步输入我们的需求，给到ChatGPT，并根据拿到的指示尝试运行代码。通过和ChatGPT不断地交互，我们最终完成了一个小应用。</p>
<p>虽然这在我们探索性地开发一些功能的时候，已经极大地提高了我们的效率。但是这个过程并不能做成一个产品。我们理想中的产品应该是“自动档”的，我们只要用自然语言输入自己的需求，对应的代码就自动写出来了。如果中间出现了错误，AI可以自己拿到反馈来更正，而不需要我们人工去介入调试，或者复制粘贴。</p>
<h2 id="先让GPT-4写个代码"><a href="#先让GPT-4写个代码" class="headerlink" title="先让GPT-4写个代码"></a>先让GPT-4写个代码</h2><p>这个思路听起来似乎有些科幻，但是随着GPT-4的发布，以及未来模型能力的进一步增长，这其实并不是遥不可及的。不过，这个时候你应该还只有GPT-3.5的API权限。所以这一讲，我们还是先把目标放低一点，先来 <strong>通过大语言模型，帮我们自动写单元测试代码</strong>。整个过程仍然是一个自动档的体验，只是能够提供的能力还相对比较简单，仅限于为现有代码提供单元测试而已。</p>
<p>这个想法，源自OpenAI Cookbook提供的 <a target="_blank" rel="noopener" href="https://github.com/openai/openai-cookbook/blob/main/examples/Unit_test_writing_using_a_multi-step_prompt.ipynb">AI 写单元测试的示例</a>。但是那个例子里面的代码，已经不能使用了，因为对应的code-davinci-002模型已经被OpenAI下线了。但是例子里，分步骤分析问题，通过多个Prompts来完成单元测试的想法，还是非常有借鉴意义的。</p>
<p>我相信学完这一讲之后，随着你拿到GPT-4的API乃至未来可能会出现的GPT-5，你都完全可以用同样的方法完成更复杂的“自动写代码”的程序。</p>
<h2 id="设计一个有些挑战的小题目"><a href="#设计一个有些挑战的小题目" class="headerlink" title="设计一个有些挑战的小题目"></a>设计一个有些挑战的小题目</h2><p>要写测试，我们要先有一个程序。为了避免这个题目本身就在AI的训练数据集里面，它直接知道答案，我们就不选用像Leetcode这样的题库了。我用了这样一个我觉得很有意思的小题目，也就是让Python根据我们输入的一个整数代表的秒数，格式化成一段自然语言描述的时间。比如，输入1就返回1s，输入61就返回1min1s。</p>
<p>需求：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">用Python写一个函数，进行时间格式化输出，比如：
输入  输出
<span class="token number">1</span>  1s
<span class="token number">61</span>  1min1s
要求仅需要格式化到小时<span class="token punctuation">(</span>?h?<span class="token builtin">min</span>?s<span class="token punctuation">)</span>，即可
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>题目有了，我们还需要一个正确的解题程序。我们今天的重点不是怎么用AI刷题，所以我们不如直接让ChatGPT帮我们把程序写好。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/911bd13b46f77ae8a6d0c6c9d62cbb28.png" alt="图片"></p>
<p>这是对应的Notebook里面的代码。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">format_time</span><span class="token punctuation">(</span>seconds<span class="token punctuation">)</span><span class="token punctuation">:</span>
    minutes<span class="token punctuation">,</span> seconds <span class="token operator">=</span> <span class="token builtin">divmod</span><span class="token punctuation">(</span>seconds<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>
    hours<span class="token punctuation">,</span> minutes <span class="token operator">=</span> <span class="token builtin">divmod</span><span class="token punctuation">(</span>minutes<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> hours <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>hours<span class="token punctuation">&#125;</span></span><span class="token string">h</span><span class="token interpolation"><span class="token punctuation">&#123;</span>minutes<span class="token punctuation">&#125;</span></span><span class="token string">min</span><span class="token interpolation"><span class="token punctuation">&#123;</span>seconds<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span>
    <span class="token keyword">elif</span> minutes <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>minutes<span class="token punctuation">&#125;</span></span><span class="token string">min</span><span class="token interpolation"><span class="token punctuation">&#123;</span>seconds<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>seconds<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到，AI快速给出了一个小程序，看上去没啥问题，能够完成我们想要的基本功能。</p>
<p>既然ChatGPT可以写代码，我们自然也可以让它帮我们把单元测试也写好。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/bfb1a5247b6633da2bc01ac8abccab77.png" alt="图片"></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">conda install pytest
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这是对应的Notebook里面的代码。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pytest

<span class="token keyword">def</span> <span class="token function">test_format_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">assert</span> format_time<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"1s"</span>
    <span class="token keyword">assert</span> format_time<span class="token punctuation">(</span><span class="token number">59</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"59s"</span>
    <span class="token keyword">assert</span> format_time<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"1min0s"</span>
    <span class="token keyword">assert</span> format_time<span class="token punctuation">(</span><span class="token number">61</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"1min1s"</span>
    <span class="token keyword">assert</span> format_time<span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"1h0min0s"</span>
    <span class="token keyword">assert</span> format_time<span class="token punctuation">(</span><span class="token number">3661</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"1h1min1s"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>乍一看，我们的单元测试已经写完了，那这一讲就结束了吗？当然不是了。如果你是一个比较有经验的程序员，你就会发现这个单元测试其实还是有好几个问题的。</p>
<ol>
<li>这个测试没有考虑负数。如果我们输入的是负数会怎么样？</li>
<li>没有考虑非整数类型的输入，如果我们输入浮点数 1.0 会怎么样？字符串“abc”会怎么样？nil这样的空值会怎么样？</li>
<li>是即使是整数，我们还没有考虑过，超过24小时的话，格式化后的结果是怎么样的。</li>
</ol>
<h2 id="分解步骤撰写Prompts"><a href="#分解步骤撰写Prompts" class="headerlink" title="分解步骤撰写Prompts"></a>分解步骤撰写Prompts</h2><p>所以，很多事情不是我们直接把问题一塞，给到ChatGPT就能解决的。 <strong>我们需要反过来自己思考一下，如果我们自己来为一段代码写单元测试，我们会怎么做？</strong></p>
<p>OpenAI的示例里给出了一个很好的思路，那就是把问题拆分成三个步骤。</p>
<ol>
<li>把代码提交给大语言模型，让大语言模型解释一下，这个代码是在干什么。</li>
<li>把代码以及代码的解释一起交给大语言模型，让大语言模型规划一下，针对这个代码逻辑，我们到底要写哪几个TestCase。如果在这个过程里，大语言模型规划的TestCase数量太少，那么我们就重复第二步，让AI多生成几个TestCase。</li>
<li>针对上面的TestCase的详细描述，再提交给大语言模型，让它根据这些描述生成具体的测试代码。在这个过程中，我们还会对生成的代码，进行一次语法检查，如果语法检查没法通过，我们就要让AI重新生成一下。这个可以避免因为大语言模型的概率采样不稳定，导致生成的代码无法运行的问题。</li>
</ol>
<p>最后，我们来实际运行一下这些代码，看看我们的代码能不能通过这些自动化测试。</p>
<h3 id="请AI解释要测试的代码"><a href="#请AI解释要测试的代码" class="headerlink" title="请AI解释要测试的代码"></a>请AI解释要测试的代码</h3><p>那最后，我们就根据这个步骤一步步拆解，通过Python程序来把整个过程“自动化”掉。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">gpt35</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">"text-davinci-002"</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">,</span> max_tokens<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
          top_p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stop<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"\n\n"</span><span class="token punctuation">,</span> <span class="token string">"\n\t\n"</span><span class="token punctuation">,</span> <span class="token string">"\n    \n"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> openai<span class="token punctuation">.</span>Completion<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
        model<span class="token operator">=</span>model<span class="token punctuation">,</span>
        prompt <span class="token operator">=</span> prompt<span class="token punctuation">,</span>
        temperature <span class="token operator">=</span> temperature<span class="token punctuation">,</span>
        max_tokens <span class="token operator">=</span> max_tokens<span class="token punctuation">,</span>
        top_p <span class="token operator">=</span> top_p<span class="token punctuation">,</span>
        stop <span class="token operator">=</span> stop
        <span class="token punctuation">)</span>
    message <span class="token operator">=</span> response<span class="token punctuation">[</span><span class="token string">"choices"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> message

code <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
def format_time(seconds):
    minutes, seconds = divmod(seconds, 60)
    hours, minutes = divmod(minutes, 60)

    if hours > 0:
        return f"&#123;hours&#125;h&#123;minutes&#125;min&#123;seconds&#125;s"
    elif minutes > 0:
        return f"&#123;minutes&#125;min&#123;seconds&#125;s"
    else:
        return f"&#123;seconds&#125;s"
"""</span>

<span class="token keyword">def</span> <span class="token function">explain_code</span><span class="token punctuation">(</span>function_to_test<span class="token punctuation">,</span> unit_test_package<span class="token operator">=</span><span class="token string">"pytest"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    prompt <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f""""# How to write great unit tests with </span><span class="token interpolation"><span class="token punctuation">&#123;</span>unit_test_package<span class="token punctuation">&#125;</span></span><span class="token string">

In this advanced tutorial for experts, we'll use Python 3.10 and `</span><span class="token interpolation"><span class="token punctuation">&#123;</span>unit_test_package<span class="token punctuation">&#125;</span></span><span class="token string">` to write a suite of unit tests to verify the behavior of the following function.
```python
</span><span class="token interpolation"><span class="token punctuation">&#123;</span>function_to_test<span class="token punctuation">&#125;</span></span><span class="token string">

Before writing any unit tests, let's review what each element of the function is doing exactly and what the author's intentions may have been.
- First,"""</span></span>
    response <span class="token operator">=</span> gpt35<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
    <span class="token keyword">return</span> response<span class="token punctuation">,</span> prompt

code_explaination<span class="token punctuation">,</span> prompt_to_explain_code <span class="token operator">=</span> explain_code<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>code_explaination<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在第一步里，我们的代码做了这样几件事情。</p>
<p>首先是定义了一个gpt35的函数，对调用GPT3.5的模型做了简单的封装。其中有2点需要注意。</p>
<ol>
<li>我们默认使用 text-davinci-002 模型，这是一个通过监督学习微调的生成文本的模型。因为这里我们希望生成目标明确的文本的代码解释，所以选用了这个模型。</li>
<li>我们对stop做了特殊的设置，只要连续两个换行或者类似连续两个换行的情况出现，就中止数据的生成。这是避免模型一口气连测试代码也生成出来。那样的话，我们没法对测试代码的生成提出具体的要求。通过stop，我们可以确保在第一步，只解释现在的功能代码有什么用。</li>
</ol>
<p>然后，我们通过一组精心设置过的提示语，让GPT模型为我们来解释代码。我们在提示语里做了4件事情。</p>
<ul>
<li>指定了使用 pytest 这个测试包。</li>
<li>把对应要测试的代码，也提供给了GPT模型。</li>
<li>告诉AI，要精确描述代码做了什么。</li>
<li>在最后一行用 “- First” 开头，引导GPT模型，逐步分行描述要测试的代码干了什么。</li>
</ul>
<p>输出结果：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain"> we use the `divmod` built-in function to get the quotient and remainder of `seconds` divided by 60. This is assigned to the variables `minutes` and `seconds`, respectively.
- Next, we do the same thing with `minutes` and 60, assigning the results to `hours` and `minutes`.
- Finally, we use string interpolation to return a string formatted according to how many hours/minutes/seconds are left.
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>运行第一步的代码，我们可以看到，AI回复了几个步骤，详细地描述了我们格式化时间的代码是怎么做的。</p>
<h3 id="请AI根据代码解释制定测试计划"><a href="#请AI根据代码解释制定测试计划" class="headerlink" title="请AI根据代码解释制定测试计划"></a>请AI根据代码解释制定测试计划</h3><p>接下来，我们就根据生成的这个详细描述，请AI为我们制定一下具体的测试计划。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">generate_a_test_plan</span><span class="token punctuation">(</span>full_code_explaination<span class="token punctuation">,</span> unit_test_package<span class="token operator">=</span><span class="token string">"pytest"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    prompt_to_explain_a_plan <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""

A good unit test suite should aim to:
- Test the function's behavior for a wide range of possible inputs
- Test edge cases that the author may not have foreseen
- Take advantage of the features of `</span><span class="token interpolation"><span class="token punctuation">&#123;</span>unit_test_package<span class="token punctuation">&#125;</span></span><span class="token string">` to make the tests easy to write and maintain
- Be easy to read and understand, with clean code and descriptive names
- Be deterministic, so that the tests always pass or fail in the same way

`</span><span class="token interpolation"><span class="token punctuation">&#123;</span>unit_test_package<span class="token punctuation">&#125;</span></span><span class="token string">` has many convenient features that make it easy to write and maintain unit tests. We'll use them to write unit tests for the function above.

For this particular function, we'll want our unit tests to handle the following diverse scenarios (and under each scenario, we include a few examples as sub-bullets):
-"""</span></span>
    prompt <span class="token operator">=</span> full_code_explaination <span class="token operator">+</span> prompt_to_explain_a_plan
    response <span class="token operator">=</span> gpt35<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
    <span class="token keyword">return</span> response<span class="token punctuation">,</span> prompt

test_plan<span class="token punctuation">,</span> prompt_to_get_test_plan <span class="token operator">=</span> generate_a_test_plan<span class="token punctuation">(</span>prompt_to_explain_code <span class="token operator">+</span> code_explaination<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>test_plan<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们整个测试计划的提示语，同样经过了精心设计。我们先是对AI做了几个要求。</p>
<ol>
<li>我们要求测试用例，尽量考虑输入的范围广一些。</li>
<li>我们要求AI想一些连代码作者没有想到过的边界条件。</li>
<li>我们希望AI能够利用好 pytest 这个测试包的特性。</li>
<li>希望测试用例清晰易读，测试的代码要干净。</li>
<li>我们要求测试代码的输出结果是确定的，要么通过，要么失败，不要有随机性。</li>
</ol>
<p><strong>然后，我们的提示语并没有立刻让AI去写测试代码，而是说我们要举几个例子。这样，AI就会生成一系列的示例。</strong> 我们对测试用例的提示是非常详尽的，这也是我们前面第一步没有直接让AI生成测试用例的原因。因为那样的话，我们没法在提示语中间插入这些详尽的要求。对具体的测试用例，只能寄希望于AI想得多一些。</p>
<p>最后，我们发给AI的提示语，则是既包括了第一步要求解释代码的内容，也包括AI生成的对代码的解释，以及这里我们新增的对测试用例的要求，提供了非常详细的上下文，这样AI的表现也会更好、更有逻辑性。</p>
<p>输出结果：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain"> Normal behavior:
    - `format_time(0)` should return `"0s"`
    - `format_time(59)` should return `"59s"`
    - `format_time(60)` should return `"1min0s"`
    - `format_time(119)` should return `"1min59s"`
    - `format_time(3600)` should return `"1h0min0s"`
    - `format_time(3601)` should return `"1h0min1s"`
    - `format_time(3660)` should return `"1h1min0s"`
    - `format_time(7200)` should return `"2h0min0s"`
- Invalid inputs:
    - `format_time(None)` should raise a `TypeError`
    - `format_time("abc")` should raise a `TypeError`
    - `format_time(-1)` should raise a `ValueError`
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我运行了一下这个代码，可以看到，AI提供了很多测试用例。并且，里面考虑了好几种情况，包括我们前面提到的负数这样的特殊条件，也包括输入字符串，以及None这样的内容。</p>
<p>不过，生成哪些用例其实是有一定的随机性的。这个也是大语言模型的一个缺点，就是可控性差。有时候，AI可能就只生成了3个用例，那样的话就会有很多情况我们的用例覆盖不到。</p>
<p>所以，我们可以在生成用例之后，加一个步骤，检查一下到底生成了多少个用例。如果太少的话，我们就让AI再生成一些。我在下面给了一段示例代码，通过“\n-”这样一个换行加横杆的标记来判断之前生成的测试用例数量，如果比我们设定的下限少，我们就再添加一段提示语，让AI再生成一些。</p>
<p>这里的提示语，我们要特别提醒AI考虑一下测试罕见情况和边界条件。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">not_enough_test_plan <span class="token operator">=</span> <span class="token triple-quoted-string string">"""The function is called with a valid number of seconds
    - `format_time(1)` should return `"1s"`
    - `format_time(59)` should return `"59s"`
    - `format_time(60)` should return `"1min"`
"""</span>

approx_min_cases_to_cover <span class="token operator">=</span> <span class="token number">7</span>
elaboration_needed <span class="token operator">=</span> test_plan<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">"\n-"</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token number">1</span> <span class="token operator">&lt;</span> approx_min_cases_to_cover
<span class="token keyword">if</span> elaboration_needed<span class="token punctuation">:</span>
        prompt_to_elaborate_on_the_plan <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""

In addition to the scenarios above, we'll also want to make sure we don't forget to test rare or unexpected edge cases (and under each edge case, we include a few examples as sub-bullets):
-"""</span></span>
        more_test_plan<span class="token punctuation">,</span> prompt_to_get_test_plan <span class="token operator">=</span> generate_a_test_plan<span class="token punctuation">(</span>prompt_to_explain_code <span class="token operator">+</span> code_explaination <span class="token operator">+</span> not_enough_test_plan <span class="token operator">+</span> prompt_to_elaborate_on_the_plan<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>more_test_plan<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出结果：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain"> The function is called with a valid number of seconds
    - `format_time(1)` should return `"1s"`
    - `format_time(59)` should return `"59s"`
    - `format_time(60)` should return `"1min"`
- The function is called with an invalid number of seconds
    - `format_time(-1)` should raise a `ValueError`
    - `format_time("60")` should raise a `TypeError`
- The function is called with a `None` value
    - `format_time(None)` should raise a `TypeError`
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="根据测试计划生成测试代码"><a href="#根据测试计划生成测试代码" class="headerlink" title="根据测试计划生成测试代码"></a>根据测试计划生成测试代码</h3><p>当然，大部分情况下，生成的测试用例数都和我们前面的实际情况是一样的。那我们就可以直接用原来的代码、代码的解释以及测试用例，作为提示语，让AI帮我们写具体的测试了。</p>
<p>这里的提示语也没有什么稀奇的，其实就是把前面已经生成的所有内容拼接在一起，然后要求AI根据前面的内容来写具体的测试代码。唯一有一点值得注意的是，为了避免AI忘记一开头功能代码的内容，我们特地再在提示语的最后，再次给AI看了一下我们要测试的功能代码。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">generate_test_cases</span><span class="token punctuation">(</span>function_to_test<span class="token punctuation">,</span> unit_test_package<span class="token operator">=</span><span class="token string">"pytest"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    starter_comment <span class="token operator">=</span> <span class="token string">"Below, each test case is represented by a tuple passed to the @pytest.mark.parametrize decorator"</span>
    prompt_to_generate_the_unit_test <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""

Before going into the individual tests, let's first look at the complete suite of unit tests as a cohesive whole. We've added helpful comments to explain what each line does.
```python
import </span><span class="token interpolation"><span class="token punctuation">&#123;</span>unit_test_package<span class="token punctuation">&#125;</span></span><span class="token string">  # used for our unit tests

</span><span class="token interpolation"><span class="token punctuation">&#123;</span>function_to_test<span class="token punctuation">&#125;</span></span><span class="token string">

#</span><span class="token interpolation"><span class="token punctuation">&#123;</span>starter_comment<span class="token punctuation">&#125;</span></span><span class="token string">"""</span></span>
    full_unit_test_prompt <span class="token operator">=</span> prompt_to_explain_code <span class="token operator">+</span> code_explaination <span class="token operator">+</span> test_plan <span class="token operator">+</span> prompt_to_generate_the_unit_test
    <span class="token keyword">return</span> gpt35<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">"text-davinci-003"</span><span class="token punctuation">,</span> prompt<span class="token operator">=</span>full_unit_test_prompt<span class="token punctuation">,</span> stop<span class="token operator">=</span><span class="token string">"```"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> prompt_to_generate_the_unit_test

unit_test_response<span class="token punctuation">,</span> prompt_to_generate_the_unit_test <span class="token operator">=</span> generate_test_cases<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>unit_test_response<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出结果：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">.</span>
<span class="token comment">#The first element of the tuple is the name of the test case, and the second element is the value to be passed to the format_time() function.</span>
<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>parametrize</span><span class="token punctuation">(</span><span class="token string">'test_input,expected'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">'0s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'59'</span><span class="token punctuation">,</span> <span class="token string">'59s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'60'</span><span class="token punctuation">,</span> <span class="token string">'1min0s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'119'</span><span class="token punctuation">,</span> <span class="token string">'1min59s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'3600'</span><span class="token punctuation">,</span> <span class="token string">'1h0min0s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'3601'</span><span class="token punctuation">,</span> <span class="token string">'1h0min1s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'3660'</span><span class="token punctuation">,</span> <span class="token string">'1h1min0s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'7200'</span><span class="token punctuation">,</span> <span class="token string">'2h0min0s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">test_format_time</span><span class="token punctuation">(</span>test_input<span class="token punctuation">,</span> expected<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#For each test case, we call the format_time() function and compare the returned value to the expected value.</span>
    <span class="token keyword">assert</span> format_time<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>test_input<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> expected

<span class="token comment">#We use the @pytest.mark.parametrize decorator again to test the invalid inputs.</span>
<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>parametrize</span><span class="token punctuation">(</span><span class="token string">'test_input'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token boolean">None</span><span class="token punctuation">,</span>
    <span class="token string">'abc'</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">test_format_time_invalid_inputs</span><span class="token punctuation">(</span>test_input<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#For each invalid input, we expect a TypeError or ValueError to be raised.</span>
    <span class="token keyword">with</span> pytest<span class="token punctuation">.</span>raises<span class="token punctuation">(</span><span class="token punctuation">(</span>TypeError<span class="token punctuation">,</span> ValueError<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        format_time<span class="token punctuation">(</span>test_input<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>运行一下这段提示语，我们就拿到了最终输出的测试代码。可以看到，这个测试代码不仅有正常情况下的测试，也包含了异常输入的测试。</p>
<h3 id="通过AST库进行语法检查"><a href="#通过AST库进行语法检查" class="headerlink" title="通过AST库进行语法检查"></a>通过AST库进行语法检查</h3><p>不过这还没有完，我们最好还是再检查一下生成的测试代码的语法，这个可以通过Python的AST库来完成。不过需要注意，检查语法的时候，我们不仅需要生成的测试代码，也需要原来的功能代码，不然是没办法通过语法检查的。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> ast

code_start_index <span class="token operator">=</span> prompt_to_generate_the_unit_test<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"```python\n"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">"```python\n"</span><span class="token punctuation">)</span>
code_output <span class="token operator">=</span> prompt_to_generate_the_unit_test<span class="token punctuation">[</span>code_start_index<span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> unit_test_response
<span class="token keyword">try</span><span class="token punctuation">:</span>
    ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>code_output<span class="token punctuation">)</span>
<span class="token keyword">except</span> SyntaxError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Syntax error in generated code: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>很幸运，我们一次就通过了语法检查。那么接下来，我们就可以把对应的整个测试代码打印出来，执行试一试。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>code_output<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>输出结果：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pytest  <span class="token comment"># used for our unit tests</span>

<span class="token keyword">def</span> <span class="token function">format_time</span><span class="token punctuation">(</span>seconds<span class="token punctuation">)</span><span class="token punctuation">:</span>
    minutes<span class="token punctuation">,</span> seconds <span class="token operator">=</span> <span class="token builtin">divmod</span><span class="token punctuation">(</span>seconds<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>
    hours<span class="token punctuation">,</span> minutes <span class="token operator">=</span> <span class="token builtin">divmod</span><span class="token punctuation">(</span>minutes<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> hours <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>hours<span class="token punctuation">&#125;</span></span><span class="token string">h</span><span class="token interpolation"><span class="token punctuation">&#123;</span>minutes<span class="token punctuation">&#125;</span></span><span class="token string">min</span><span class="token interpolation"><span class="token punctuation">&#123;</span>seconds<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span>
    <span class="token keyword">elif</span> minutes <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>minutes<span class="token punctuation">&#125;</span></span><span class="token string">min</span><span class="token interpolation"><span class="token punctuation">&#123;</span>seconds<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>seconds<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span>

<span class="token comment">#Below, each test case is represented by a tuple passed to the @pytest.mark.parametrize decorator.</span>
<span class="token comment">#The first element of the tuple is the name of the test case, and the second element is the value to be passed to the format_time() function.</span>
<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>parametrize</span><span class="token punctuation">(</span><span class="token string">'test_input,expected'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">'0s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'59'</span><span class="token punctuation">,</span> <span class="token string">'59s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'60'</span><span class="token punctuation">,</span> <span class="token string">'1min0s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'119'</span><span class="token punctuation">,</span> <span class="token string">'1min59s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'3600'</span><span class="token punctuation">,</span> <span class="token string">'1h0min0s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'3601'</span><span class="token punctuation">,</span> <span class="token string">'1h0min1s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'3660'</span><span class="token punctuation">,</span> <span class="token string">'1h1min0s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">'7200'</span><span class="token punctuation">,</span> <span class="token string">'2h0min0s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">test_format_time</span><span class="token punctuation">(</span>test_input<span class="token punctuation">,</span> expected<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#For each test case, we call the format_time() function and compare the returned value to the expected value.</span>
    <span class="token keyword">assert</span> format_time<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>test_input<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> expected

<span class="token comment">#We use the @pytest.mark.parametrize decorator again to test the invalid inputs.</span>
<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>parametrize</span><span class="token punctuation">(</span><span class="token string">'test_input'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token boolean">None</span><span class="token punctuation">,</span>
    <span class="token string">'abc'</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">test_format_time_invalid_inputs</span><span class="token punctuation">(</span>test_input<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#For each invalid input, we expect a TypeError or ValueError to be raised.</span>
    <span class="token keyword">with</span> pytest<span class="token punctuation">.</span>raises<span class="token punctuation">(</span><span class="token punctuation">(</span>TypeError<span class="token punctuation">,</span> ValueError<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        format_time<span class="token punctuation">(</span>test_input<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="看看自动生成的测试帮我们抓了什么Bug"><a href="#看看自动生成的测试帮我们抓了什么Bug" class="headerlink" title="看看自动生成的测试帮我们抓了什么Bug"></a>看看自动生成的测试帮我们抓了什么Bug</h3><p>我们可以把对应生成的代码，单独复制到一个auto_unit_test.py文件里面。然后去命令行里执行一下 pytest 这个命令，看看结果是怎样的。我这里，对应的会有一个测试用例失败，就是当输入是-1的时候，测试用例预期会遇到一个TypeError或者ValueError的报错，但是实际并没有。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/b286513b33fa442a6c6fc4e5cb4dd1ae.png" alt="图片"></p>
<p>我们可以试着在Notebook里面调用一下 format_time(-1)，看看自动化测试跑得对不对。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">format_time<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>输出结果：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token string">'59min59s'</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以看到，输入-1的时候，输出变成了59min59s，看来AI生成的测试代码的确帮我们捕捉到了一个Bug。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>好了，到这里这一讲也就结束了。我们也有了一段完整的，可以针对一个Python函数生成一整套自动化测试的功能了，而且它还真的帮我们抓到了一个Bug。 <strong>生成整套测试代码的过程里，我们不需要人工地复制粘帖任何内容，全都是代码自动完成的，是一个“自动档”的过程。</strong></p>
<p>之所以能做到这一点，是因为我们巧妙地利用了一个方法，就是将一个问题，拆分成多个提示语的步骤，循序渐进地让AI通过解释代码，构造测试用例，最后再根据代码的解释和设计的测试用例，生成最终的自动化测试。</p>
<p>多步提示语带来的一个好处，就是我们的内容是更加有条理、有逻辑的，也更符合我们平时写文字的方式，而不是一股脑地把各种要求都放在提示语的开头，这在解决复杂问题时往往效果不好。</p>
<p>此外，我们这里使用的提示语也非常重要。正是因为我们能够分步骤提示AI，所以我们能在拿到代码的解释之后，让AI考虑各种边界条件。而AI也很给力，给出-1、None这样的特殊输入，让我们的测试代码最终真的抓住了程序里的Bug。</p>
<p>回过头来看，如果我们只是直接把代码往ChatGPT里一贴，虽然也能生成测试用例，但是那些测试用例就比较欠考虑，不会涵盖各种边角的情况。</p>
<h2 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h2><p>这一讲的代码有点长，思考题部分需要你做的事情也多一些。</p>
<ol>
<li>你可以试着减少我们的提示语或者提示步骤，看看生成的测试用例有什么样的变化。</li>
<li>目前我们的代码，是过程式地一步步给你演示整个测试代码是如何生成的。如果语法检查出错了，其实我们应该要从头开始重试一遍，再生成测试代码。你可以试着把整个代码封装修改，变成一个会自动重试3次的函数。让我们可以直接调用，来为Python代码生成自动化测试。</li>
<li>我们这一讲里的提示语是借鉴的OpenAI Cookbook里的样例，你能不能自己尝试总结一下，这些提示语有哪些值得借鉴的常用方法？</li>
</ol>
<p>欢迎你把思考后的结果分享在评论区，也欢迎你把这一讲分享给感兴趣的朋友，我们下一讲再见。</p>
<h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><p>之所以我们要循序渐进地提示AI，让AI生成例子再生成代码，是因为现在的大语言模型，有一种叫做“思维链（CoT）”的能力。当我们给出更详细的推理步骤的时候，AI的表现会更好。在OpenAI Cookbook里，专门有一章讲解 <a target="_blank" rel="noopener" href="https://github.com/openai/openai-cookbook/blob/main/techniques_to_improve_reliability.md">思维链能力</a>，你可以去好好研读一下。</p>
</article><div class="tag_share"><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#13-%EF%BD%9C%E8%AE%A9AI%E5%B8%AE%E4%BD%A0%E5%86%99%E6%B5%8B%E8%AF%95%EF%BC%8C%E4%BD%93%E9%AA%8C%E5%A4%9A%E6%AD%A5%E6%8F%90%E7%A4%BA%E8%AF%AD"><span class="toc-number">1.</span> <span class="toc-text">13 ｜让AI帮你写测试，体验多步提示语</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%88%E8%AE%A9GPT-4%E5%86%99%E4%B8%AA%E4%BB%A3%E7%A0%81"><span class="toc-number">1.1.</span> <span class="toc-text">先让GPT-4写个代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E6%9C%89%E4%BA%9B%E6%8C%91%E6%88%98%E7%9A%84%E5%B0%8F%E9%A2%98%E7%9B%AE"><span class="toc-number">1.2.</span> <span class="toc-text">设计一个有些挑战的小题目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E8%A7%A3%E6%AD%A5%E9%AA%A4%E6%92%B0%E5%86%99Prompts"><span class="toc-number">1.3.</span> <span class="toc-text">分解步骤撰写Prompts</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7AI%E8%A7%A3%E9%87%8A%E8%A6%81%E6%B5%8B%E8%AF%95%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.1.</span> <span class="toc-text">请AI解释要测试的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7AI%E6%A0%B9%E6%8D%AE%E4%BB%A3%E7%A0%81%E8%A7%A3%E9%87%8A%E5%88%B6%E5%AE%9A%E6%B5%8B%E8%AF%95%E8%AE%A1%E5%88%92"><span class="toc-number">1.3.2.</span> <span class="toc-text">请AI根据代码解释制定测试计划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E6%B5%8B%E8%AF%95%E8%AE%A1%E5%88%92%E7%94%9F%E6%88%90%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.3.</span> <span class="toc-text">根据测试计划生成测试代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87AST%E5%BA%93%E8%BF%9B%E8%A1%8C%E8%AF%AD%E6%B3%95%E6%A3%80%E6%9F%A5"><span class="toc-number">1.3.4.</span> <span class="toc-text">通过AST库进行语法检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9C%8B%E7%9C%8B%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E7%9A%84%E6%B5%8B%E8%AF%95%E5%B8%AE%E6%88%91%E4%BB%AC%E6%8A%93%E4%BA%86%E4%BB%80%E4%B9%88Bug"><span class="toc-number">1.3.5.</span> <span class="toc-text">看看自动生成的测试帮我们抓了什么Bug</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.4.</span> <span class="toc-text">小结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%80%83%E9%A2%98"><span class="toc-number">1.5.</span> <span class="toc-text">思考题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB"><span class="toc-number">1.6.</span> <span class="toc-text">推荐阅读</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By 码农张三</div></div><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/9.4.0/mermaid.min.js"></script></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div></div></body></html>