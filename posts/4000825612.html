<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>083丨程序员练级攻略：分布式架构工程设计 | geekbang</title><meta name="author" content="码农张三"><meta name="copyright" content="码农张三"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="要学好分布式架构，你首先需要学习一些架构指导性的文章和方法论，即分布式架构设计原则。下面是几篇很不错的文章，值得一读。  Designs, Lessons and Advice from Building Large Distributed Systems，Google 杰夫·迪恩（Jeff Dean）2009 年一次演讲的 PPT。2010 年，斯坦福大学请杰夫·迪恩到大学里给他们讲了一节课，你">
<meta property="og:type" content="article">
<meta property="og:title" content="083丨程序员练级攻略：分布式架构工程设计">
<meta property="og:url" content="https://zhuansun.github.io/geekbang/posts/4000825612.html">
<meta property="og:site_name" content="geekbang">
<meta property="og:description" content="要学好分布式架构，你首先需要学习一些架构指导性的文章和方法论，即分布式架构设计原则。下面是几篇很不错的文章，值得一读。  Designs, Lessons and Advice from Building Large Distributed Systems，Google 杰夫·迪恩（Jeff Dean）2009 年一次演讲的 PPT。2010 年，斯坦福大学请杰夫·迪恩到大学里给他们讲了一节课，你">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg">
<meta property="article:published_time" content="2023-10-20T09:48:40.000Z">
<meta property="article:modified_time" content="2023-10-21T14:12:09.751Z">
<meta property="article:author" content="码农张三">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhuansun.github.io/geekbang/posts/4000825612"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '083丨程序员练级攻略：分布式架构工程设计',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-21 14:12:09'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="geekbang" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://pic.imgdb.cn/item/653470a0c458853aef5813f1.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">84</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">geekbang</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">083丨程序员练级攻略：分布式架构工程设计</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-10-20T09:48:40.000Z" title="发表于 2023-10-20 09:48:40">2023-10-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B7%A6%E8%80%B3%E5%90%AC%E9%A3%8E/">左耳听风</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>要学好分布式架构，你首先需要学习一些架构指导性的文章和方法论，即分布式架构设计原则。下面是几篇很不错的文章，值得一读。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cs.cornell.edu/projects/ladis2009/talks/dean-keynote-ladis2009.pdf">Designs, Lessons and Advice from Building Large Distributed Systems</a>，Google 杰夫·迪恩（Jeff Dean）2009 年一次演讲的 PPT。2010 年，斯坦福大学请杰夫·迪恩到大学里给他们讲了一节课，你可以在 YouTube 上看一下，<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=modXC5IWTJI">Building Software Systems At Google and Lessons Learned</a> ，其回顾了 Google 发展的历史。</li>
<li><a target="_blank" rel="noopener" href="https://12factor.net/">The Twelve-Factor App</a> ，如今，软件通常会作为一种服务来交付，它们被称为网络应用程序，或软件即服务（SaaS）。12-Factor 为构建 SaaS 应用提供了方法论，是架构师必读的文章。（<a target="_blank" rel="noopener" href="https://12factor.net/zh_cn/">中译版</a>）这篇文章在业内的影响力很大，必读！</li>
<li><a target="_blank" rel="noopener" href="http://www.somethingsimilar.com/2013/01/14/notes-on-distributed-systems-for-young-bloods/">Notes on Distributed Systems for Young Bloods</a> ，给准备进入分布式系统领域的人的一些忠告。</li>
<li><a target="_blank" rel="noopener" href="https://www.usenix.org/legacy/event/lisa07/tech/full_papers/hamilton/hamilton_html/index.html">On Designing and Deploying Internet-Scale Services</a>（<a target="_blank" rel="noopener" href="http://darktea.github.io/notes/2014/07/23/On-Designing-and-Deploying-Internet-Scale-Services.html">中译版</a>），微软 Windows Live 服务平台的一些经验性的总结文章，很值得一读。</li>
<li><a target="_blank" rel="noopener" href="https://blog.box.com/blog/4-things-to-keep-in-mind-when-building-a-platform-for-the-enterprise/">4 Things to Keep in Mind When Building a Platform for the Enterprise</a> ，Box 平台 VP 海蒂·威廉姆斯（Heidi Williams）撰写的一篇文章，阐述了为企业构建平台时需要牢记的四件关于软件设计方面的事：1. Design Broadly, Build Narrowly； 2. Platforms Are Powerful and Flexible. Choose wisely what to expose when!；3. Build Incrementally, Get Feedback, and Iterate；4. Create a Platform-first Mentality。文章中有详细的解读，推荐看看。</li>
<li><a target="_blank" rel="noopener" href="https://www.usenix.org/conference/srecon17americas/program/presentation/rosenthal">Principles of Chaos Engineering</a> ，我们知道，Netflix 公司有一个叫 Chaos Monkey 的东西，这个东西会到分布式系统里“瞎搞”，以此来测试系统的健壮和稳定性。这个视频中，Netflix 分享了一些软件架构的经验和原则，值得一看。</li>
<li><a target="_blank" rel="noopener" href="https://www.igvita.com/2016/05/20/building-fast-and-resilient-web-applications/">Building Fast &amp; Resilient Web Applications</a> ，伊利亚·格里高利克（Ilya Grigorik）在 Google I&#x2F;O 2016 上的一次关于如何通过弹力设计来实现快速和可容错的网站架构的演讲，其中有好些经验分享。</li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2012/12/31/designing-for-resiliency-will-be-so-2013.html">Design for Resiliency</a> ，这篇文章带我们全面认识“弹力（Resiliency）”，以及弹力对于系统的重要性，并详细阐述了如何设计和实现系统的弹力。</li>
<li>微软的 Azure 网站上有一系列的 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/guide/design-principles/">Design Principle</a> 的文章，你可以看看这几篇： <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/guide/design-principles/self-healing">Design for Self-healing</a> 、<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/guide/design-principles/scale-out">Design for Scaling Out</a> 和 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/guide/design-principles/design-for-evolution">Design for Evolution</a> 。</li>
<li><a target="_blank" rel="noopener" href="https://www.allthingsdistributed.com/2008/12/eventually_consistent.html">Eventually Consistent</a> ，AWS CTO 维尔纳·沃格尔斯（Werner Vogels）发布在自己 Blog 上的一篇关于最终一致性的好文。</li>
<li><a target="_blank" rel="noopener" href="https://blog.rackspace.com/writing-code-that-scales">Writing Code that Scales</a> ，Rackspace 的一篇很不错的博文，告诉我们一些很不错的写出高扩展和高性能代码的工程原则。</li>
<li><a target="_blank" rel="noopener" href="https://architecht.io/lessons-from-facebook-on-engineering-for-scale-f5716f0afc7a">Automate and Abstract: Lessons from Facebook on Engineering for Scale</a> ，软件自动化和软件抽象，这是软件工程中最重要的两件事了。通过这篇文章，我们可以看到 Facebook 的关于这方面的一些经验教训。</li>
</ul>
<h1 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h1><p>有了方法论后，你还需要学习一些比较细节的落地的技术。最好的方式就是学习被前人总结出来的设计模式，虽然设计模式也要分场景，但是设计模式可以让你知道一些套路，这些套路对于我们设计的分布式系统有非常大的帮助，不但可以让我们少走一些弯路，而且还能让我们更为系统和健壮地设计我们的架构。</p>
<p>下面是一些分布式架构设计模式的网站。</p>
<p>首先，需要重点推荐的是微软云平台 Azure 上的设计模式。 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/patterns/">Cloud Design Patterns</a> ，这个网站上罗列了分布式设计的各种设计模式，可以说是非常全面和完整。对于每一个模式都有详细的说明，并有对其优缺点的讨论，以及适用场景和不适用场景的说明，实在是一个非常不错的学习分布式设计模式的地方。其中有如下分类。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/patterns/category/availability">设计模式：可用性</a>；</li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/patterns/category/data-management">设计模式：数据管理</a>；</li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/patterns/category/design-implementation">设计模式：设计和实现</a>；</li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/patterns/category/messaging">设计模式：消息</a>；</li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/patterns/category/management-monitoring">设计模式：管理和监控</a>；</li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/patterns/category/performance-scalability">设计模式：性能和扩展</a>；</li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/patterns/category/resiliency">设计模式：系统弹力</a>；</li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/architecture/patterns/category/security">设计模式：安全</a>。</li>
</ul>
<p>除此之外，还有其它的一些关于分布式系统设计模式的网站和相关资料。</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://en.clouddesignpattern.org/index.php/Main_Page">AWS Cloud Pattern</a> ，这里收集了 AWS 云平台的一些设计模式。</li>
<li><a target="_blank" rel="noopener" href="https://research.google.com/pubs/archive/45406.pdf">Design patterns for container-based distributed systems</a> ，这是 Google 给的一篇论文，其中描述了容器化下的分布式架构的设计模式。</li>
<li><a target="_blank" rel="noopener" href="https://www.slideshare.net/pagsousa/patterns-fro-distributed-systems">Patterns for distributed systems</a> ，这是一个 PPT，其中讲了一些分布式系统的架构模式，你可以顺着到 Google 里去搜索。</li>
</ul>
<p>我个人觉得微服务也好，SOA 也好，都是分布式系统的一部分，这里有两个网站罗列了各种各样的服务架构模式。</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://microservices.io/patterns/index.html">A Pattern Language for Micro-Services</a> ；</li>
<li><a target="_blank" rel="noopener" href="http://soapatterns.org/">SOA Patterns</a>。</li>
</ul>
<p>当然，还有我在极客时间上写的那些分布式的设计模式的总结。</p>
<ul>
<li><strong>弹力设计篇</strong>，内容包括：认识故障和弹力设计、隔离设计、异步通讯设计、幂等性设计、服务的状态、补偿事务、重试设计、熔断设计、限流设计、降级设计、弹力设计总结。</li>
<li><strong>管理设计篇</strong>，内容包括：分布式锁、配置中心、边车模式、服务网格、网关模式、部署升级策略等。</li>
<li><strong>性能设计篇</strong>，内容包括：缓存、异步处理、数据库扩展、秒杀、边缘计算等。</li>
</ul>
<h1 id="设计与工程实践"><a href="#设计与工程实践" class="headerlink" title="设计与工程实践"></a>设计与工程实践</h1><h2 id="分布式系统的故障测试"><a href="#分布式系统的故障测试" class="headerlink" title="分布式系统的故障测试"></a>分布式系统的故障测试</h2><ul>
<li><a target="_blank" rel="noopener" href="https://medium.com/netflix-techblog/fit-failure-injection-testing-35d8e2a9bb2">FIT: Failure Injection Testing</a> ，Netflix 公司的一篇关于做故障注入测试的文章。</li>
<li><a target="_blank" rel="noopener" href="https://medium.com/netflix-techblog/automated-failure-testing-86c1b8bc841f">Automated Failure Testing</a> ，同样来自 Netflix 公司的自动化故障测试的一篇博文。</li>
<li><a target="_blank" rel="noopener" href="https://people.ucsc.edu/~palvaro/socc16.pdf">Automating Failure Testing Research at Internet Scale</a> ，Netflix 公司伙同圣克鲁斯加利福尼亚大学和 Gremlin 游戏公司一同撰写的一篇论文。</li>
</ul>
<h2 id="弹性伸缩"><a href="#弹性伸缩" class="headerlink" title="弹性伸缩"></a>弹性伸缩</h2><ul>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2014/5/12/4-architecture-issues-when-scaling-web-applications-bottlene.html">4 Architecture Issues When Scaling Web Applications: Bottlenecks, Database, CPU, IO</a> ，本文讲解了后端程序的主要性能指标，即响应时间和可伸缩性这两者如何能提高的解决方案，讨论了包括纵向和横向扩展，可伸缩架构、负载均衡、数据库的伸缩、CPU 密集型和 I&#x2F;O 密集型程序的考量等。</li>
<li><a target="_blank" rel="noopener" href="http://ithare.com/scaling-stateful-objects/">Scaling Stateful Objects</a> ，这是一本叫《Development&amp;Deployment of Multiplayer Online Games》书中一章内容的节选，讨论了有状态和无状态的节点如何伸缩的问题。虽然还没有写完，但是可以给你一些很不错的基本概念和想法。</li>
<li><a target="_blank" rel="noopener" href="https://blog.codinghorror.com/scaling-up-vs-scaling-out-hidden-costs/">Scale Up vs Scale Out: Hidden Costs</a> ，Coding Horror 上的一篇有趣的文章，详细分析了可伸缩性架构的不同扩展方案（横向扩展或纵向扩展）所带来的成本差异，帮助你更好地选择合理的扩展方案，可以看看。</li>
<li><a target="_blank" rel="noopener" href="https://blog.openshift.com/best-practices-for-horizontal-application-scaling/">Best Practices for Scaling Out</a> ，OpenShift 的一篇讨论 Scale out 最佳实践的文章。</li>
<li><a target="_blank" rel="noopener" href="https://www.infoq.com/articles/scalability-worst-practices">Scalability Worst Practices</a> ，这篇文章讨论了一些最差实践，你需要小心避免。</li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2013/8/26/reddit-lessons-learned-from-mistakes-made-scaling-to-1-billi.html">Reddit: Lessons Learned From Mistakes Made Scaling To 1 Billion Pageviews A Month</a> ，Reddit 分享的一些关于系统扩展的经验教训。</li>
<li>下面是几篇关于自动化弹性伸缩的文章。<ul>
<li><a target="_blank" rel="noopener" href="https://medium.com/@Pinterest_Engineering/auto-scaling-pinterest-df1d2beb4d64">Autoscaling Pinterest</a>；</li>
<li><a target="_blank" rel="noopener" href="https://medium.com/square-corner-blog/autoscaling-based-on-request-queuing-c4c0f57f860f">Square: Autoscaling Based on Request Queuing</a>；</li>
<li><a target="_blank" rel="noopener" href="https://www.paypal-engineering.com/2017/08/16/autoscaling-applications-paypal/">PayPal: Autoscaling Applications</a>；</li>
<li><a target="_blank" rel="noopener" href="http://tech.trivago.com/2017/02/17/your-definite-guide-for-autoscaling-jenkins/">Trivago: Your Definite Guide For Autoscaling Jenkins</a>；</li>
<li><a target="_blank" rel="noopener" href="https://medium.com/netflix-techblog/scryer-netflixs-predictive-auto-scaling-engine-a3f8fc922270">Scryer: Netflix’s Predictive Auto Scaling Engine</a>。</li>
</ul>
</li>
</ul>
<h2 id="一致性哈希"><a href="#一致性哈希" class="headerlink" title="一致性哈希"></a>一致性哈希</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.tom-e-white.com/2007/11/consistent-hashing.html">Consistent Hashing</a> ，这是一个一致性哈希的简单教程，其中还有代码示例。</li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@dgryski/consistent-hashing-algorithmic-tradeoffs-ef6b8e2fcae8">Consistent Hashing: Algorithmic Tradeoffs</a> ，这篇文章讲述了一致性哈希的一些缺陷和坑，以及各种哈希算法的性能比较，最后还给了一组代码仓库，其中有各种哈希算法的实现。</li>
<li><a target="_blank" rel="noopener" href="https://medium.com/netflix-techblog/distributing-content-to-open-connect-3e3e391d4dc9">Distributing Content to Open Connect</a> ，Netflix 的一个对一致性哈希的实践，提出了 Uniform Consistent Hashing，是挺有意思的一篇文章。</li>
<li><a target="_blank" rel="noopener" href="https://blog.imaginea.com/consistent-hashing-in-cassandra/">Consistent Hashing in Cassandra</a> ，这是 Cassandra 中使用到的一致性哈希的相关设计。</li>
</ul>
<h2 id="数据库分布式"><a href="#数据库分布式" class="headerlink" title="数据库分布式"></a>数据库分布式</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://queue.acm.org/detail.cfm?id=3025012">Life Beyond Distributed Transactions</a> ，该文是 Salesforce 的软件架构师帕特·赫兰德（Pat Helland）于 2016 年 12 月发表的针对其在 2007 年 CIDR（创新数据库研究会议）上首次发表的同名文章的更新和缩写版本。业界谈到分布式事务通常指两段提交 2PC 事务（Spring&#x2F;JEE 中 JTA 等) 或者 Paxos 与 Raft，这些事务都有明显缺点和局限性。</p>
<p>而赫兰德在本文讨论的是另外一种基于本地事务情况下的事务机制，它是基于实体和活动（Activity）的概念，其实类似 DDD 聚合根和领域事件的概念，这种工作流类型事务虽然需要程序员介入，依靠消息系统实现，但可以实现接近无限扩展的大型系统。赫兰德文中提出了重要的观点：“如果你不能使用分布式事务，那么你就只能使用工作流。”</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://medium.com/@jeeyoungk/how-sharding-works-b4dec46b3f6">How Sharding Works</a> ，这是一篇很不错的探讨数据 Sharding 的文章。基本上来说，数据 Sharding 可能的问题都在这篇文章里谈到了。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.percona.com/blog/2009/08/06/why-you-dont-want-to-shard/">Why you don’t want to shard</a> ，这是 Percona 的一篇文章，其中表达了，不到万不得已不要做数据库分片。是的，最好还是先按业务来拆分，先把做成微服务的架构，然后把数据集变简单，然后再做 Sharding 会更好。</p>
</li>
<li><p>[How to Scale Big Data Applications](<a target="_blank" rel="noopener" href="https://www.percona.com/sites/default/files/presentations/How">https://www.percona.com/sites/default/files/presentations/How</a> to Scale Big Data Applications.pdf) ，这也是 Percona 给出的一篇关于怎样给大数据应用做架构扩展的文章。值得一读。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.percona.com/blog/2016/08/30/mysql-sharding-with-proxysql/">MySQL Sharding with ProxySQL</a> ，用 ProxySQL 来支撑 MySQL 数据分片的一篇实践文章。</p>
</li>
</ul>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><ul>
<li><a target="_blank" rel="noopener" href="https://coolshell.cn/articles/17416.html">缓存更新的套路</a>，这是我在 CoolShell 上写的缓存更新的几个设计模式，包括 Cache Aside、Read&#x2F;Write Through、Write Behind Caching。</li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2016/1/25/design-of-a-modern-cache.html">Design Of A Modern Cache</a> ，设计一个现代化的缓存系统需要注意到的东西。</li>
<li><a target="_blank" rel="noopener" href="https://medium.com/netflix-techblog/caching-for-a-global-netflix-7bcc457012f1">Netflix: Caching for a Global Netflix</a> ，Netflix 公司的全局缓存架构实践。</li>
<li><a target="_blank" rel="noopener" href="https://code.facebook.com/posts/220956754772273/an-analysis-of-facebook-photo-caching/">Facebook: An analysis of Facebook photo caching</a> ，Facebook 公司的图片缓存使用分析，这篇文章挺有意思的，用数据来调优不同的缓存大小和算法。</li>
<li><a target="_blank" rel="noopener" href="https://tech.trivago.com/2017/12/19/how-trivago-reduced-memcached-memory-usage-by-50/">How trivago Reduced Memcached Memory Usage by 50%</a> ，Trivago 公司一篇分享自己是如何把 Memcached 的内存使用率降了一半的实践性文章。很有意思，可以让你学到很多东西。</li>
<li><a target="_blank" rel="noopener" href="https://engineeringblog.yelp.com/2018/03/caching-internal-service-calls-at-yelp.html">Caching Internal Service Calls at Yelp</a> ，Yelp 公司的缓存系统架构。</li>
</ul>
<h2 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h2><ul>
<li><a target="_blank" rel="noopener" href="https://content.pivotal.io/blog/understanding-when-to-use-rabbitmq-or-apache-kafka">Understanding When to use RabbitMQ or Apache Kafka</a> ，什么时候使用 RabbitMQ，什么时候使用 Kafka，通过这篇文章可以让你明白如何做技术决策。</li>
<li><a target="_blank" rel="noopener" href="https://tech.trello.com/why-we-chose-kafka/">Trello: Why We Chose Kafka For The Trello Socket Architecture</a> ，Trello 的 Kafka 架构分享。</li>
<li><a target="_blank" rel="noopener" href="https://engineering.linkedin.com/kafka/running-kafka-scale">LinkedIn: Running Kafka At Scale</a> ，LinkedIn 公司的 Kafka 架构扩展实践。</li>
<li><a target="_blank" rel="noopener" href="https://www.confluent.io/blog/put-several-event-types-kafka-topic/">Should You Put Several Event Types in the Same Kafka Topic?</a> ，这个问题可能经常困扰你，这篇文章可以为你找到答案。</li>
<li><a target="_blank" rel="noopener" href="https://engineeringblog.yelp.com/2016/07/billions-of-messages-a-day-yelps-real-time-data-pipeline.html">Billions of Messages a Day - Yelp’s Real-time Data Pipeline</a> ，Yelp 公司每天十亿级实时消息的架构。</li>
<li><a target="_blank" rel="noopener" href="https://eng.uber.com/reliable-reprocessing/">Uber: Building Reliable Reprocessing and Dead Letter Queues with Kafka</a> ，Uber 公司的 Kafka 应用。</li>
<li><a target="_blank" rel="noopener" href="https://eng.uber.com/chaperone/">Uber: Introducing Chaperone: How Uber Engineering Audits Kafka End-to-End</a> ，Uber 公司对 Kafka 消息的端到端审计。</li>
<li><a target="_blank" rel="noopener" href="https://open.nytimes.com/publishing-with-apache-kafka-at-the-new-york-times-7f0e3b7d2077">Publishing with Apache Kafka at The New York Times</a> ，纽约时报的 Kafka 工程实践。</li>
<li><a target="_blank" rel="noopener" href="https://blog.heroku.com/kafka-streams-on-heroku">Kafka Streams on Heroku</a> ，Heroku 公司的 Kafka Streams 实践。</li>
<li><a target="_blank" rel="noopener" href="https://engineering.salesforce.com/how-apache-kafka-inspired-our-platform-events-architecture-2f351fe4cf63">Salesforce: How Apache Kafka Inspired Our Platform Events Architecture</a> ，Salesforce 的 Kafka 工程实践。</li>
<li><a target="_blank" rel="noopener" href="https://www.confluent.io/blog/exactly-once-semantics-are-possible-heres-how-apache-kafka-does-it/">Exactly-once Semantics are Possible: Here’s How Kafka Does it</a> ，怎样用 Kafka 让只发送一次的语义变为可能。这是业界中一个很难的工程问题。</li>
<li><a target="_blank" rel="noopener" href="https://segment.com/blog/exactly-once-delivery/">Delivering billions of messages exactly once</a> 同上，这也是一篇挑战消息只发送一次这个技术难题的文章。</li>
<li><a target="_blank" rel="noopener" href="https://yahooeng.tumblr.com/post/135321837876/benchmarking-streaming-computation-engines-at">Benchmarking Streaming Computation Engines at Yahoo!</a>。Yahoo! 的 Storm 团队在为他们的流式计算做技术选型时，发现市面上缺乏针对不同计算平台的性能基准测试。于是，他们研究并设计了一种方案来做基准测试，测试了 Apache Flink、Apache Storm 和 Apache Spark 这三种平台。文中给出了结论和具体的测试方案。（如果原文链接不可用，请尝试搜索引擎对该网页的快照。）</li>
</ul>
<h2 id="关于日志方面"><a href="#关于日志方面" class="headerlink" title="关于日志方面"></a>关于日志方面</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.confluent.io/blog/using-logs-to-build-a-solid-data-infrastructure-or-why-dual-writes-are-a-bad-idea/">Using Logs to Build a Solid Data Infrastructure - Martin Kleppmann</a> ，设计基于 log 结构应用架构的一篇不错的文章。</li>
<li><a target="_blank" rel="noopener" href="https://blog.twitter.com/engineering/en_us/topics/infrastructure/2015/building-distributedlog-twitter-s-high-performance-replicated-log-servic.html">Building DistributedLog: High-performance replicated log service</a> ，Distributed 是 Twitter 2016 年 5 月份开源的一个分布式日志系统。在 Twitter 内部已经使用 2 年多。其主页在 <a target="_blank" rel="noopener" href="http://distributedlog.io/">distributedlog.io</a>。这篇文章讲述了这个高性能日志系统的一些技术细节。另外，其技术负责人是个中国人，其在微信公众号中也分享过这个系统 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&mid=403051208&idx=1&sn=1694ac05acbcb5ca53c88bfac8a68856&scene=2&srcid=1224xZuQ9QQ4sRmiPVdHTppL">Twitter 高性能分布式日志系统架构解析</a>。</li>
<li><a target="_blank" rel="noopener" href="https://code.facebook.com/posts/357056558062811/logdevice-a-distributed-data-store-for-logs/">LogDevice: a distributed data store for logs</a> ，Facebook 分布式日志系统方面的一些工程分享。</li>
</ul>
<h2 id="关于性能方面"><a href="#关于性能方面" class="headerlink" title="关于性能方面"></a>关于性能方面</h2><ul>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/latency-everywhere-and-it-costs-you-sales-how-crush-it">Understand Latency</a> ，这篇文章收集并整理了一些和系统响应时间相关的文章，可以让你全面了解和 Latency 有关的系统架构和设计经验方面的知识。</li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2012/5/16/big-list-of-20-common-bottlenecks.html">Common Bottlenecks</a> ，文中讲述了 20 个常见的系统瓶颈。</li>
<li><a target="_blank" rel="noopener" href="https://blog.codinghorror.com/performance-is-a-feature/">Performance is a Feature</a> ，Coding Horror 上的一篇让你关注性能的文章。</li>
<li><a target="_blank" rel="noopener" href="https://codeascraft.com/2014/12/11/make-performance-part-of-your-workflow/">Make Performance Part of Your Workflow</a> ，这篇文章是图书《<a target="_blank" rel="noopener" href="http://shop.oreilly.com/product/0636920033578.do">Designing for Performance</a>》中的节选（国内没有卖的），其中给出来了一些和性能有关的设计上的平衡和美学。</li>
<li><a target="_blank" rel="noopener" href="https://blog.cloudflare.com/counting-things-a-lot-of-different-things/">CloudFlare: How we built rate limiting capable of scaling to millions of domains</a>，讲述了 CloudFlare 公司是怎样实现他们的限流功能的。从最简单的每客户 IP 限流开始分析，进一步讲到 anycast，在这种情况下 PoP 的分布式限流是怎样实现的，并详细解释了具体的算法。</li>
</ul>
<h2 id="关于搜索方面"><a href="#关于搜索方面" class="headerlink" title="关于搜索方面"></a>关于搜索方面</h2><ul>
<li><a target="_blank" rel="noopener" href="https://instagram-engineering.com/search-architecture-eeb34a936d3a">Instagram: Search Architecture</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cs.otago.ac.nz/homepages/andrew/papers/2017-8.pdf">eBay: The Architecture of eBay Search</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ebayinc.com/stories/blogs/tech/making-e-commerce-search-faster/">eBay: Improving Search Engine Efficiency by over 25%</a></li>
<li><a target="_blank" rel="noopener" href="https://engineering.linkedin.com/search/did-you-mean-galene">LinkedIn: Introducing LinkedIn’s new search architecture</a></li>
<li><a target="_blank" rel="noopener" href="https://engineering.linkedin.com/blog/2018/03/search-federation-architecture-at-linkedin">LinkedIn: Search Federation Architecture at LinkedIn</a></li>
<li><a target="_blank" rel="noopener" href="https://slack.engineering/search-at-slack-431f8c80619e">Slack: Search at Slack</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.doordash.com/powering-search-recommendations-at-doordash-8310c5cfd88c">DoorDash: Search and Recommendations at DoorDash</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.twitter.com/engineering/en_us/a/2014/building-a-complete-tweet-index.html">Twitter: Search Service at Twitter (2014)</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@Pinterest_Engineering/manas-a-high-performing-customized-search-system-cf189f6ca40f">Pinterest: Manas: High Performing Customized Search System</a></li>
<li><a target="_blank" rel="noopener" href="https://tech.flipkart.com/sherlock-near-real-time-search-indexing-95519783859d">Sherlock: Near Real Time Search Indexing at Flipkart</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/airbnb-engineering/nebula-as-a-storage-platform-to-build-airbnbs-search-backends-ecc577b05f06">Airbnb: Nebula: Storage Platform to Build Search Backends</a></li>
</ul>
<h2 id="各公司的架构实践"><a href="#各公司的架构实践" class="headerlink" title="各公司的架构实践"></a>各公司的架构实践</h2><p><a target="_blank" rel="noopener" href="http://highscalability.com/">High Scalability</a> ，这个网站会定期分享一些大规模系统架构是怎样构建的，下面是迄今为止各个公司的架构说明。</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/youtube-architecture">YouTube Architecture</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2013/4/15/scaling-pinterest-from-0-to-10s-of-billions-of-page-views-a.html">Scaling Pinterest</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/google-architecture">Google Architecture</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/scaling-twitter-making-twitter-10000-percent-faster">Scaling Twitter</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2014/2/26/the-whatsapp-architecture-facebook-bought-for-19-billion.html">The WhatsApp Architecture</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/flickr-architecture">Flickr Architecture</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/amazon-architecture">Amazon Architecture</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2009/8/5/stack-overflow-architecture.html">Stack Overflow Architecture</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2012/5/21/pinterest-architecture-update-18-million-visitors-10x-growth.html">Pinterest Architecture</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2012/2/13/tumblr-architecture-15-billion-page-views-a-month-and-harder.html">Tumblr Architecture</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2011/12/6/instagram-architecture-14-million-users-terabytes-of-photos.html">Instagram Architecture</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2011/6/27/tripadvisor-architecture-40m-visitors-200m-dynamic-page-view.html">TripAdvisor Architecture</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2013/6/18/scaling-mailbox-from-0-to-one-million-users-in-6-weeks-and-1.html">Scaling Mailbox</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2013/9/23/salesforce-architecture-how-they-handle-13-billion-transacti.html">Salesforce Architecture</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2013/11/4/espns-architecture-at-scale-operating-at-100000-duh-nuh-nuhs.html">ESPN Architecture</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2015/9/14/how-uber-scales-their-real-time-market-platform.html">Uber Architecture</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=PE4gwstWhmc">DropBox Design</a></li>
<li><a target="_blank" rel="noopener" href="http://www.splunk.com/view/SP-CAAABF9">Splunk Architecture</a></li>
</ul>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>今天我们分享的内容是高手成长篇分布式架构部分的最后一篇——分布式架构工程设计，讲述了设计原则、设计模式等方面的内容，尤其整理和推荐了国内外知名企业的设计思路和工程实践，十分具有借鉴意义。</p>
<p>下篇文章中，我们将分享微服务架构方面的内容。敬请期待。</p>
<iframe width="100%"  frameborder=1 height=500px src="https://time.geekbang.org/comment/nice/11232" > </iframe></article><div class="tag_share"><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">设计模式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5"><span class="toc-number">2.</span> <span class="toc-text">设计与工程实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%95%85%E9%9A%9C%E6%B5%8B%E8%AF%95"><span class="toc-number">2.1.</span> <span class="toc-text">分布式系统的故障测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9"><span class="toc-number">2.2.</span> <span class="toc-text">弹性伸缩</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C"><span class="toc-number">2.3.</span> <span class="toc-text">一致性哈希</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%B8%83%E5%BC%8F"><span class="toc-number">2.4.</span> <span class="toc-text">数据库分布式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-number">2.5.</span> <span class="toc-text">缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">2.6.</span> <span class="toc-text">消息队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E6%97%A5%E5%BF%97%E6%96%B9%E9%9D%A2"><span class="toc-number">2.7.</span> <span class="toc-text">关于日志方面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E6%80%A7%E8%83%BD%E6%96%B9%E9%9D%A2"><span class="toc-number">2.8.</span> <span class="toc-text">关于性能方面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E6%90%9C%E7%B4%A2%E6%96%B9%E9%9D%A2"><span class="toc-number">2.9.</span> <span class="toc-text">关于搜索方面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%84%E5%85%AC%E5%8F%B8%E7%9A%84%E6%9E%B6%E6%9E%84%E5%AE%9E%E8%B7%B5"><span class="toc-number">2.10.</span> <span class="toc-text">各公司的架构实践</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">小结</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By 码农张三</div></div><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/9.4.0/mermaid.min.js"></script></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div></div></body></html>