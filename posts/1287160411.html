<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>21｜ 实战项目（四）：用ControlNet给你的创意上色 | geekbang</title><meta name="author" content="码农张三"><meta name="copyright" content="码农张三"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="21｜ 实战项目（四）：用ControlNet给你的创意上色你好，我是南柯。 上一讲我们已经学习了ControlNet的算法原理，也了解了它在AI绘画中强大的控制能力。今天我们一起来完成ControlNet的实战任务。 在这一讲中，我们将通过写代码的方式使用ControlNet，一起完成后面这三个任务。  认识官方已经发布的ControlNet模型以及社区传播的第三方ControlNet模型。 实">
<meta property="og:type" content="article">
<meta property="og:title" content="21｜ 实战项目（四）：用ControlNet给你的创意上色">
<meta property="og:url" content="https://zhuansun.github.io/geekbang/posts/1287160411.html">
<meta property="og:site_name" content="geekbang">
<meta property="og:description" content="21｜ 实战项目（四）：用ControlNet给你的创意上色你好，我是南柯。 上一讲我们已经学习了ControlNet的算法原理，也了解了它在AI绘画中强大的控制能力。今天我们一起来完成ControlNet的实战任务。 在这一讲中，我们将通过写代码的方式使用ControlNet，一起完成后面这三个任务。  认识官方已经发布的ControlNet模型以及社区传播的第三方ControlNet模型。 实">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg">
<meta property="article:published_time" content="2024-02-29T12:01:07.000Z">
<meta property="article:modified_time" content="2024-03-21T11:14:53.299Z">
<meta property="article:author" content="码农张三">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhuansun.github.io/geekbang/posts/1287160411"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '21｜ 实战项目（四）：用ControlNet给你的创意上色',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-21 11:14:53'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="geekbang" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://pic.imgdb.cn/item/653470a0c458853aef5813f1.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">1342</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">23</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">geekbang</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">21｜ 实战项目（四）：用ControlNet给你的创意上色</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2024-02-29T12:01:07.000Z" title="发表于 2024-02-29 12:01:07">2024-02-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AI%E7%BB%98%E7%94%BB%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E6%88%98/">AI绘画核心技术与实战</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="21｜-实战项目（四）：用ControlNet给你的创意上色"><a href="#21｜-实战项目（四）：用ControlNet给你的创意上色" class="headerlink" title="21｜ 实战项目（四）：用ControlNet给你的创意上色"></a>21｜ 实战项目（四）：用ControlNet给你的创意上色</h1><p>你好，我是南柯。</p>
<p>上一讲我们已经学习了ControlNet的算法原理，也了解了它在AI绘画中强大的控制能力。今天我们一起来完成ControlNet的实战任务。</p>
<p>在这一讲中，我们将通过写代码的方式使用ControlNet，一起完成后面这三个任务。</p>
<ol>
<li>认识官方已经发布的ControlNet模型以及社区传播的第三方ControlNet模型。</li>
<li>实现ControlNet论文中的控图生成任务，掌握ControlNet的基础能力。</li>
<li>探索ControlNet的趣味生成功能，包括图像风格化、二维码生成、创意文字和线稿上色。</li>
</ol>
<p>掌握了这些技巧，你也一定能够发挥创意，做出很多结构鲜明的作品。让我们开始吧！</p>
<h2 id="模型获取"><a href="#模型获取" class="headerlink" title="模型获取"></a>模型获取</h2><p>在Hugging Face上，我们不光可以获取到海量AI绘画基础模型，还能找到各种开发者训练的ControlNet模型。正式使用之前，我们先来认识下这些模型。</p>
<h3 id="官方发布的模型"><a href="#官方发布的模型" class="headerlink" title="官方发布的模型"></a>官方发布的模型</h3><p>首先是ControlNet论文作者在ControlNet1.0和1.1中发布的22个模型。</p>
<p>ControlNet1.0的8个模型可以通过后面这个 <a target="_blank" rel="noopener" href="https://huggingface.co/lllyasviel/ControlNet/tree/main/models">Hugging Face链接</a> 获取。我们可以看到ControlNet1.0各个模型的命名规则，以第一行的 “control_sd15_canny.pth” 为例，sd15表示用于训练这个ControlNet的基础模型是SD1.5，Canny便是ControlNet的控制条件是Canny算子，也就是提取原始图像的边缘。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/cfa0d623669b2be89042a3670af7b4b9.png"></p>
<p>关于前面图中的八个控制条件，我们依次认识下。</p>
<p>首先来看Canny条件，它使用图像处理的Canny算子来提取图像的边缘信息，可以用于通用物体的可控生成。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/f695f4ab223998bccd6b338093a10145.png"></p>
<p>接下来是HED条件。如果说前面提到的Canny算子是一种经典的、“上古的”边缘检测算法，HED则是一种基于深度学习方案的“现代化”边缘检测算法。HED条件可以看成Canny条件的升级版，适用于更复杂场景的精细化边缘提取。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/be0be2015594b8d94cb5e05ba8c59a4a.png"></p>
<p>下一个是MLSD条件，它使用 <a target="_blank" rel="noopener" href="https://github.com/navervision/mlsd">M-LSD算法</a> 提取图像的直线轮廓，可以用于各种建筑图像和室内装饰场景的可控生成。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/7b069fb72bee97ba2456a93217043eec.png"></p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/11282cb86fa4c42196287382eeea93a7.png"></p>
<p>接下来要说的是Scribble条件，能根据我们的随手涂鸦生成图像。这也是我个人最喜欢的控制条件，简单几笔就能生成出丰富的细节。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/b86a4d892dc420074129dbb059c3a9e4.png"></p>
<p>下一个是Normal条件，Normal代表图像的法线，也就是与图像中物体表面切平面垂直的向量，通常用红、绿、蓝三个通道来表示法线向量在X、Y和Z方向的分量。从后面这个例子可以看出，Normal条件能够帮我们从2D图像中推断出3D几何信息，用于ControlNet的图像生成任务上。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/8e3f03e5f9c313cfa2f7b6df0360ea92.png"></p>
<p>接着是Depth条件。图像的Depth指的是图像的深度信息，可以理解为图像中每个像素距离我们的远近。和Normal条件一样，Depth条件也是包含3D信息的控制条件。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/b98b51ee119f827b81b86cc27a65aff3.png"></p>
<p>接下来是OpenPose条件，它的思路是使用人体关键点算法提取肢体关键点，使用关键点的连线图作为控制条件。OpenPose条件经常用在通过ControlNet做换装的任务上。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/0b528cbaea8358177a48fa21f3b1b411.png"></p>
<p>最后一个模型是Seg条件，作用是使用图像分割算法对原图进行分割处理，将分割的结果用作控制条件。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/2f5602988db6392220cf160fbc4a4ffb.png"></p>
<p>说完了ControlNet1.0的8个模型，我们再来看看ControlNet1.1的14个模型。这些模型可以通过后面的 <a target="_blank" rel="noopener" href="https://huggingface.co/lllyasviel/ControlNet-v1-1/tree/main">Hugging Face链接</a> 获取。除了1.0中的8个控制条件，1.1中新增了指令级修图、Tile功能等能力，这些知识我们在上一讲中已经学过了。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/d3feafd1abfcb39f4894fa3942020891.png"></p>
<p>ControlNet 1.1模型的命名做出了规范，避免和1.0版产生混淆。</p>
<p>具体来说，可以看后面这张图，模型名称中的四个部分分别代表项目名、模型版本号、基础模型、控制方式。在模型版本号部分，你需要关注质量标签部分p、e、u三个字母的不同含义。p表示正式版（product-ready），e表示测试版（experimental），u表示未完成版（unfinished）。有时候我们还会看到f这个质量标签，它表示修复版（fixed）。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/4640c0a57df533a9aa0b0da801447e26.png"></p>
<p>值得一提的是，随着SDXL的大火，有很多 <a target="_blank" rel="noopener" href="https://huggingface.co/diffusers/controlnet-canny-sdxl-1.0">针对SDXL训练的ControlNet模型</a> 也逐渐流行。稍后的代码实战中，我们就会用到基于SDXL的ControlNet模型。</p>
<h3 id="有趣的第三方模型"><a href="#有趣的第三方模型" class="headerlink" title="有趣的第三方模型"></a>有趣的第三方模型</h3><p>除了上面的官方模型，开源社区中也涌现了很多有意思的模型。</p>
<p>Civitai社区中的 <a target="_blank" rel="noopener" href="https://github.com/lllyasviel/ControlNet-v1-1-nightly">QR Code Monster</a> 模型可以用于生成创意二维码。具体来说，我们使用Canny或者HED等边缘检测算法提取原始二维码的边缘，用作ControlNet的控制条件，然后写一个prompt进行创意二维码的生成。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/8ed66f3365cf642f3c9dc790966e74fe.png"></p>
<p>Hugging Face中实现类似二维码功能的模型还有很多，比如我们稍后实战用的 <a target="_blank" rel="noopener" href="https://huggingface.co/Nacholmo/controlnet-qr-pattern-v2">qr-pattern-v2</a> 模型，可以先感受下它的二维码效果。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/b1537b7f413276d21296740dae24yyyy.jpg"></p>
<p>另一个要推荐的ControlNet模型专门用于 <a target="_blank" rel="noopener" href="https://huggingface.co/CrucibleAI/ControlNetMediaPipeFace">控制表情生成</a>。通过提取人脸的关键点信息，并把这些信息用作控制条件，配合prompt就可以生成各种有意思的效果。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/8613297be90f76c43ed1ded4f34db10d.png"></p>
<p>你可以点开 <a target="_blank" rel="noopener" href="https://huggingface.co/models?p=1&sort=downloads&search=controlnet">这个链接</a>，获取更多开源社区的ControlNet模型。</p>
<h2 id="经典技能"><a href="#经典技能" class="headerlink" title="经典技能"></a>经典技能</h2><p>了解了如何获取模型，现在我们可以使用这些模型完成AI绘画任务了。你可以点开我的 <a target="_blank" rel="noopener" href="https://colab.research.google.com/github/NightWalker888/ai_painting_journey/blob/main/lesson21/ControlNet%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8.ipynb">Colab链接</a>，和我一起感受ControlNet的各种趣味技能。</p>
<p>我们使用蒙娜丽莎作为输入图片，使用ControlNet的Canny控制条件进行AI绘画。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 导入需要使用的库</span>
<span class="token keyword">import</span> cv2              <span class="token comment"># OpenCV库，用于图像处理</span>
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image   <span class="token comment"># PIL库中的Image模块，用于图像读取和处理</span>
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np      <span class="token comment"># NumPy库，用于数组和矩阵等的运算</span>
<span class="token keyword">from</span> diffusers <span class="token keyword">import</span> StableDiffusionControlNetPipeline
<span class="token keyword">from</span> diffusers<span class="token punctuation">.</span>utils <span class="token keyword">import</span> load_image

<span class="token comment"># 使用蒙娜丽莎的图片用作原始图片提取Canny轮廓。你也可以替换为你自己的图片链接；或者上传本地图片到Colab。</span>
image <span class="token operator">=</span> load_image<span class="token punctuation">(</span>
    <span class="token string">"https://ice.frostsky.com/2023/08/26/2c809fbfcb030dd8a97af3759f37ee29.png"</span>
<span class="token punctuation">)</span>

<span class="token comment"># 转化图像为NumPy类型的数组（矩阵），方便后续操作</span>
image <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>image<span class="token punctuation">)</span>

<span class="token comment"># 设置Canny边缘检测算法的低阈值和高阈值</span>
low_threshold <span class="token operator">=</span> <span class="token number">100</span>
high_threshold <span class="token operator">=</span> <span class="token number">200</span>

<span class="token comment"># 使用Canny算法进行边缘检测。图像中灰度超过阈值的点，OpenCV会标记为边缘点</span>
image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>Canny<span class="token punctuation">(</span>image<span class="token punctuation">,</span> low_threshold<span class="token punctuation">,</span> high_threshold<span class="token punctuation">)</span>

<span class="token comment"># 因为Canny边缘检测后的输出是二维的，所以在第三维增加一个维度，以便转化为RGB图像</span>
image <span class="token operator">=</span> image<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>

<span class="token comment"># 将单通道图像复制三次，生成三通道(RGB)图像</span>
image <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">,</span> image<span class="token punctuation">,</span> image<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment"># 使用PIL库中的Image模块, 将NumPy的array类型转化为Image类型，方便后续图像保存与显示等操作</span>
Canny_image <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/db9df5ce9770f5b65bef4afa22baa2fe.jpg"></p>
<p>然后依次加载SDXL模型和Canny控制条件对应的ControlNet模型。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">controlnet <span class="token operator">=</span> ControlNetModel<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>
    <span class="token string">"diffusers/controlnet-Canny-sdxl-1.0-small"</span><span class="token punctuation">,</span>
    torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16
<span class="token punctuation">)</span>
vae <span class="token operator">=</span> AutoencoderKL<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span><span class="token string">"madebyollin/sdxl-vae-fp16-fix"</span><span class="token punctuation">,</span> torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16<span class="token punctuation">)</span>
pipe <span class="token operator">=</span> StableDiffusionXLControlNetPipeline<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>
    <span class="token string">"stabilityai/stable-diffusion-xl-base-1.0"</span><span class="token punctuation">,</span>
    controlnet<span class="token operator">=</span>controlnet<span class="token punctuation">,</span>
    vae<span class="token operator">=</span>vae<span class="token punctuation">,</span>
    torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>之后，我们就可以使用蒙娜丽莎的Canny边缘轮廓，通过prompt引导模型生成不同的人像效果。你可以修改代码中的prompt描述，生成更多趣味效果。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 可以替换你的prompt</span>
prompt <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"a photo of a girl, best quality, super photorealistic"</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">2</span>
generator <span class="token operator">=</span> torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>

<span class="token comment"># 使用ControlNet完成AI绘画</span>
controlnet_conditioning_scale <span class="token operator">=</span> <span class="token number">0.6</span>

images <span class="token operator">=</span> pipe<span class="token punctuation">(</span>
    prompt<span class="token punctuation">,</span> num_inference_steps<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> negative_prompt<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"monochrome, lowres, bad anatomy, worst quality, low quality"</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">,</span>
    image<span class="token operator">=</span>Canny_image<span class="token punctuation">,</span> controlnet_conditioning_scale<span class="token operator">=</span>controlnet_conditioning_scale<span class="token punctuation">,</span> generator<span class="token operator">=</span>generator
<span class="token punctuation">)</span><span class="token punctuation">.</span>images

image_grid<span class="token punctuation">(</span>images<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/2aa9f529ca4fb88ffce5e881dcc831c8.png"></p>
<p>体验完Canny控制的强大，现在我们再来动手完成基于OpenPose条件的ControlNet绘画过程。想要使用OpenPose控制，我们首先需要提取原始图片的肢体关键点，代码是后面这样。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> controlnet_aux <span class="token keyword">import</span> OpenPoseDetector
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image

<span class="token comment"># 加载OpenPose提取模型</span>
model <span class="token operator">=</span> OpenPoseDetector<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span><span class="token string">"lllyasviel/ControlNet"</span><span class="token punctuation">)</span>

<span class="token comment"># 提取肢体姿态</span>
image <span class="token operator">=</span> load_image<span class="token punctuation">(</span>
    <span class="token string">"https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/diffusers/person.png"</span>
<span class="token punctuation">)</span>
pose <span class="token operator">=</span> model<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/b5b00f5b9b655ecdde2e91683ba1a15e.jpg" alt="p18"></p>
<p>之后，我们依次加载SDXL模型和OpenPose条件的ControlNet模型，使用prompt要求模型根据原始图片的姿态，生成一组星球大战维德的形象效果。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 加载ControlNet-OpenPose</span>
controlnet <span class="token operator">=</span> ControlNetModel<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span><span class="token string">"thibaud/controlnet-OpenPose-sdxl-1.0"</span><span class="token punctuation">,</span> torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16<span class="token punctuation">)</span>
pipe <span class="token operator">=</span> StableDiffusionXLControlNetPipeline<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>
    <span class="token string">"stabilityai/stable-diffusion-xl-base-1.0"</span><span class="token punctuation">,</span> controlnet<span class="token operator">=</span>controlnet<span class="token punctuation">,</span> torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16
<span class="token punctuation">)</span>
pipe<span class="token punctuation">.</span>enable_model_cpu_offload<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 可以更换为你想使用的prompt</span>
prompt <span class="token operator">=</span> <span class="token string">"Darth vader dancing in a desert, high quality"</span>
negative_prompt <span class="token operator">=</span> <span class="token string">"low quality, bad quality"</span>
images <span class="token operator">=</span> pipe<span class="token punctuation">(</span>
    prompt<span class="token punctuation">,</span>
    negative_prompt<span class="token operator">=</span>negative_prompt<span class="token punctuation">,</span>
    num_inference_steps<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">,</span>
    num_images_per_prompt<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
    image<span class="token operator">=</span>pose<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    generator<span class="token operator">=</span>torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">97</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span>images
image_grid<span class="token punctuation">(</span>images<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/4a90bb910f952020yyecb12b985dacc2.png"></p>
<p>通过上面两个例子，相信你已经感受到了ControlNet功能的强大之处。也推荐你课后探索下更多控制条件的生成效果。</p>
<h2 id="趣味玩法"><a href="#趣味玩法" class="headerlink" title="趣味玩法"></a>趣味玩法</h2><p>事实上，除了ControlNet1.0和1.1官方仓库中提供的用途外，ControlNet还可以帮助我们完成很多创意用法，比如图像风格化、二维码生成等等。我们逐一来进行代码实现。</p>
<h3 id="图像风格化"><a href="#图像风格化" class="headerlink" title="图像风格化"></a>图像风格化</h3><p>在 <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/688429">第15讲</a> 中，我们曾经探讨过，使用图生图来实现图像的风格化效果。具体做法就是通过重绘强度这个参数的控制，对输入图片加入少量步数的噪声，然后使用一个擅长生成风格图片的SD模型进行图片去噪。在ControlNet出现之前，大多数图片风格化效果都是采用类似这种方法实现的。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/2e26487d752c26d2e6d01572f9fb6612.jpg"></p>
<p>但是，这种风格化方法有一个缺陷，就是重绘强度这个参数的选择不好控制，可能要多次“抽卡”才能达到满意效果。如果重绘强度选择过小，最终生成的图片无法呈现目标风格效果。如果重绘强度选择过大，最终生成的图片就会丧失原始图片的构图，从而看不出与原图的关联。</p>
<p>ControlNet的出现弥补了这个缺陷。我们只需要提取原始图片的构图信息，比如使用Canny、HED、Depth等控制模块，便可以保证AI绘画效果与输入图片的构图一致。我们继续通过代码实现这个过程。你可以点开 <a target="_blank" rel="noopener" href="https://colab.research.google.com/github/NightWalker888/ai_painting_journey/blob/main/lesson21/ControlNet%E5%9B%BE%E7%89%87%E9%A3%8E%E6%A0%BC%E5%8C%96.ipynb">Colab</a> 进行操作。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> diffusers <span class="token keyword">import</span> StableDiffusionControlNetPipeline<span class="token punctuation">,</span> ControlNetModel
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> transformers <span class="token keyword">import</span> pipeline

<span class="token comment"># 提取图像的Depth信息</span>
image <span class="token operator">=</span> load_image<span class="token punctuation">(</span>
    <span class="token string">"https://ice.frostsky.com/2023/08/19/7a93c14f96e2ea8b3a4b6911fff134a1.png"</span>
<span class="token punctuation">)</span>
Depth_estimator <span class="token operator">=</span> pipeline<span class="token punctuation">(</span><span class="token string">'Depth-estimation'</span><span class="token punctuation">)</span>
image <span class="token operator">=</span> Depth_estimator<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'Depth'</span><span class="token punctuation">]</span>
image <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
image <span class="token operator">=</span> image<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>
image <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">,</span> image<span class="token punctuation">,</span> image<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
control_image <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>image<span class="token punctuation">)</span>

<span class="token comment"># 加载ControlNet1.1的Depth模型</span>
controlnet <span class="token operator">=</span> ControlNetModel<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span><span class="token string">"lllyasviel/control_v11f1p_sd15_Depth"</span><span class="token punctuation">)</span>
pipeline <span class="token operator">=</span> StableDiffusionControlNetPipeline<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>
  <span class="token string">"runwayml/stable-diffusion-v1-5"</span><span class="token punctuation">,</span> controlnet<span class="token operator">=</span>controlnet
<span class="token punctuation">)</span>

<span class="token comment"># 使用ControlNet完成风格化</span>
prompt <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"a praying cat, cartoon style, best quality, (8k, best quality, masterpiece:1.2)"</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">2</span>
generator <span class="token operator">=</span> torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
image <span class="token operator">=</span> pipe<span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> num_inference_steps<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> generator<span class="token operator">=</span>generator<span class="token punctuation">,</span> image<span class="token operator">=</span>control_image<span class="token punctuation">,</span> height <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">,</span> width <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">.</span>images
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>后面的图片里，前两张图片分别展示了原始输入、我们提取的Depth信息。第二行则是我们ControlNet生成的效果。我们可以将文生图视作重绘强度为1.0的图生图，可以看到，利用ControlNet，我们可以在保持原有构图的前提下，将猫咪转换为卡通风格。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/6ca864089502d1b8920c7b03f18c857f.jpg"></p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/89d910541206fdb55313b97ee2784b83.png"></p>
<h3 id="二维码"><a href="#二维码" class="headerlink" title="二维码"></a>二维码</h3><p>创意二维码生成是ControlNet非常亮眼的一个功能，比如我们这门课程的二维码，便是通过ControlNet来设计的。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/6b6d3f2d5a921c28650b14803eae677a.jpg"></p>
<p>这样的二维码该如何设计呢？首先需要准备一个原始的二维码图像。比如对于我们的 <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100555001?tab=catalog">课程链接</a>，我们可以任意选择一个二维码生成工具，生成一张二维码。比如这里我使用 <a target="_blank" rel="noopener" href="https://classic.qrbtf.com/">链接中</a> 的工具，生成了两款原始二维码。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/e178fa8b427762yy1f7a5e2512f358e9.png"></p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/383e293ce3e33b658420d075472434ba.jpg"></p>
<p>搞定了原始二维码，我们便可以用ControlNet来发挥我们的创造力了。你可以点开 <a target="_blank" rel="noopener" href="https://colab.research.google.com/github/NightWalker888/ai_painting_journey/blob/main/lesson21/ControlNet%E4%BA%8C%E7%BB%B4%E7%A0%81.ipynb">Colab链接</a> 和我一起操作。</p>
<p>首先加载生成二维码专用的ControlNet模型和对应的SD1.5基础模型。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> diffusers <span class="token keyword">import</span> ControlNetModel<span class="token punctuation">,</span> StableDiffusionControlNetPipeline

<span class="token comment"># 加载二维码生成对应的ControlNet模型</span>
controlnet <span class="token operator">=</span> ControlNetModel<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span><span class="token string">"Nacholmo/controlnet-qr-pattern-v2"</span><span class="token punctuation">)</span>
pipeline <span class="token operator">=</span> StableDiffusionControlNetPipeline<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>
	<span class="token string">"runwayml/stable-diffusion-v1-5"</span><span class="token punctuation">,</span> controlnet<span class="token operator">=</span>controlnet
<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后，我们使用原始二维码图像作为输入条件，并提供一个prompt用于引导AI绘画的生成过程。比如后面的代码中，使用我们课程的二维码作为控制条件，目标是生成两张创意二维码，分别是机器人风格和丛林风格。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 处理原始二维码图像，可以使用你的二维码链接，或者将本地二维码图片上传到Colab</span>
<span class="token comment"># 这里我们将二维码图片上传到图床获取图片链接</span>
init_image <span class="token operator">=</span> load_image<span class="token punctuation">(</span><span class="token string">"https://ice.frostsky.com/2023/08/19/38705b43b70b00af8d1aa23fd773102f.jpeg"</span><span class="token punctuation">)</span>

<span class="token comment"># 可以替换成你的prompt</span>
prompt <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"robot costume, best quality, extremely detailed"</span><span class="token punctuation">,</span> <span class="token string">"masterpiece, forest, jungle, trees, mist, fog, water, river, vines, photorealistic"</span><span class="token punctuation">]</span>

generator <span class="token operator">=</span> torch<span class="token punctuation">.</span>Generator<span class="token punctuation">(</span><span class="token string">"cuda"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">1025</span><span class="token punctuation">)</span>

<span class="token comment"># 生成二维码</span>
output <span class="token operator">=</span> pipeline<span class="token punctuation">(</span>
    prompt<span class="token punctuation">,</span>
    init_image<span class="token punctuation">,</span>
    negative_prompt<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"ugly, disfigured, low quality, blurry, nsfw"</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">,</span>
    generator<span class="token operator">=</span>generator<span class="token punctuation">,</span>
    num_inference_steps<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果你想上传自己手里的原始二维码，可以进入 <a target="_blank" rel="noopener" href="https://imgloc.com/">这个链接</a>，参考后面的示意图上传二维码图片，然后复制url链接，替换到后面截图位置的代码里。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/1cbfd30931300f85365a2bfa5a46ce59.png"></p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/d4a134eb080185b4a9a516869f2860e0.png"></p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/ca2235d6e34cb22e25a54c6b3bc28d6a.png"></p>
<p>你可以点开图片查看我们生成的二维码效果，确认可以扫码成功便大功告成。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/0d6889fd63d1dc355f3f490651edde6e.png"></p>
<h3 id="创意文字"><a href="#创意文字" class="headerlink" title="创意文字"></a>创意文字</h3><p>与二维码类似，我们还可以在照片中写入我们希望的文字。比如我们希望实现一张写着“极客”的创意图片。</p>
<p>注意，我们要做的并不是全新的字体设计，而是用已有的字体来生成创意文字。比如我们可以在文档中选择“手札体”写下目标文字，然后截图保存。将这张图片上传到Colab或者图床后，我们便可以生成创意文字了。你可以点开 <a target="_blank" rel="noopener" href="https://colab.research.google.com/github/NightWalker888/ai_painting_journey/blob/main/lesson21/ControlNet%E5%88%9B%E6%84%8F%E6%96%87%E5%AD%97.ipynb">Colab链接</a> 和我一起完成操作。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">image <span class="token operator">=</span> load_image<span class="token punctuation">(</span>
    <span class="token string">"https://ice.frostsky.com/2023/08/19/f9a6a52b210fb8dbc0fe347efbb22d9f.png"</span>
<span class="token punctuation">)</span>

<span class="token comment"># 将图像黑白颜色反转，得到的效果会更好</span>
inverted_image <span class="token operator">=</span> ImageOps<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
inverted_image
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对于创意字体这个任务，我们要使用Depth控制条件的ControlNet模型。这是因为Depth条件中包含3D信息，用于指导生成有3D感的图片效果更好。</p>
<p>在提取Depth信息前，我们需要将图片黑白通道反转，实测下来效果会更好。然后，我们使用黑白通道反转的图片，来提取Depth控制信息。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/e36db43f0fa7ac3da5fb8494f8c0a5c9.jpg"></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">image <span class="token operator">=</span> inverted_image
Depth_estimator <span class="token operator">=</span> pipeline<span class="token punctuation">(</span><span class="token string">'Depth-estimation'</span><span class="token punctuation">)</span>
image <span class="token operator">=</span> Depth_estimator<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'Depth'</span><span class="token punctuation">]</span>
image <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
image <span class="token operator">=</span> image<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>

<span class="token comment"># 将单通道图像复制三次，生成三通道(RGB)图像</span>
image <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">,</span> image<span class="token punctuation">,</span> image<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
control_image <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以点开后面的图片，查看我们得到的Depth控制条件。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/843284647be7188123aeba58c1e2f223.png"></p>
<p>搞定了控制条件，我们就可以加载ControlNet1.1的Depth模型以及SD1.5基础模型，指定prompt要求模型生成指定场景，比如树叶、白云等，完成我们的创意字体生成任务。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 使用ControlNet1.1的Depth模型</span>
checkpoint <span class="token operator">=</span> <span class="token string">"lllyasviel/control_v11f1p_sd15_Depth"</span>
controlnet <span class="token operator">=</span> ControlNetModel<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>checkpoint<span class="token punctuation">,</span> torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16<span class="token punctuation">)</span>
pipe <span class="token operator">=</span> StableDiffusionControlNetPipeline<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>
    <span class="token string">"runwayml/stable-diffusion-v1-5"</span><span class="token punctuation">,</span> controlnet<span class="token operator">=</span>controlnet<span class="token punctuation">,</span> torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16
<span class="token punctuation">)</span>

pipe<span class="token punctuation">.</span>scHEDuler <span class="token operator">=</span> UniPCMultistepScHEDuler<span class="token punctuation">.</span>from_config<span class="token punctuation">(</span>pipe<span class="token punctuation">.</span>scHEDuler<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
pipe<span class="token punctuation">.</span>enable_model_cpu_offload<span class="token punctuation">(</span><span class="token punctuation">)</span>

generator <span class="token operator">=</span> torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
image <span class="token operator">=</span> pipe<span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> num_inference_steps<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> generator<span class="token operator">=</span>generator<span class="token punctuation">,</span> image<span class="token operator">=</span>control_image<span class="token punctuation">)</span><span class="token punctuation">.</span>images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>你可以点开图片查看生成效果。可以看到，图像中的各个场景都呈现出“极客”的样式。当然，这里也可以选择其他和SD1.5亲缘关系接近的基础模型，实现更多有意思的效果。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/a7a5cbc0141bf7e1f52c4dabbe669d19.png"></p>
<h3 id="线稿上色"><a href="#线稿上色" class="headerlink" title="线稿上色"></a>线稿上色</h3><p>现在我们再来尝试一下线稿上色的任务。如果你手中有现成的线稿图片，可以在Colab中直接使用你的线稿来进行AI绘画。如果手上没有线稿，可以挑选一张喜欢的动漫图片，使用 <a target="_blank" rel="noopener" href="https://flandredaisuki.github.io/Outline-Extractor/">链接中的工具</a> 进行线稿提取。你可以点开 <a target="_blank" rel="noopener" href="https://colab.research.google.com/github/NightWalker888/ai_painting_journey/blob/main/lesson21/ControlNet%E7%BA%BF%E7%A8%BF%E4%B8%8A%E8%89%B2.ipynb">Colab链接</a> 和我一起进行操作。</p>
<p>在这个任务中，我们使用最新的SDXL模型和它对应的ControlNet Canny模型。我们可以通过下面的代码进行模型加载。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 特殊说明：模型计算量较大，需要使用Colab的高RAM模式，否则Colab容易Crash</span>
<span class="token comment"># 高RAM模式需要点击「修改」-「笔记本设置」进行修改</span>

controlnet <span class="token operator">=</span> ControlNetModel<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>
    <span class="token string">"diffusers/controlnet-Canny-sdxl-1.0-mid"</span><span class="token punctuation">,</span>
    torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16
<span class="token punctuation">)</span>
vae <span class="token operator">=</span> AutoencoderKL<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span><span class="token string">"madebyollin/sdxl-vae-fp16-fix"</span><span class="token punctuation">,</span> torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16<span class="token punctuation">)</span>
pipe <span class="token operator">=</span> StableDiffusionXLControlNetPipeline<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>
    <span class="token string">"stabilityai/stable-diffusion-xl-base-1.0"</span><span class="token punctuation">,</span>
    controlnet<span class="token operator">=</span>controlnet<span class="token punctuation">,</span>
    vae<span class="token operator">=</span>vae<span class="token punctuation">,</span>
    torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
pipe<span class="token punctuation">.</span>enable_model_cpu_offload<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>之后我们需要读取图床的图片链接，或者读取上传到Colab的图片线稿。然后我们使用OpenCV的Canny轮廓提取函数获得图像的Canny边缘。后面图片展示的就是原始线稿和提取的Canny边缘。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 你可以根据实际需求替换为你自己的图片</span>
image_original <span class="token operator">=</span> load_image<span class="token punctuation">(</span><span class="token string">"https://ice.frostsky.com/2023/08/26/3995bd36b16e2c65d5e7a98ad04264d2.png"</span><span class="token punctuation">)</span>
image_original

<span class="token comment"># 提取Canny边缘</span>
image <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>image_original<span class="token punctuation">)</span>
image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>Canny<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
image <span class="token operator">=</span> image<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>
image <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">,</span> image<span class="token punctuation">,</span> image<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
image <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
image
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/0815fa332a1fae8c3de8dbf8409926ac.jpg"></p>
<p>一切准备就绪后，我们写一个prompt描述目标图像，比如“一个黄头发、红眼睛、红衣服的卡通男孩”。利用SDXL的文生图能力，配合ControlNet的Canny轮廓控制，便可以给我们的线稿自动上色。后面代码展示的就是文生图的过程。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 结合ControlNet进行文生图</span>
prompt <span class="token operator">=</span> <span class="token string">"a handsome cartoon boy, yellow hair, red eyes, red clothes"</span>
generator <span class="token operator">=</span> torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">1025</span><span class="token punctuation">)</span>
negative_prompt <span class="token operator">=</span> <span class="token string">"lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, Normal quality, jpeg artifacts, signature, watermark, username, blurry"</span>

controlnet_conditioning_scale <span class="token operator">=</span> <span class="token number">0.6</span>

images <span class="token operator">=</span> pipe<span class="token punctuation">(</span>
    <span class="token punctuation">[</span>prompt<span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">,</span> num_inference_steps<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> negative_prompt<span class="token operator">=</span><span class="token punctuation">[</span>negative_prompt<span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">,</span> image<span class="token operator">=</span>image<span class="token punctuation">,</span> controlnet_conditioning_scale<span class="token operator">=</span>controlnet_conditioning_scale<span class="token punctuation">,</span>generator <span class="token operator">=</span> generator
<span class="token punctuation">)</span><span class="token punctuation">.</span>images
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在前面的代码中，我们一口气生成了4张效果图，耐心等待一会，便得到了下面图像中的效果。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/dcee9e7a06220e4678cfc7a232c7e05f.jpg"></p>
<p>使用同样的方法，我们可以给下面图像中的房屋简笔画进行上色。这里我们用到的prompt描述是“一张高质量、有细节的专业图片”。你可以点开图片查看上色效果。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/08e6c23864f59007654aa546186ab2ab.jpg"></p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/a2e99c103057feb9830d2d1c0a1593f4.png"></p>
<p>如果你手中有线稿，也期待你使用ControlNet为线稿实现染色效果。如果你有喜欢的动漫角色，也可以先提取线稿，然后试着为“他们”重新上色。</p>
<h2 id="总结时刻"><a href="#总结时刻" class="headerlink" title="总结时刻"></a>总结时刻</h2><p>今天这一讲，我们一起完成了不少实战项目，一起认识了ControlNet各种控制条件的特性，还用ControlNet完成了一些有趣的创作。</p>
<p>首先我们了解了Canny、HED、Scribble、MLSD这几种控制条件，它们的思路就是用不同形式的轮廓线实现AI绘画的可控生成。Normal、Depth这两种控制条件，能够帮助我们从2D图像中推断出3D几何信息，生成的图片3D空间感更强。而Seg、OpenPose这两种条件，则分别从分割结果和人体姿态的角度控制构图。</p>
<p>然后我们以实战的形式，体验了如何使用Canny和OpenPose作为控制条件实现AI绘画效果，并使用ControlNet完成了图像风格化、创意二维码生成、创意文字生成和线稿上色等趣味用法。</p>
<p>实际上，ControlNet的能力还远不止于此。比如我们还可以用ControlNet完成动漫人物转真人、在人像照片中写入不违和的文字等任务。这些功能背后的原理都是ControlNet，不过需要更精心地选择控制条件、ControlNet模型和基础模型。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202402/888ff087c36127611d760b97ebf70819.jpg"></p>
<h2 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h2><p>除了今天实战篇中学习的各种ControlNet用法，ControlNet还能实现哪些有趣的功能？欢迎你在Colab中实现出算法效果，并把你的Colab链接分享出来。</p>
<p>期待你在留言区和我交流讨论，也推荐你把今天的内容分享给身边更多朋友，和他一起探索ControlNet的多种玩法。</p>
</article><div class="tag_share"><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#21%EF%BD%9C-%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9A%E7%94%A8ControlNet%E7%BB%99%E4%BD%A0%E7%9A%84%E5%88%9B%E6%84%8F%E4%B8%8A%E8%89%B2"><span class="toc-number">1.</span> <span class="toc-text">21｜ 实战项目（四）：用ControlNet给你的创意上色</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E8%8E%B7%E5%8F%96"><span class="toc-number">1.1.</span> <span class="toc-text">模型获取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E5%8F%91%E5%B8%83%E7%9A%84%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">官方发布的模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%89%E8%B6%A3%E7%9A%84%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.1.2.</span> <span class="toc-text">有趣的第三方模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%8F%E5%85%B8%E6%8A%80%E8%83%BD"><span class="toc-number">1.2.</span> <span class="toc-text">经典技能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B6%A3%E5%91%B3%E7%8E%A9%E6%B3%95"><span class="toc-number">1.3.</span> <span class="toc-text">趣味玩法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E5%83%8F%E9%A3%8E%E6%A0%BC%E5%8C%96"><span class="toc-number">1.3.1.</span> <span class="toc-text">图像风格化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E7%BB%B4%E7%A0%81"><span class="toc-number">1.3.2.</span> <span class="toc-text">二维码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E6%84%8F%E6%96%87%E5%AD%97"><span class="toc-number">1.3.3.</span> <span class="toc-text">创意文字</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%BF%E4%B8%8A%E8%89%B2"><span class="toc-number">1.3.4.</span> <span class="toc-text">线稿上色</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E6%97%B6%E5%88%BB"><span class="toc-number">1.4.</span> <span class="toc-text">总结时刻</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%80%83%E9%A2%98"><span class="toc-number">1.5.</span> <span class="toc-text">思考题</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2024 By 码农张三</div></div><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/9.4.0/mermaid.min.js"></script></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div></div></body></html>