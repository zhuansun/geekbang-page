<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>07｜文本聚类与摘要，让AI帮你做个总结 | geekbang</title><meta name="author" content="码农张三"><meta name="copyright" content="码农张三"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="07｜文本聚类与摘要，让AI帮你做个总结你好，我是徐文浩。 上一讲里，我们用上了最新的ChatGPT的API，注册好了HuggingFace的账号，也把我们的聊天机器人部署了出去。希望通过这个过程，你对实际的应用开发过程已经有了充足的体验。那么这一讲里，我们会回到OpenAI的各个接口能够提供的能力。我们分别看看怎么通过Embedding进行文本聚类，怎么利用提示语（Prompt）做文本的总结。">
<meta property="og:type" content="article">
<meta property="og:title" content="07｜文本聚类与摘要，让AI帮你做个总结">
<meta property="og:url" content="https://zhuansun.github.io/geekbang/posts/198495601.html">
<meta property="og:site_name" content="geekbang">
<meta property="og:description" content="07｜文本聚类与摘要，让AI帮你做个总结你好，我是徐文浩。 上一讲里，我们用上了最新的ChatGPT的API，注册好了HuggingFace的账号，也把我们的聊天机器人部署了出去。希望通过这个过程，你对实际的应用开发过程已经有了充足的体验。那么这一讲里，我们会回到OpenAI的各个接口能够提供的能力。我们分别看看怎么通过Embedding进行文本聚类，怎么利用提示语（Prompt）做文本的总结。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg">
<meta property="article:published_time" content="2023-10-20T09:48:40.000Z">
<meta property="article:modified_time" content="2023-12-15T09:26:31.074Z">
<meta property="article:author" content="码农张三">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhuansun.github.io/geekbang/posts/198495601"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '07｜文本聚类与摘要，让AI帮你做个总结',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-12-15 09:26:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="geekbang" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://pic.imgdb.cn/item/653470a0c458853aef5813f1.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">870</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">geekbang</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">07｜文本聚类与摘要，让AI帮你做个总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-10-20T09:48:40.000Z" title="发表于 2023-10-20 09:48:40">2023-10-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AI%E5%A4%A7%E6%A8%A1%E5%9E%8B%E4%B9%8B%E7%BE%8E/">AI大模型之美</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="07｜文本聚类与摘要，让AI帮你做个总结"><a href="#07｜文本聚类与摘要，让AI帮你做个总结" class="headerlink" title="07｜文本聚类与摘要，让AI帮你做个总结"></a>07｜文本聚类与摘要，让AI帮你做个总结</h1><p>你好，我是徐文浩。</p>
<p>上一讲里，我们用上了最新的ChatGPT的API，注册好了HuggingFace的账号，也把我们的聊天机器人部署了出去。希望通过这个过程，你对实际的应用开发过程已经有了充足的体验。那么这一讲里，我们会回到OpenAI的各个接口能够提供的能力。我们分别看看怎么通过Embedding进行文本聚类，怎么利用提示语（Prompt）做文本的总结。</p>
<h2 id="基于Embedding向量进行文本聚类"><a href="#基于Embedding向量进行文本聚类" class="headerlink" title="基于Embedding向量进行文本聚类"></a>基于Embedding向量进行文本聚类</h2><p>我先给不太了解技术的同学简单科普一下什么叫做文本聚类，文本聚类就是把很多没有标注过的文本，根据它们之间的相似度，自动地分成几类。基于GPT系列的模型进行文本聚类很简单，因为我们可以通过Embedding把文本变成一段向量。而对于向量我们自然可以用一些简单的聚类算法，比如我们采用最简单的K-Means算法就可以了。</p>
<p>这一次，我们选用的数据集，是很多老的机器学习教程里常用的20 newsgroups数据集，也就是一个带了标注分好类的英文新闻组的数据集。这个数据集，其实不是最自然的自然语言，里面的数据是经过了预处理的，比如去除了标点符号、停用词等等。我们正好可以拿来看看，面对这样其实不太“自然语言”的数据，OpenAI的GPT系列模型处理的效果怎么样。</p>
<p>首先，我们先通过scikit-learn这个Python库来拿到数据，数据集就内置在这个库里面。scikit-learn也是非常常用的一个机器学习库，我们直接把数据下载下来，存储成CSV文件。对应的代码在下面可以看到。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> fetch_20newsgroups
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd

<span class="token keyword">def</span> <span class="token function">twenty_newsgroup_to_csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    newsgroups_train <span class="token operator">=</span> fetch_20newsgroups<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">,</span> remove<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'headers'</span><span class="token punctuation">,</span> <span class="token string">'footers'</span><span class="token punctuation">,</span> <span class="token string">'quotes'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">[</span>newsgroups_train<span class="token punctuation">.</span>data<span class="token punctuation">,</span> newsgroups_train<span class="token punctuation">.</span>target<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
    df<span class="token punctuation">.</span>columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token string">'target'</span><span class="token punctuation">]</span>

    targets <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span> newsgroups_train<span class="token punctuation">.</span>target_names<span class="token punctuation">,</span> columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    out <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>df<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> left_on<span class="token operator">=</span><span class="token string">'target'</span><span class="token punctuation">,</span> right_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    out<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'20_newsgroup.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

twenty_newsgroup_to_csv<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接着，我们要对数据做预处理，我们需要过滤掉数据里面有些文本是空的情况。以及和我们前面进行文本分类一样，把Token数量太多的给过滤掉。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> openai<span class="token punctuation">.</span>embeddings_utils <span class="token keyword">import</span> get_embeddings
<span class="token keyword">import</span> openai<span class="token punctuation">,</span> os<span class="token punctuation">,</span> tiktoken<span class="token punctuation">,</span> backoff

openai<span class="token punctuation">.</span>api_key <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"OPENAI_API_KEY"</span><span class="token punctuation">)</span>
embedding_model <span class="token operator">=</span> <span class="token string">"text-embedding-ada-002"</span>
embedding_encoding <span class="token operator">=</span> <span class="token string">"cl100k_base"</span>  <span class="token comment"># this the encoding for text-embedding-ada-002</span>
batch_size <span class="token operator">=</span> <span class="token number">2000</span>
max_tokens <span class="token operator">=</span> <span class="token number">8000</span>  <span class="token comment"># the maximum for text-embedding-ada-002 is 8191</span>

df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'20_newsgroup.csv'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Number of rows before null filtering:"</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> df<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">False</span><span class="token punctuation">]</span>
encoding <span class="token operator">=</span> tiktoken<span class="token punctuation">.</span>get_encoding<span class="token punctuation">(</span>embedding_encoding<span class="token punctuation">)</span>

df<span class="token punctuation">[</span><span class="token string">"n_tokens"</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>encoding<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Number of rows before token number filtering:"</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> df<span class="token punctuation">[</span>df<span class="token punctuation">.</span>n_tokens <span class="token operator">&lt;=</span> max_tokens<span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Number of rows data used:"</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出结果：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">Number of rows before null filtering<span class="token punctuation">:</span> <span class="token number">11314</span>
Number of rows before token number filtering<span class="token punctuation">:</span> <span class="token number">11096</span>
Number of rows data used<span class="token punctuation">:</span> <span class="token number">11044</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后，我们仍然是通过Embedding的接口，拿到文本的Embedding向量，然后把整个数据存储成parquet文件。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@backoff<span class="token punctuation">.</span>on_exception</span><span class="token punctuation">(</span>backoff<span class="token punctuation">.</span>expo<span class="token punctuation">,</span> openai<span class="token punctuation">.</span>error<span class="token punctuation">.</span>RateLimitError<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_embeddings_with_backoff</span><span class="token punctuation">(</span>prompts<span class="token punctuation">,</span> engine<span class="token punctuation">)</span><span class="token punctuation">:</span>
    embeddings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>prompts<span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        batch <span class="token operator">=</span> prompts<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>batch_size<span class="token punctuation">]</span>
        embeddings <span class="token operator">+=</span> get_embeddings<span class="token punctuation">(</span>list_of_text<span class="token operator">=</span>batch<span class="token punctuation">,</span> engine<span class="token operator">=</span>engine<span class="token punctuation">)</span>
    <span class="token keyword">return</span> embeddings

prompts <span class="token operator">=</span> df<span class="token punctuation">.</span>text<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
prompt_batches <span class="token operator">=</span> <span class="token punctuation">[</span>prompts<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>batch_size<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>prompts<span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">]</span>

embeddings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> batch <span class="token keyword">in</span> prompt_batches<span class="token punctuation">:</span>
    batch_embeddings <span class="token operator">=</span> get_embeddings_with_backoff<span class="token punctuation">(</span>prompts<span class="token operator">=</span>batch<span class="token punctuation">,</span> engine<span class="token operator">=</span>embedding_model<span class="token punctuation">)</span>
    embeddings <span class="token operator">+=</span> batch_embeddings

df<span class="token punctuation">[</span><span class="token string">"embedding"</span><span class="token punctuation">]</span> <span class="token operator">=</span> embeddings
df<span class="token punctuation">.</span>to_parquet<span class="token punctuation">(</span><span class="token string">"data/20_newsgroup_with_embedding.parquet"</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这一部分代码基本和前面我们做文本分类一样，我就不再做详细讲解了。不理解代码为什么要这么写的同学，可以去看前面的 <a target="_blank" rel="noopener" href="http://time.geekbang.org/column/article/643889">第 05 讲</a>。</p>
<p>通常，在使用Jupyter Notebook或者Python去做机器学习类的任务的时候，我们往往会把一些中间步骤的数据结果给存下来。这样，我们可以避免在后面步骤写了Bug或者参数设错的时候从头开始。在这里，我们就把原始数据，以及Embedding处理完的数据都存了一份。这样，如果后面的聚类程序要做修改，我们不需要再花钱让OpenAI给我们算一次Embedding了。</p>
<p>接着，我们就可以用K-Means算法来进行聚类了。因为原本的数据来自20个不同的新闻组，那么我们也不妨就聚合成20个类，正好我们看看自动聚类出来的分类会不会就和原始分类差不多。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>cluster <span class="token keyword">import</span> KMeans

embedding_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_parquet<span class="token punctuation">(</span><span class="token string">"data/20_newsgroup_with_embedding.parquet"</span><span class="token punctuation">)</span>

matrix <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span>embedding_df<span class="token punctuation">.</span>embedding<span class="token punctuation">.</span>values<span class="token punctuation">)</span>
num_of_clusters <span class="token operator">=</span> <span class="token number">20</span>

kmeans <span class="token operator">=</span> KMeans<span class="token punctuation">(</span>n_clusters<span class="token operator">=</span>num_of_clusters<span class="token punctuation">,</span> init<span class="token operator">=</span><span class="token string">"k-means++"</span><span class="token punctuation">,</span> n_init<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>
kmeans<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>matrix<span class="token punctuation">)</span>
labels <span class="token operator">=</span> kmeans<span class="token punctuation">.</span>labels_
embedding_df<span class="token punctuation">[</span><span class="token string">"cluster"</span><span class="token punctuation">]</span> <span class="token operator">=</span> labels
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>聚类的代码非常简单，我们通过NumPy的stack函数，把所有的Embedding放到一个矩阵里面，设置一下要聚合出来的类的数量，然后运行一下K-Means算法的fit函数，就好了。不过，聚类完，我们怎么去看它聚类的结果是不是合适呢？每个聚合出来的类代表什么呢？</p>
<p>在这里，我们的数据之前就有分组。那么我们就可以用一个取巧的思路。我们统计一下聚类之后的每个类有多少条各个newsgroups分组的数据。然后看看这些数据里面，排名第一的分组是什么。如果我们聚类聚合出来的类，都是从某一个newsgroup分组出来的文章，那么说明这个聚合出来的类其实就和那个分组的内容差不多。使用这个思路的代码，我也放在下面了，我们一起来看一看。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 统计每个cluster的数量</span>
new_df <span class="token operator">=</span> embedding_df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'cluster'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'cluster'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'count'</span><span class="token punctuation">)</span>

<span class="token comment"># 统计这个cluster里最多的分类的数量</span>
title_count <span class="token operator">=</span> embedding_df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'cluster'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'title_count'</span><span class="token punctuation">)</span>
first_titles <span class="token operator">=</span> title_count<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'cluster'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>nlargest<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'title_count'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
first_titles <span class="token operator">=</span> first_titles<span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
new_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>new_df<span class="token punctuation">,</span> first_titles<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'cluster'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'title_count'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token string">'cluster'</span><span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span>
new_df <span class="token operator">=</span> new_df<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">'rank1'</span><span class="token punctuation">,</span> <span class="token string">'title_count'</span><span class="token punctuation">:</span> <span class="token string">'rank1_count'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment"># 统计这个cluster里第二多的分类的数量</span>
second_titles <span class="token operator">=</span> title_count<span class="token punctuation">[</span><span class="token operator">~</span>title_count<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span>first_titles<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
second_titles <span class="token operator">=</span> second_titles<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'cluster'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>nlargest<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'title_count'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
second_titles <span class="token operator">=</span> second_titles<span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
new_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>new_df<span class="token punctuation">,</span> second_titles<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'cluster'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'title_count'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token string">'cluster'</span><span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span>
new_df <span class="token operator">=</span> new_df<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">'rank2'</span><span class="token punctuation">,</span> <span class="token string">'title_count'</span><span class="token punctuation">:</span> <span class="token string">'rank2_count'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
new_df<span class="token punctuation">[</span><span class="token string">'first_percentage'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>new_df<span class="token punctuation">[</span><span class="token string">'rank1_count'</span><span class="token punctuation">]</span> <span class="token operator">/</span> new_df<span class="token punctuation">[</span><span class="token string">'count'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token string">'&#123;:.2%&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 将缺失值替换为 0</span>
new_df<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment"># 输出结果</span>
<span class="token keyword">from</span> IPython<span class="token punctuation">.</span>display <span class="token keyword">import</span> display
display<span class="token punctuation">(</span>new_df<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个代码也不难写，我们可以分成几步来做。</p>
<ol>
<li>我们通过groupby可以把之前的DataFrame按照cluster进行聚合，统计每个cluster里面数据的条数。</li>
<li>而要统计某一个cluster里面排名第一的分组名称和数量的时候，我们可以通过groupby，把数据按照 cluster + title 的方式聚合。</li>
<li>再通过 cluster 聚合后，使用 x.nlargest 函数拿到里面数量排名第一的分组的名字和数量。</li>
<li>为了方便分析，我还把数据里排名第一的去掉之后，又统计了一下排名第二的分组，放在一起看一下。</li>
</ol>
<p>输出结果：</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/f66f45d30edfb11a3f97a964684bd00c.png" alt="图片"></p>
<p>从这个统计数据的结果来看，大部分聚类的结果，能够对应到某一个原本新闻组的分类。比如，cluster 0就有93.98%来自 comp.windows.x 这个分类。在20个聚合出来的类里面，有10个类80%来自原本newsgroup的某一个分类。剩下的分类中，比如cluster 2，前两个分组加在一起占了75%，这两个分组的名称分别是 pc.hardware 和 mac.hardware 其实都是聊电脑硬件的，不过是newsgroups里按照硬件不同做了区分而已。我们只有3个类，对应的分组比较分散，分别是cluster 6、9和19。</p>
<p>从这个结果来看，我们直接使用文本的Embedding来进行聚类，效果还算不错。</p>
<h2 id="使用提示语对文本进行总结"><a href="#使用提示语对文本进行总结" class="headerlink" title="使用提示语对文本进行总结"></a>使用提示语对文本进行总结</h2><p>不过啊，在真实的应用场景里，我们拿来进行文本聚类的数据，多半并没有什么分组信息。过去，我们要去给聚合出来的类取一个名字，往往只能选择看看各个类里面的文本是什么内容。靠我们的“人脑”给“电脑”做出的选择起一个我们觉得合适的名字。比如，对应到这里的20个分类的数据，往往我们只能每个挑上几篇内容，人工读一遍，再取一个名字。而如果你英文不太好，那可就太痛苦了。</p>
<p>不过，既然有了OpenAI的Completion接口，我们完全可以让AI给我们聚合出来的类起一个名字。我们可以随机在每个聚合出来的类里面，挑上3～5条，然后请AI总结一下该取什么名字，然后再挑一两条文本让AI给我们翻译成中文，看看名字取的是不是合理。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">items_per_cluster <span class="token operator">=</span> <span class="token number">10</span>
COMPLETIONS_MODEL <span class="token operator">=</span> <span class="token string">"text-davinci-003"</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_of_clusters<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cluster_name <span class="token operator">=</span> new_df<span class="token punctuation">[</span>new_df<span class="token punctuation">.</span>cluster <span class="token operator">==</span> i<span class="token punctuation">]</span><span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rank1
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Cluster </span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">, Rank 1: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>cluster_name<span class="token punctuation">&#125;</span></span><span class="token string">, Theme:"</span></span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>

    content <span class="token operator">=</span> <span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
        embedding_df<span class="token punctuation">[</span>embedding_df<span class="token punctuation">.</span>cluster <span class="token operator">==</span> i<span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>items_per_cluster<span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values
    <span class="token punctuation">)</span>
    response <span class="token operator">=</span> openai<span class="token punctuation">.</span>Completion<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
        model<span class="token operator">=</span>COMPLETIONS_MODEL<span class="token punctuation">,</span>
        prompt<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f'''我们想要给下面的内容，分组成有意义的类别，以便我们可以对其进行总结。请根据下面这些内容的共同点，总结一个50个字以内的新闻组的名称。比如 “PC硬件”\n\n内容:\n"""\n</span><span class="token interpolation"><span class="token punctuation">&#123;</span>content<span class="token punctuation">&#125;</span></span><span class="token string">\n"""新闻组名称：'''</span></span><span class="token punctuation">,</span>
        temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        max_tokens<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
        top_p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">[</span><span class="token string">"choices"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们可以用这样一段代码通过Completion接口来实现我们的需求。</p>
<ol>
<li>我们随机从聚类结果里的每一个类里面，都挑上10条记录，然后分行将这些记录拼在一起。</li>
<li>然后，我们给AI这样一段提示语，告诉AI这些内容来自新闻组，请AI根据它们的共性给这些新闻组的内容取一个50个字以内的名字。</li>
<li>输出的内容，我们用Cluster，Cluster里原先排名第一的分组英文，以及AI给出的新闻组名称，对应的输出结果在下面。</li>
</ol>
<p>输出结果：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">Cluster <span class="token number">0</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> comp<span class="token punctuation">.</span>windows<span class="token punctuation">.</span>x<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> Xlib编程
Cluster <span class="token number">1</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> sci<span class="token punctuation">.</span>space<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 太空技术与航空
Cluster <span class="token number">2</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> comp<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>ibm<span class="token punctuation">.</span>pc<span class="token punctuation">.</span>hardware<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> PC硬件与系统
Cluster <span class="token number">3</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> rec<span class="token punctuation">.</span>sport<span class="token punctuation">.</span>hockey<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 欧洲冰球vs北美冰球
Cluster <span class="token number">4</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> talk<span class="token punctuation">.</span>politics<span class="token punctuation">.</span>misc<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 社会观点与自由
Cluster <span class="token number">5</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> rec<span class="token punctuation">.</span>autos<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 汽车硬件
Cluster <span class="token number">6</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> rec<span class="token punctuation">.</span>motorcycles<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 数学与文化冲击
Cluster <span class="token number">7</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> comp<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ms<span class="token operator">-</span>windows<span class="token punctuation">.</span>misc<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> PC软件与硬件
Cluster <span class="token number">8</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> talk<span class="token punctuation">.</span>politics<span class="token punctuation">.</span>mideast<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> “穆斯林大屠杀”
Cluster <span class="token number">9</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> comp<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ms<span class="token operator">-</span>windows<span class="token punctuation">.</span>misc<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 科技产品<span class="token string">""</span>"
Cluster <span class="token number">10</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> talk<span class="token punctuation">.</span>politics<span class="token punctuation">.</span>guns<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 枪支管制与安全
Cluster <span class="token number">11</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> comp<span class="token punctuation">.</span>graphics<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 计算机编程与硬件
Cluster <span class="token number">12</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> rec<span class="token punctuation">.</span>motorcycles<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 骑行安全与技巧
Cluster <span class="token number">13</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> soc<span class="token punctuation">.</span>religion<span class="token punctuation">.</span>christian<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 宗教信仰与实践
Cluster <span class="token number">14</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> rec<span class="token punctuation">.</span>sport<span class="token punctuation">.</span>baseball<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 棒球联盟
Cluster <span class="token number">15</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> misc<span class="token punctuation">.</span>forsale<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 购物优惠和出售
Cluster <span class="token number">16</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> sci<span class="token punctuation">.</span>crypt<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 关于加密政策的讨论
Cluster <span class="token number">17</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> sci<span class="token punctuation">.</span>electronics<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 电子设备技术
Cluster <span class="token number">18</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> sci<span class="token punctuation">.</span>med<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 药物和疾病
Cluster <span class="token number">19</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> sci<span class="token punctuation">.</span>electronics<span class="token punctuation">,</span> Theme<span class="token punctuation">:</span> 电子邮件使用者研究
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到，机器给出的中文分类名称，大部分是合理的。我们还可以挑一些里面的文本内容，看看它们的中文翻译是不是和上面取的名字是一致的。翻译的代码和上面类似，少数的几个差别是：</p>
<ol>
<li>我们在每个分类的抽样数据里只找了1条，而不是总结时候选的10条。</li>
<li>我们限制了这段文本的Token数量不超过100个，免得太占地方。</li>
<li>输出的内容我们放大了字数到500字，确保翻译能提供足够的内容。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">items_per_cluster <span class="token operator">=</span> <span class="token number">1</span>
COMPLETIONS_MODEL <span class="token operator">=</span> <span class="token string">"text-davinci-003"</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_of_clusters<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cluster_name <span class="token operator">=</span> new_df<span class="token punctuation">[</span>new_df<span class="token punctuation">.</span>cluster <span class="token operator">==</span> i<span class="token punctuation">]</span><span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rank1
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Cluster </span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">, Rank 1: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>cluster_name<span class="token punctuation">&#125;</span></span><span class="token string">, 抽样翻译:"</span></span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">" "</span><span class="token punctuation">)</span>

    content <span class="token operator">=</span> <span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
        embedding_df<span class="token punctuation">[</span><span class="token punctuation">(</span>embedding_df<span class="token punctuation">.</span>cluster <span class="token operator">==</span> i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>embedding_df<span class="token punctuation">.</span>n_tokens <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>items_per_cluster<span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values
    <span class="token punctuation">)</span>
    response <span class="token operator">=</span> openai<span class="token punctuation">.</span>Completion<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
        model<span class="token operator">=</span>COMPLETIONS_MODEL<span class="token punctuation">,</span>
        prompt<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f'''请把下面的内容翻译成中文\n\n内容:\n"""\n</span><span class="token interpolation"><span class="token punctuation">&#123;</span>content<span class="token punctuation">&#125;</span></span><span class="token string">\n"""翻译：'''</span></span><span class="token punctuation">,</span>
        temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        max_tokens<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span>
        top_p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">[</span><span class="token string">"choices"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出结果：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">Cluster <span class="token number">0</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> comp<span class="token punctuation">.</span>windows<span class="token punctuation">.</span>x<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 没有实际执行它？不知怎么回事，我的一个xterminal用户使得只要点击鼠标右键，就会自动杀死所有客户端<span class="token operator">-</span>哦，我的：<span class="token operator">-</span><span class="token punctuation">(</span>谢谢，Fish
Cluster <span class="token number">1</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> sci<span class="token punctuation">.</span>space<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 韦恩·马森和他的团伙在阿拉巴马州发生了什么？我还听说有一个未经证实的谣言，即航空大使们已经消失了。有其他人可以证实吗？
Cluster <span class="token number">2</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> comp<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>ibm<span class="token punctuation">.</span>pc<span class="token punctuation">.</span>hardware<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 我怀疑这不是一个特定于Quadra的问题。去年我不得不放弃我“古老”的Bernoulli <span class="token number">20</span>（每个磁带的价格大约是<span class="token number">90</span>美元，使整个事情的价值超过我的整个电脑<span class="token punctuation">;</span>）。Ocean Microsystems的技术支持人员建议可以使用一些第三方驱动程序来解决这个问题 <span class="token operator">-</span> 在我的情况下，磁带无法格式化<span class="token operator">/</span>挂载<span class="token operator">/</span>分区用于A <span class="token operator">/</span> UX。
Cluster <span class="token number">3</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> rec<span class="token punctuation">.</span>sport<span class="token punctuation">.</span>hockey<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 我相信那是<span class="token number">4</span><span class="token operator">-</span><span class="token number">1</span>。罗德·布林道·阿莫尔在第三节<span class="token number">19.59</span>时分攻入一球。
Cluster <span class="token number">4</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> talk<span class="token punctuation">.</span>politics<span class="token punctuation">.</span>misc<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 为了确保每个人都清楚：“它从未有过”是指“保护”，而不是“未能保护”；即，在我的一生中，我从未见过美国政府始终保护美国公民的利益，除非是意外。
Cluster <span class="token number">5</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> rec<span class="token punctuation">.</span>autos<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 噢，来吧，傻瓜，你要做的就是在你的引擎罩上割一个洞，然后把一个管子放进去，这样你就可以把机油倒进去了。你觉得那些热门车上的大空气进气装置是干什么的？它们只是为了外观，没有人知道，它们提供了进入机油填充孔的途径。
Cluster <span class="token number">6</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> rec<span class="token punctuation">.</span>motorcycles<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 你真是个失败者
Cluster <span class="token number">7</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> comp<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ms<span class="token operator">-</span>windows<span class="token punctuation">.</span>misc<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 偶尔你需要为表现良好的东西说句好话。我的东西桥<span class="token number">3401</span>没有任何问题。它在DOS和OS<span class="token operator">/</span><span class="token number">2</span>上运行得很好。对于OS<span class="token operator">/</span><span class="token number">2</span>，你不需要加载任何特殊的驱动程序。安装会检测到它是一个东西桥驱动器，然后就完成了。顺便说一句，它也很快！
Cluster <span class="token number">8</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> talk<span class="token punctuation">.</span>politics<span class="token punctuation">.</span>mideast<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> Avi，    供你参考，伊斯兰教允许宗教自由——在宗教上没有强制。犹太教是否也允许宗教自由（即是否认可非犹太人）？只是好奇而已。
Cluster <span class="token number">9</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> comp<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ms<span class="token operator">-</span>windows<span class="token punctuation">.</span>misc<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 每个人都有自己的梦想，但只有勇敢追求梦想的人才能实现它。
Cluster <span class="token number">10</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> talk<span class="token punctuation">.</span>politics<span class="token punctuation">.</span>guns<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 不一定，特别是如果强奸犯被认定为此。例如，如果你有意地把手指伸进一个装满了老鼠夹的地方，然后被夹住，这是谁的错？
Cluster <span class="token number">11</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> comp<span class="token punctuation">.</span>graphics<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 帮帮我！！我需要代码<span class="token operator">/</span>包<span class="token operator">/</span>任何东西来处理3D数据，并将其转换为带有隐藏线的线框表面。我正在使用DOS机器，代码可以是ANSI C或C <span class="token operator">+</span><span class="token operator">+</span>，ANSI Fortran或Basic。我使用的数据形成一个矩形网格。请将您的回复发布到网络上，以便其他人受益。我的个人观点是，这是一个普遍的兴趣问题。谢谢！！！！！
Cluster <span class="token number">12</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> rec<span class="token punctuation">.</span>motorcycles<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 这是一段心理学，对于任何长期骑行者来说都是必不可少的。人们不会去想“如果我这么做会有其他人受到影响吗？”他们只会评估“如果我这么做会受到影响吗？”
Cluster <span class="token number">13</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> soc<span class="token punctuation">.</span>religion<span class="token punctuation">.</span>christian<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 这是一个非常薄弱的论点，因为没有独立的支持文本（关于关键事件）。至于新约最古老的现存文本的日期<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>如果现在只有一个关于美国内战的现存文本，你会怎么想？现在考虑一个大部分文盲的人口，每一份手稿都是手工复制的<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">-</span><span class="token operator">-</span>Hal
Cluster <span class="token number">14</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> rec<span class="token punctuation">.</span>sport<span class="token punctuation">.</span>baseball<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 这个赔率意味着你下注<span class="token number">5</span>美元赌反败者赢<span class="token number">8</span>美元，或者下注<span class="token number">9</span>美元赌胜者赢<span class="token number">5</span>美元。
Cluster <span class="token number">15</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> misc<span class="token punctuation">.</span>forsale<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 嗯，标题就是这样<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>我正在寻找便宜的二手TG<span class="token operator">-</span><span class="token number">16</span>游戏，它们支持<span class="token number">2</span>个或更多玩家（同时）<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>请给我发送所有带有价格的报价。
Cluster <span class="token number">16</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> sci<span class="token punctuation">.</span>crypt<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 哪里？老实说，我没有看到任何……我不同意，至少有其他标准已经存在。此外，即使他们限制NREN上的加密，谁在乎呢？大部分互联网都是商业的。NREN只适用于政府和大学研究（阅读提案<span class="token operator">-</span>它是一条“数据高速公路”，与互联网无关）。
Cluster <span class="token number">17</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> sci<span class="token punctuation">.</span>electronics<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 动态RAM不是基于翻转锁存器；基本上每个位只有一个晶体管和电容来存储！静态RAM是基于翻转锁存器，更加昂贵，密度也更低。如果忽略电子和热膨胀，两者都没有任何“移动”的部件<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Chris
Cluster <span class="token number">18</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> sci<span class="token punctuation">.</span>med<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 化学品已经消失，感谢所有的回应。
Cluster <span class="token number">19</span><span class="token punctuation">,</span> Rank <span class="token number">1</span><span class="token punctuation">:</span> sci<span class="token punctuation">.</span>electronics<span class="token punctuation">,</span> 抽样翻译<span class="token punctuation">:</span> 尝试lyman<span class="token punctuation">.</span>pppl<span class="token punctuation">.</span>gov<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">/</span>pub<span class="token operator">/</span><span class="token number">8051</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从输出的结果来看，我们选取的内容和AI总结的标题的确八九不离十。不知道这个过程，有没有重新让你回忆起Completion这个接口的强大之处。我们只要给出合适的指令，它就能按照我们的心意给出合理的结果。</p>
<h2 id="利用文本摘要支持无限轮数的聊天"><a href="#利用文本摘要支持无限轮数的聊天" class="headerlink" title="利用文本摘要支持无限轮数的聊天"></a>利用文本摘要支持无限轮数的聊天</h2><p>不知道你是否还记得上一讲里的思考题，如果不只是保留过去几轮对话，我们怎么在对话轮数越来越多的时候让AI记住尽量多的上下文？有一个办法，就是将过去几轮的上下文内容，先交给AI做一个100字的总结。然后，把这个总结也作为对话的Prompt信息，告诉AI这是聊天的背景，再重新开始新的一轮对话。</p>
<p>在这里我们不妨试一下。</p>
<ol>
<li>我们拿上一讲的一段聊天记录，让AI先总结一下，可以看到AI总结了User和Assistant之间聊了什么。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">history <span class="token operator">=</span> <span class="token triple-quoted-string string">"""User : 你是谁？
Assistant : 我是一个人工智能语言模型，可以回答各种问题，包括做菜的问题。

User : 请问鱼香肉丝怎么做？
Assistant : 鱼香肉丝的做法：

1. 猪里脊肉切丝，加入盐、淀粉、料酒搅拌均匀，腌制10分钟
2. 胡萝卜、青椒、木耳切丝备用
3. 热锅凉油，放入蒜末、姜末煸炒出香味，加入肉丝翻炒至变色
4. 加入胡萝卜、青椒、木耳翻炒，加入酱油、糖、醋、盐、味精、水淀粉搅拌均匀，倒入锅中翻炒均匀即可。

提示：鱼香肉丝的关键是调料的配比，酱油、糖、醋、盐、味精的比例要适合自己的口味。

User : 那蚝油牛肉呢？
Assistant : 蚝油牛肉的做法：

1. 将牛肉切成薄片，加入盐、淀粉、料酒腌制10分钟
2. 葱姜切末，蒜切片，青红椒切丝备用
3. 热锅凉油，放入葱姜末、蒜片煸炒出香味，加入牛肉翻炒至变色
4. 加入蚝油、酱油、糖、水淀粉调味，加入青红椒翻炒均匀即可。

提示：蚝油牛肉的关键是牛肉要切薄，翻炒时火候要快，保证牛肉口感鲜嫩。调味时，蚝油和酱油的比例也要适合自己的口味。
"""</span>

<span class="token keyword">def</span> <span class="token function">summarize</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> max_tokens<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> openai<span class="token punctuation">.</span>Completion<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
        model<span class="token operator">=</span>COMPLETIONS_MODEL<span class="token punctuation">,</span>
        prompt<span class="token operator">=</span>text <span class="token operator">+</span> <span class="token string">"\n\n请总结一下上面User和Assistant聊了些什么：\n"</span><span class="token punctuation">,</span>
        max_tokens<span class="token operator">=</span>max_tokens<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> response<span class="token punctuation">[</span><span class="token string">"choices"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span>

summarized <span class="token operator">=</span> summarize<span class="token punctuation">(</span>history<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>summarized<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出结果：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">User和Assistant聊了鱼香肉丝和蚝油牛肉的制作方法。User问了Assistant两个关于如何做鱼香肉丝和蚝油牛肉的问题，Assistant给出了回答并介绍了每道菜的具体制作方法，同时也提示了调料的配比和牛肉制作时要注意的细节。
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol>
<li>然后，我们再新建一个Conversation，这次的提示语里，我们先加上了总结的内容，然后告诉AI把对话继续下去。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">prompt <span class="token operator">=</span> summarized <span class="token operator">+</span> <span class="token string">"\n\n请你根据已经聊了的内容，继续对话："</span>
conversation <span class="token operator">=</span> Conversation<span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>

question <span class="token operator">=</span> <span class="token string">"那宫保鸡丁呢？"</span>
answer <span class="token operator">=</span> conversation<span class="token punctuation">.</span>ask<span class="token punctuation">(</span>question<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"User : %s"</span> <span class="token operator">%</span> question<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Assistant : %s\n"</span> <span class="token operator">%</span> answer<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意，如果你是在Notebook里面执行的话，你需要把上一讲的Conversation类的代码复制过来先执行一下。这里，我们启动了一个新的对话对象，将之前的几轮对话的内容总结了一下，放在Prompt的最前面，然后让AI根据已经聊了的内容，继续往下聊。</p>
<ol>
<li><p>当我们直接问，“那宫保鸡丁呢？”，AI会正确回答出宫保鸡丁的做法。</p>
<p>输出结果：</p>
</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">User <span class="token punctuation">:</span> 那宫保鸡丁呢？
Assistant <span class="token punctuation">:</span> 宫保鸡丁的制作方法也比较简单。首先，将鸡肉切成小丁状，用料酒、盐、生抽腌制一下。然后将青椒、红椒、葱姜蒜切成丁状备用。接着，将花生米炒香备用。
热锅凉油，油温七成热时放入鸡丁煸炒至变色，捞出备用。再将葱姜蒜爆香，加入青红椒丁翻炒一下，然后加入鸡丁，翻炒均匀。最后加入适量的糖、盐、醋、生抽、老抽、料酒、水淀粉炒匀，最后加入炒香的花生米即可。
需要注意的是，炒鸡丁的时候要用大火，这样鸡肉会更嫩。另外，调料的配比也很关键，需要根据个人口味适量调整。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>而如果我们没有加上AI总结的之前的对话，只是让AI对话，它只能和你闲扯一些别的。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">conversation <span class="token operator">=</span> Conversation<span class="token punctuation">(</span><span class="token string">"请你根据已经聊了的内容，继续对话："</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>

question <span class="token operator">=</span> <span class="token string">"那宫保鸡丁呢？"</span>
answer <span class="token operator">=</span> conversation<span class="token punctuation">.</span>ask<span class="token punctuation">(</span>question<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"User : %s"</span> <span class="token operator">%</span> question<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Assistant : %s\n"</span> <span class="token operator">%</span> answer<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出结果：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">User <span class="token punctuation">:</span> 那宫保鸡丁呢？
Assistant <span class="token punctuation">:</span> 宫保鸡丁是一道非常有名的川菜，口感麻辣鲜香，非常美味。你喜欢吃辣的食物吗？
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>如果没有给它已经总结了的内容，AI只会和你瞎扯，告诉你宫保鸡丁很好吃。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>不知道今天教的这些技巧你学会了吗？这一讲里，我们先是快速实验了一下通过Embedding拿到的向量进行文本聚类。对于聚类的结果，我们不用再像以前那样人工看成百上千条数据，然后拍个脑袋给这个类取个名字。我们直接利用了Completion接口可以帮我们总结内容的能力，给分类取了一个名字。从最终的效果来看，还算不错。</p>
<p>而类似的技巧，也可以用在多轮的长对话中。我们将历史对话，让AI总结成一小段文本放到提示语里面。这样既能够让AI记住过去的对话内容，又不会因为对话越来越长而超出模型可以支持的Token数量。这个技巧也是使用大语言模型的一种常见模式。</p>
<h2 id="课后练习"><a href="#课后练习" class="headerlink" title="课后练习"></a>课后练习</h2><ol>
<li>这一讲里，我们使用了让AI概括聚类文本内容和聊天记录的提示语。你自己在体验GPT系列模型的时候，有什么觉得特别有用的提示语吗？欢迎你分享自己的体验。</li>
<li>在文本聚类里面，有三个聚合出来的类，和原先的分组没有很明显的对应关系。你能利用现在学到的知识，写一些代码看看数据，研究一下是为什么吗？</li>
</ol>
<p>期待能在评论区看到你的思考，也欢迎你把这节课分享给感兴趣的朋友，我们下一讲再见。</p>
</article><div class="tag_share"><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#07%EF%BD%9C%E6%96%87%E6%9C%AC%E8%81%9A%E7%B1%BB%E4%B8%8E%E6%91%98%E8%A6%81%EF%BC%8C%E8%AE%A9AI%E5%B8%AE%E4%BD%A0%E5%81%9A%E4%B8%AA%E6%80%BB%E7%BB%93"><span class="toc-number">1.</span> <span class="toc-text">07｜文本聚类与摘要，让AI帮你做个总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EEmbedding%E5%90%91%E9%87%8F%E8%BF%9B%E8%A1%8C%E6%96%87%E6%9C%AC%E8%81%9A%E7%B1%BB"><span class="toc-number">1.1.</span> <span class="toc-text">基于Embedding向量进行文本聚类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%8F%90%E7%A4%BA%E8%AF%AD%E5%AF%B9%E6%96%87%E6%9C%AC%E8%BF%9B%E8%A1%8C%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.</span> <span class="toc-text">使用提示语对文本进行总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%87%E6%9C%AC%E6%91%98%E8%A6%81%E6%94%AF%E6%8C%81%E6%97%A0%E9%99%90%E8%BD%AE%E6%95%B0%E7%9A%84%E8%81%8A%E5%A4%A9"><span class="toc-number">1.3.</span> <span class="toc-text">利用文本摘要支持无限轮数的聊天</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.4.</span> <span class="toc-text">小结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BE%E5%90%8E%E7%BB%83%E4%B9%A0"><span class="toc-number">1.5.</span> <span class="toc-text">课后练习</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By 码农张三</div></div><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/9.4.0/mermaid.min.js"></script></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div></div></body></html>