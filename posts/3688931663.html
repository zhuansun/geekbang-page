<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>12｜让AI帮你写个小插件，轻松处理Excel文件 | geekbang</title><meta name="author" content="码农张三"><meta name="copyright" content="码农张三"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="12｜让AI帮你写个小插件，轻松处理Excel文件你好，我是徐文浩。 过去的十多讲里，我为你介绍了各种利用大语言模型的方法和技巧。特别是在过去两讲里，我们也尝试更加深入地利用开源代码帮我们完成一些工作。通过llama-index这样的开源库，我们能够将自己的数据和大语言模型连接在一起。通过sentence_transformers这样的开源库和ChatGLM这样的开源大语言模型，不依赖OpenAI">
<meta property="og:type" content="article">
<meta property="og:title" content="12｜让AI帮你写个小插件，轻松处理Excel文件">
<meta property="og:url" content="https://zhuansun.github.io/geekbang/posts/3688931663.html">
<meta property="og:site_name" content="geekbang">
<meta property="og:description" content="12｜让AI帮你写个小插件，轻松处理Excel文件你好，我是徐文浩。 过去的十多讲里，我为你介绍了各种利用大语言模型的方法和技巧。特别是在过去两讲里，我们也尝试更加深入地利用开源代码帮我们完成一些工作。通过llama-index这样的开源库，我们能够将自己的数据和大语言模型连接在一起。通过sentence_transformers这样的开源库和ChatGLM这样的开源大语言模型，不依赖OpenAI">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg">
<meta property="article:published_time" content="2023-10-20T09:48:40.000Z">
<meta property="article:modified_time" content="2024-03-21T11:04:49.907Z">
<meta property="article:author" content="码农张三">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhuansun.github.io/geekbang/posts/3688931663"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '12｜让AI帮你写个小插件，轻松处理Excel文件',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-21 11:04:49'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="geekbang" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://pic.imgdb.cn/item/653470a0c458853aef5813f1.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">1345</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">23</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">geekbang</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">12｜让AI帮你写个小插件，轻松处理Excel文件</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-10-20T09:48:40.000Z" title="发表于 2023-10-20 09:48:40">2023-10-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AI%E5%A4%A7%E6%A8%A1%E5%9E%8B%E4%B9%8B%E7%BE%8E/">AI大模型之美</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="12｜让AI帮你写个小插件，轻松处理Excel文件"><a href="#12｜让AI帮你写个小插件，轻松处理Excel文件" class="headerlink" title="12｜让AI帮你写个小插件，轻松处理Excel文件"></a>12｜让AI帮你写个小插件，轻松处理Excel文件</h1><p>你好，我是徐文浩。</p>
<p>过去的十多讲里，我为你介绍了各种利用大语言模型的方法和技巧。特别是在过去两讲里，我们也尝试更加深入地利用开源代码帮我们完成一些工作。通过llama-index这样的开源库，我们能够将自己的数据和大语言模型连接在一起。通过sentence_transformers这样的开源库和ChatGLM这样的开源大语言模型，不依赖OpenAI，我们也可以完成简单的电商FAQ的问答。</p>
<p>不过，这里面的代码，都是我们自己写的。虽然我们已经用了像Colab这样的在线Notebook工具，但是这些对非技术人员来说还是有一些门槛的。如果想要让广告投放、产品运营的同事们用起来，我们还需要专门做一个适合他们习惯的界面。</p>
<p>其实，普通业务人员最常用的界面就是像Excel或者Chrome浏览器这样人手一个的应用。而且这些产品都有自己的插件机制。那么今天，我们就来为Excel写一个插件，让业务人员不需要懂代码也能随时使用ChatGPT来辅助完成工作，提高效率。而且，这个插件的代码也不是由我们自己来写，而是让ChatGPT来帮我们写。 <strong>在这个过程中，你会看到我们如何利用ChatGPT逐步探索，使用我们并不熟悉，甚至完全不会的编程语言和工具完成任务。</strong></p>
<p><strong>所以这一讲，不是一堂技能课，而是一堂方法和思维课。</strong></p>
<h2 id="让我们再来看看那只发光的青蛙"><a href="#让我们再来看看那只发光的青蛙" class="headerlink" title="让我们再来看看那只发光的青蛙"></a>让我们再来看看那只发光的青蛙</h2><p>在课程的 <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/641742">第 1 讲</a> 里面，我就给你举过一个例子。我们使用ChatGPT的API，在一个商品上实现了标题翻译、卖点撰写和售价预估的功能。这个需求，其实是很多跨境电商的运营人员都能用上的。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/904194dc1f1c932735fd058a2f5dd7b5.png" alt="图片"></p>
<p>代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> openai
<span class="token keyword">import</span> os

openai<span class="token punctuation">.</span>api_key <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"OPENAI_API_KEY"</span><span class="token punctuation">)</span>
COMPLETION_MODEL <span class="token operator">=</span> <span class="token string">"text-davinci-003"</span>

prompt <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
Consideration proudct : 工厂现货PVC充气青蛙夜市地摊热卖充气玩具发光蛙儿童水上玩具

1. Compose human readable product title used on Amazon in english within 20 words.
2. Write 5 selling points for the products in Amazon.
3. Evaluate a price range for this product in U.S.

Output the result in json format with three properties called title, selling_points and price_range
"""</span>

<span class="token keyword">def</span> <span class="token function">get_response</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    completions <span class="token operator">=</span> openai<span class="token punctuation">.</span>Completion<span class="token punctuation">.</span>create <span class="token punctuation">(</span>
        engine<span class="token operator">=</span>COMPLETION_MODEL<span class="token punctuation">,</span>
        prompt<span class="token operator">=</span>prompt<span class="token punctuation">,</span>
        max_tokens<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>
        n<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
        stop<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
        temperature<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    message <span class="token operator">=</span> completions<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text
    <span class="token keyword">return</span> message

<span class="token keyword">print</span><span class="token punctuation">(</span>get_response<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出结果：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span>
    <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Glow-in-the-Dark Inflatable PVC Frog Night Market Hot Selling Water Toy for Kids"</span><span class="token punctuation">,</span>
    <span class="token string">"selling_points"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"Made of durable PVC material"</span><span class="token punctuation">,</span>
        <span class="token string">"Glow-in-the-dark design for night play"</span><span class="token punctuation">,</span>
        <span class="token string">"Inflatable design for easy storage and transport"</span><span class="token punctuation">,</span>
        <span class="token string">"Perfect for water play and outdoor activities"</span><span class="token punctuation">,</span>
        <span class="token string">"Great gift for kids"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"price_range"</span><span class="token punctuation">:</span> <span class="token string">"$10 - $20"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是，让运营人员去学会用Python写程序，的确门槛还是太高了。但是，如果每件商品都把同样的提示语往ChatGPT的界面里复制粘贴，效率又太低了一点。那这个时候，其实Excel就是一个很好的选择了。</p>
<p>我们的需求很简单，就是想把所有想要翻译和寻找卖点的商品标题，都放在Excel文件的第一列里面，然后让AI根据我们的需要填后面几列就好了。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/ae88eee99751e5781901e43d8b79edc0.png" alt="图片"></p>
<p>不过，其实我和你一样，并没有写过Excel的插件。所以虽然我知道这事儿大概是可以做到的，但是具体怎么做，我也只能来问问ChatGPT。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/589cf7be4f2819dcf559fe09ea4e2542.png" alt="图片"></p>
<p>我直接把这个需求扔给了ChatGPT，请它直接为我写个插件。我输入了一句提示语。</p>
<p>提示语：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">请你帮我写一个Excel插件，能够将商品标题翻译成英文，寻找商品里面的卖点，以及确定商品的售价
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可惜，答案不尽如人意。ChatGPT不仅只是泛泛地告诉我们可以用翻译的API，而且它在自然语言处理部分，还编造了一段代码。它实际介绍的NLTK，spaCy等等，都是Python的开源库，是没有VBA代码的。</p>
<p>不过，尽管这个回答并不是正确答案，但它还是给我们提供了一个很有用的信息，那就是Excel里我们可以通过VBA来运行程序。这其实也是我们使用ChatGPT这样的AI助理的时候需要注意的一点，我们并不要求它一次做对，只要每次能让我们离答案更近了一点点就好了。</p>
<h2 id="先来试一试简单的插件任务"><a href="#先来试一试简单的插件任务" class="headerlink" title="先来试一试简单的插件任务"></a>先来试一试简单的插件任务</h2><p>知道了Excel可以通过VBA来执行程序，我们就先通过它来写一个最简单的功能，来试试整个流程是否可以走通。所以，我给了AI这样一个指令。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">请你为我写一个Excel的VBA插件，它会将表格里面的第一列的内容，复制到第二列
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这一次，ChatGPT没有和我打官腔，而是直接给出了详细的代码，以及如何在Excel里面执行的步骤。</p>
<p>我也把下面截图中对应的整个对话分享到了ShareGPT里，你可以直接点击 <a target="_blank" rel="noopener" href="https://shareg.pt/pGYAz2p">链接</a> 查看完整的操作方式。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/bd4c4d935cf1b85ee70393b914b5f2bf.png" alt="图片"></p>
<p>代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">Sub CopyFirstColumnToSecondColumn<span class="token punctuation">(</span><span class="token punctuation">)</span>
    '获取第一列和第二列的范围
    Dim firstColumn As Range
    Dim secondColumn As Range
    Set firstColumn <span class="token operator">=</span> Range<span class="token punctuation">(</span><span class="token string">"A1:A"</span> <span class="token operator">&amp;</span> Cells<span class="token punctuation">(</span>Rows<span class="token punctuation">.</span>Count<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>End<span class="token punctuation">(</span>xlUp<span class="token punctuation">)</span><span class="token punctuation">.</span>Row<span class="token punctuation">)</span>
    Set secondColumn <span class="token operator">=</span> Range<span class="token punctuation">(</span><span class="token string">"B1:B"</span> <span class="token operator">&amp;</span> Cells<span class="token punctuation">(</span>Rows<span class="token punctuation">.</span>Count<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>End<span class="token punctuation">(</span>xlUp<span class="token punctuation">)</span><span class="token punctuation">.</span>Row<span class="token punctuation">)</span>

    '复制第一列到第二列
    secondColumn<span class="token punctuation">.</span>Value <span class="token operator">=</span> firstColumn<span class="token punctuation">.</span>Value
End Sub
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>根据ChatGPT给出的详细操作步骤，我们可以通过快捷键 ALT + F11 打开Excel下的VBA编辑器，然后把对应的Excel代码复制进去；也能够在Excel的表格界面里，通过快捷键 ALT + F8 唤起宏的对话框，执行这段宏。你可以试一下，这段VBA的宏的确能够将我们表格里面的第一列，复制到第二列里面。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/b43b7c4db886bb08a917534547c3038f.png" alt="图片"></p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/4f983f3848bf1c3894326214f7b1b43c.png" alt="图片"></p>
<p>虽然这段代码的功能非常简单，但是它帮助我们走通了一个基本路径，就是 <strong>怎么在Excel里面撰写VBA代码并且执行</strong>。这种方法也是使用AI写代码时一个常用的方式，我们先通过一些简单的任务来试一试，看看AI是否能把路径走通，还是说它只会胡扯。如果能够走通的话，意味着我们又朝最终答案靠近了一步。而如果是胡扯的话，你也可以早点另请高明。</p>
<h2 id="拆解想要完成的代码功能，分步骤让AI完成程序"><a href="#拆解想要完成的代码功能，分步骤让AI完成程序" class="headerlink" title="拆解想要完成的代码功能，分步骤让AI完成程序"></a>拆解想要完成的代码功能，分步骤让AI完成程序</h2><p>在试过VBA代码能在Excel里正常运行之后，我们就可以开始尝试让ChatGPT帮我们写正式的代码了。这一次，我们不能和一开始一样，随便给它一个模糊的需求，而是应该拆解一下需求。在提示词里，更准确地描述我们希望ChatGPT写出的代码完成什么功能，包括我们希望它使用的具体步骤和方法。这样，它才有可能写出正确的代码。所以这一次我给到的提示语是这样的。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">请为我写这样一段在Excel里面运行的VBA程序：
<span class="token number">1.</span> 读取表格里面的第一列的内容
<span class="token number">2.</span> 内容的每一行，都是一个商品标题。对这个商品标题，通过下面的Prompt，调用OpenAI的API拿到返回结果：
<span class="token triple-quoted-string string">"""
Consideration proudct : 商品标题
1. Compose human readable product title used on Amazon in english within 20 words.
2. Write 5 selling points for the products in Amazon.
3. Evaluate a price range for this product in U.S.
Output the result in json format with three properties called title, selling_points and price_range
"""</span>
<span class="token number">3.</span> 将对应API的返回结果，插入到表格的第二列里
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>生成的代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">Option Explicit
Sub GetOpenAIResults<span class="token punctuation">(</span><span class="token punctuation">)</span>

    'Declare variables
    Dim wb As Workbook
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim i As Long
    Dim productTitle As String
    Dim sellingPoints As String
    Dim priceRange As String
    Dim outputJSON As String
    Dim response As String
    Dim request As Object
    Dim url As String
    Dim apiKey As String

    'Set variables
    Set wb <span class="token operator">=</span> ThisWorkbook
    Set ws <span class="token operator">=</span> wb<span class="token punctuation">.</span>ActiveSheet
    lastRow <span class="token operator">=</span> ws<span class="token punctuation">.</span>Cells<span class="token punctuation">(</span>ws<span class="token punctuation">.</span>Rows<span class="token punctuation">.</span>Count<span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>End<span class="token punctuation">(</span>xlUp<span class="token punctuation">)</span><span class="token punctuation">.</span>Row
    apiKey <span class="token operator">=</span> <span class="token string">"YOUR_OPENAI_API_KEY"</span>
    url <span class="token operator">=</span> <span class="token string">"https://api.openai.com/v1/engines/davinci-codex/completions"</span>

    'Loop through each row <span class="token keyword">in</span> column A
    For i <span class="token operator">=</span> <span class="token number">1</span> To lastRow

        'Get the product title <span class="token keyword">from</span> column A
        productTitle <span class="token operator">=</span> ws<span class="token punctuation">.</span>Cells<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value

        'Set up the OpenAI API request
        Set request <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"MSXML2.XMLHTTP"</span><span class="token punctuation">)</span>
        request<span class="token punctuation">.</span>Open <span class="token string">"POST"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">False</span>
        request<span class="token punctuation">.</span>setRequestHeader <span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span>
        request<span class="token punctuation">.</span>setRequestHeader <span class="token string">"Authorization"</span><span class="token punctuation">,</span> <span class="token string">"Bearer "</span> <span class="token operator">&amp;</span> apiKey

        'Send the request to OpenAI API
        request<span class="token punctuation">.</span>send <span class="token string">"&#123;"</span><span class="token string">"prompt"</span><span class="token string">": "</span><span class="token string">"Consideration proudct : "</span> <span class="token operator">&amp;</span> productTitle <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"1. Compose human readable product title used on Amazon in english within 20 words."</span> <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"2. Write 5 selling points for the products in Amazon."</span> <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"3. Evaluate a price range for this product in U.S."</span> <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"Output the result in json format with three properties called title, selling_points and price_range"</span><span class="token string">","</span><span class="token string">"temperature"</span><span class="token string">": 0.7,"</span><span class="token string">"max_tokens"</span><span class="token string">": 1024&#125;"</span>

        'Get the response <span class="token keyword">from</span> OpenAI API
        response <span class="token operator">=</span> request<span class="token punctuation">.</span>responseText

        'Extract the title<span class="token punctuation">,</span> selling points<span class="token punctuation">,</span> <span class="token keyword">and</span> price <span class="token builtin">range</span> <span class="token keyword">from</span> the response
        productTitle <span class="token operator">=</span> ExtractJSONValue<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"title"</span><span class="token punctuation">)</span>
        sellingPoints <span class="token operator">=</span> ExtractJSONValue<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"selling_points"</span><span class="token punctuation">)</span>
        priceRange <span class="token operator">=</span> ExtractJSONValue<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"price_range"</span><span class="token punctuation">)</span>

        'Create the JSON output string
        outputJSON <span class="token operator">=</span> <span class="token string">"&#123;"</span><span class="token string">"title"</span><span class="token string">": "</span><span class="token string">""</span> <span class="token operator">&amp;</span> productTitle <span class="token operator">&amp;</span> <span class="token triple-quoted-string string">""",""selling_points"": """</span> <span class="token operator">&amp;</span> sellingPoints <span class="token operator">&amp;</span> <span class="token triple-quoted-string string">""",""price_range"": """</span> <span class="token operator">&amp;</span> priceRange <span class="token operator">&amp;</span> <span class="token triple-quoted-string string">"""&#125;"

        'Insert the JSON output into column B
        ws.Cells(i, 2).Value = outputJSON

    Next i

End Sub
Function ExtractJSONValue(jsonString As String, key As String) As String

    'Declare variables
    Dim jsonRegex As Object
    Dim matchCollection As Object
    Dim match As Object

    'Set variables
    Set jsonRegex = CreateObject("VBScript.RegExp")
    jsonRegex.Global = True
    jsonRegex.Pattern = """</span><span class="token string">" &amp; key &amp; "</span><span class="token string">""</span>\s<span class="token operator">*</span><span class="token punctuation">:</span>\s<span class="token operator">*</span><span class="token string">""</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">^</span><span class="token string">""</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">)</span><span class="token string">""</span>"
    Set matchCollection <span class="token operator">=</span> jsonRegex<span class="token punctuation">.</span>Execute<span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span>

    'Check <span class="token keyword">if</span> the key was found <span class="token keyword">in</span> the JSON string
    If matchCollection<span class="token punctuation">.</span>Count <span class="token operator">></span> <span class="token number">0</span> Then
        Set <span class="token keyword">match</span> <span class="token operator">=</span> matchCollection<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        ExtractJSONValue <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>SubMatches<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    Else
        ExtractJSONValue <span class="token operator">=</span> <span class="token string">""</span>
    End
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ChatGPT这一次生成了一大堆的代码，我们也不知道对不对。不过可以先把它复制到我们的Excel里，然后做一件事情，就是把代码里面，写着“YOUR_OPENAI_API_KEY”的地方，换成我们自己的Key，不然程序是不会运行通过的。然后，我们就可以再次尝试通过ALT+F8唤起并运行这个宏了。</p>
<p>不过，在运行代码之前需要注意，如果你的Excel里面有很多重要的数据，你最好是备份好你的数据再来运行。毕竟，我们没有仔细审核过ChatGPT写出来的代码，只是简单地复制粘贴。要是它对我们的数据造成什么破坏，那可就得不偿失了。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/7d338fd60f7e2223e9d5ab5bb4e1a677.png" alt="图片"></p>
<p>不过，这一次我们运气不太好，程序没有运行成功，还报错了。我们的Excel里面出现了一个VBA的弹窗，有一段错误消息：“缺少 End Function”。我上一次写VBA代码，可能还要追溯到2005年在微软当实习生的时候。所以看到这个报错，我也没法立刻知道该怎么解决。</p>
<p>不过这个代码是ChatGPT写的，那出了错也应该让它负责。我们直接把对应的错误信息，填到ChatGPT的对话窗口里，让它看看怎么解决。这一次，它还挺礼貌，意识到了自己的错误，给出的代码里面缺少了“End Function”。所以，它会重新生成一份语法没有问题的代码给到我们。</p>
<p>提示语：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">缺少End Function
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>代码：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">……
    Else
        ExtractJSONValue = ""
    End If

End Function
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注：整个对话参见链接 <a target="_blank" rel="noopener" href="https://sharegpt.com/c/joQQj7P">https://sharegpt.com/c/joQQj7P</a></p>
<p>我们再把新的代码贴到VBA编辑器里面，再重新运行一次。这一次，程序运行通过了。但是，还是没有得到我们想要的结果。在第二列里，我们看到的是只有JSON结构，没有实际内容的JSON字符串。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/7192204874d2b38b1a50bea79ec2045f.png" alt="图片"></p>
<p>输出结果：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">&#123;"title": "","selling_points": "","price_range": ""&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这个时候，我们就得先停下来，回头看看ChatGPT生成的代码到底干了些什么。虽然我们并不熟悉VBA的语法，但是如果你稍微有些编程的知识和经验，根据现在的代码其实大概就能够知道ChatGPT的这个程序是怎么回事儿了，现在我们就来把它拆解开。</p>
<ol>
<li>整个程序由两个函数组成，GetOpenAIResults 是主函数，是程序的主体执行结构。ExtractJSONValue是一个功能函数，从API调用的返回结果里面，通过正则表达式去提取返回结果里面的内容。</li>
<li>GetOpenAIResults这个主函数的结构也非常简单，除了一开始的一系列变量定义，其实就是做了这样几件事情。</li>
</ol>
<ul>
<li>通过一个For循环，遍历第一列单元格里面的值。</li>
<li>对每一个值，都构造了一个HTTP的请求，调用OpenAI的API。</li>
<li>对于拿到的返回结果，通过ExtractJSONValue函数提取里面的内容，然后再重新拼装成一个JSON。</li>
<li>最终将这个outputJSON的输出结果，填到第二列的单元格里面。</li>
</ul>
<p>理解了代码的整体含义，还有拿到的输出结果，我们就有了调查问题的方向。我们想要看看在调用完OpenAI的API之后，拿到的返回结果是什么。看看是调用出错了，还是解析返回结果出错了？</p>
<p>于是，我们把 GetOpenAIResults 函数最后填入第二列单元格的代码修改一下，把调用OpenAI的API拿到的返回结果，填到第三列里。修改完之后，我们重新运行宏，看看第三列里的返回结果是什么。</p>
<p>代码：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">……
        ws.Cells(i, 2).Value = outputJSON
        ws.Cells(i, 3).Value = response
……
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出结果：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">&#123;
    "error": &#123;
        "message": "We could not parse the JSON body of your request. (HINT: This likely means you aren't using your HTTP library correctly. The OpenAI API expects a JSON payload, but what was sent was not valid JSON. If you have trouble figuring out how to fix this, please send an email to support@openai.com and include any relevant code you'd like help with.)",
        "type": "invalid_request_error",
        "param": null,
        "code": null
    &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从这个输出结果里面看到，错误信息是说，OpenAI不能够解析我们输入的JSON Body。那么，我们就再修改一下代码，把我们输入的JSON放到第四列里，看看是不是这部分代码ChatGPT写错了。</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">……
        'Send the request to OpenAI API
        requestJSON = "&#123;""prompt"": ""Consideration proudct : " &amp; productTitle &amp; vbNewLine &amp; "1. Compose human readable product title used on Amazon in english within 20 words." &amp; vbNewLine &amp; "2. Write 5 selling points for the products in Amazon." &amp; vbNewLine &amp; "3. Evaluate a price range for this product in U.S." &amp; vbNewLine &amp; vbNewLine &amp; "Output the result in json format with three properties called title, selling_points and price_range"",""temperature"": 0.7,""max_tokens"": 1024&#125;"
        request.send requestJSON
        'Get the response from OpenAI API
        response = request.responseText
……
        'Insert the JSON output into column B
        ws.Cells(i, 2).Value = outputJSON
        ws.Cells(i, 3).Value = response
        ws.Cells(i, 4).Value = requestJSON
……
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个时候我们尝试运行代码的话，VBA会提示我们“变量未定义”的报错。这是因为VBA的语法规定，所有的变量在赋值之前都需要先单独定义，所以我们还需要在代码一开始变量定义的部分，加上requestJSON的变量定义。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/952ee39f4297a9165ca942c713ba8088.png" alt="图片"></p>
<p>代码：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">……
    Dim apiKey As String
    Dim requestJSON As String

    'Set variables
……
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后我们重新运行代码，就会在第四列里，得到我们输入的JSON数据。我们肉眼看不出这个JSON是不是合法，只能尝试让ChatGPT帮我们看一下这个JSON是否合法了。不过ChatGPT告诉我们这个JSON是合法的，这个时候，我们又一次陷入了僵局。</p>
<p>JSON数据：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">&#123;"prompt": "Consideration proudct : 工厂现货PVC充气青蛙夜市地摊热卖充气玩具发光蛙儿童水上玩具
1. Compose human readable product title used on Amazon in english within 20 words.
2. Write 5 selling points for the products in Amazon.
3. Evaluate a price range for this product in U.S.

Output the result in json format with three properties called title, selling_points and price_range","temperature": 0.7,"max_tokens": 1024&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/e1c981fe33dda7a93067049031515f53.png" alt="图片"></p>
<h2 id="简化问题寻找思路"><a href="#简化问题寻找思路" class="headerlink" title="简化问题寻找思路"></a>简化问题寻找思路</h2><p>我们并不擅长撰写VBA应用，所以这个时候，我们的思路还是要 <strong>把问题简化。</strong> 我们拿一个最简单的JSON来向OpenAI发起请求，看看结果是不是还会报出相同的错误。</p>
<pre class="line-numbers language-vbnet" data-language="vbnet"><code class="language-vbnet">……
        <span class="token comment">'Send the request to OpenAI API</span>
        requestJSON <span class="token operator">=</span> <span class="token string">"&#123;""prompt"": ""Consideration proudct : "</span> <span class="token operator">&amp;</span> productTitle <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"1. Compose human readable product title used on Amazon in english within 20 words."</span> <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"2. Write 5 selling points for the products in Amazon."</span> <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"3. Evaluate a price range for this product in U.S."</span> <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"Output the result in json format with three properties called title, selling_points and price_range"",""temperature"": 0.7,""max_tokens"": 1024&#125;"</span>
        requestJSON <span class="token operator">=</span> <span class="token string">"&#123;""prompt"": ""How are you?""&#125;"</span>
        request.send requestJSON
        <span class="token comment">'Get the response from OpenAI API</span>
        response <span class="token operator">=</span> request.responseText
……
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>修改之后，我们发现，API调用的返回结果虽然还是个报错。但是这个报错变了，而且这个报错我们看得懂了。</p>
<p>Excel里面的response内容：</p>
<pre class="line-numbers language-vbnet" data-language="vbnet"><code class="language-vbnet"><span class="token punctuation">&#123;</span>
    <span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"The model: `davinci-codex` does not exist"</span><span class="token punctuation">,</span>
        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"invalid_request_error"</span><span class="token punctuation">,</span>
        <span class="token string">"param"</span><span class="token punctuation">:</span> null<span class="token punctuation">,</span>
        <span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token string">"model_not_found"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个报错告诉我们，对应的davinci-codex模型不存在。的确，最近OpenAI把CodeX的模型下线了，那我们就把模型修改成text-davinci-003这个我们之前常用的模型。</p>
<pre class="line-numbers language-vbnet" data-language="vbnet"><code class="language-vbnet">    url <span class="token operator">=</span> <span class="token string">"https://api.openai.com/v1/engines/text-davinci-003/completions"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后我们再重新运行一下代码，这时，我们第一次拿到了一个正确的来自AI的回复。</p>
<pre class="line-numbers language-vbnet" data-language="vbnet"><code class="language-vbnet"><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span><span class="token string">"cmpl-70ZEVctFduMnv6D1WIz4iffTZdaGl"</span><span class="token punctuation">,</span><span class="token string">"object"</span><span class="token punctuation">:</span><span class="token string">"text_completion"</span><span class="token punctuation">,</span><span class="token string">"created"</span><span class="token punctuation">:</span><span class="token number">1680369791</span><span class="token punctuation">,</span><span class="token string">"model"</span><span class="token punctuation">:</span><span class="token string">"text-davinci-003"</span><span class="token punctuation">,</span><span class="token string">"choices"</span><span class="token punctuation">:</span>[<span class="token punctuation">&#123;</span><span class="token string">"text"</span><span class="token punctuation">:</span><span class="token string">"\n\nI'm doing well, thanks for asking!"</span><span class="token punctuation">,</span><span class="token string">"index"</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"logprobs"</span><span class="token punctuation">:</span>null<span class="token punctuation">,</span><span class="token string">"finish_reason"</span><span class="token punctuation">:</span><span class="token string">"stop"</span><span class="token punctuation">&#125;</span>]<span class="token punctuation">,</span><span class="token string">"usage"</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span><span class="token string">"prompt_tokens"</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">"completion_tokens"</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string">"total_tokens"</span><span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>不过这个返回内容，针对的还是我们刚才构造的最简单的Prompt：“How are you?”的回答，我们把使用的JSON切换回去，再运行一下，看看结果是怎么样的。</p>
<pre class="line-numbers language-vbnet" data-language="vbnet"><code class="language-vbnet">……
        <span class="token comment">'Send the request to OpenAI API</span>
        requestJSON <span class="token operator">=</span> <span class="token string">"&#123;""prompt"": ""Consideration proudct : "</span> <span class="token operator">&amp;</span> productTitle <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"1. Compose human readable product title used on Amazon in english within 20 words."</span> <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"2. Write 5 selling points for the products in Amazon."</span> <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"3. Evaluate a price range for this product in U.S."</span> <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"Output the result in json format with three properties called title, selling_points and price_range"",""temperature"": 0.7,""max_tokens"": 1024&#125;"</span>
        request.send requestJSON
        <span class="token comment">'Get the response from OpenAI API</span>
        response <span class="token operator">=</span> request.responseText
……
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>不幸的是，这一次我们还是拿到了一段和之前相同的报错，告诉我们JSON的格式解析不了。</p>
<pre class="line-numbers language-vbnet" data-language="vbnet"><code class="language-vbnet"><span class="token punctuation">&#123;</span>
    <span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"We could not parse the JSON body of your request. (HINT: This likely means you aren't using your HTTP library correctly. The OpenAI API expects a JSON payload, but what was sent was not valid JSON. If you have trouble figuring out how to fix this, please send an email to support@openai.com and include any relevant code you'd like help with.)"</span><span class="token punctuation">,</span>
        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"invalid_request_error"</span><span class="token punctuation">,</span>
        <span class="token string">"param"</span><span class="token punctuation">:</span> null<span class="token punctuation">,</span>
        <span class="token string">"code"</span><span class="token punctuation">:</span> null
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是这个时候，我们已经不慌了。因为我们之前已经用一个简单的JSON拿到了ChatGPT的正确回答。所以，我们可以确定，的确现在的JSON是有问题的。我们只要能够找到这个JSON的格式问题，相信我们离正确答案就不远了。</p>
<p>既然AI前面说这个JSON格式是合法的，那我们就不妨让它来给我们生成一个同样内容的VBA的JSON字符串好了，我们也把问题简化，只关心我们的Prompt部分。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/ca85d83b3a6fe8212a756fb50a3cf4e6.png" alt="图片"></p>
<p>然后我们再修改一下VBA代码，重新运行一次。</p>
<pre class="line-numbers language-vbnet" data-language="vbnet"><code class="language-vbnet">……
        <span class="token comment">'Send the request to OpenAI API</span>
        requestJSON <span class="token operator">=</span> <span class="token string">"&#123;""prompt"": ""Consideration proudct : "</span> <span class="token operator">&amp;</span> productTitle <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"1. Compose human readable product title used on Amazon in english within 20 words."</span> <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"2. Write 5 selling points for the products in Amazon."</span> <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"3. Evaluate a price range for this product in U.S."</span> <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> vbNewLine <span class="token operator">&amp;</span> <span class="token string">"Output the result in json format with three properties called title, selling_points and price_range"",""temperature"": 0.7,""max_tokens"": 1024&#125;"</span>
        requestJSON <span class="token operator">=</span> <span class="token string">"&#123;""prompt"": ""Consideration proudct : 工厂现货PVC充气青蛙夜市地摊热卖充气玩具发光蛙儿童水上玩具\r\n1. Compose human readable product title used on Amazon in english within 20 words.\r\n2. Write 5 selling points for the products in Amazon.\r\n3. Evaluate a price range for this product in U.S.\r\n\r\nOutput the result in json format with three properties called title, selling_points and price_range""&#125;"</span>
        request.send requestJSON
        <span class="token comment">'Get the response from OpenAI API</span>
        response <span class="token operator">=</span> request.responseText
……
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而这么一运行，我们就得到了一个正常的、有意义的JSON返回值。那这个时候，对于问题的定位就进一步缩小了。我们只要看看上下两个字符串有什么不一样就好了。仔细观察一下，你就会发现，上下两边使用的换行符不一样。上面使用的是 vbnewline，而下面使用的是\r\n。那我们就把上面的换行符设成和下面完全一致的，再来试试看。</p>
<pre class="line-numbers language-vbnet" data-language="vbnet"><code class="language-vbnet">……
        requestJSON <span class="token operator">=</span> <span class="token string">"&#123;""prompt"": ""Consideration proudct : "</span> <span class="token operator">&amp;</span> productTitle <span class="token operator">&amp;</span> <span class="token string">"\r\n1. Compose human readable product title used on Amazon in english within 20 words.\r\n2. Write 5 selling points for the products in Amazon.\r\n3. Evaluate a price range for this product in U.S.\r\n\r\nOutput the result in json format with three properties called title, selling_points and price_range.\r\n"",""temperature"": 0.7,""max_tokens"": 1024&#125;"</span>
        request.send requestJSON
……
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>再运行一次代码，这次成功了。我们在第三列拿到了一个正常的OpenAI的返回内容，里面的确有我们想要的英文标题、卖点和售价。</p>
<pre class="line-numbers language-vbnet" data-language="vbnet"><code class="language-vbnet"><span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span><span class="token string">"cmpl-70ZaUPXSb8nU39jmpNkhl59bMsG4A"</span><span class="token punctuation">,</span><span class="token string">"object"</span><span class="token punctuation">:</span><span class="token string">"text_completion"</span><span class="token punctuation">,</span><span class="token string">"created"</span><span class="token punctuation">:</span><span class="token number">1680371154</span><span class="token punctuation">,</span><span class="token string">"model"</span><span class="token punctuation">:</span><span class="token string">"text-davinci-003"</span><span class="token punctuation">,</span><span class="token string">"choices"</span><span class="token punctuation">:</span>[<span class="token punctuation">&#123;</span><span class="token string">"text"</span><span class="token punctuation">:</span><span class="token string">"\r\n\r\n&#123;\r\n    \"</span>title\<span class="token string">": \"</span>Premium Handcrafted Aromatherapy Essential Oil Diffuser\<span class="token string">", \r\n    \"</span>selling_points\<span class="token string">": [\"</span>Natural Ultrasonic Operation\<span class="token string">", \"</span><span class="token number">7</span> Colorful LED Lights\<span class="token string">", \"</span>Auto Shutoff <span class="token keyword">Timer</span>\<span class="token string">", \"</span>Whisper Quiet Operation\<span class="token string">", \"</span>Easy <span class="token keyword">to</span> Clean\<span class="token string">"], \r\n    \"</span>price_range\<span class="token string">": \"</span>$<span class="token number">25</span> <span class="token operator">-</span> $<span class="token number">50</span>\<span class="token string">"\r\n&#125;"</span><span class="token punctuation">,</span><span class="token string">"index"</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"logprobs"</span><span class="token punctuation">:</span>null<span class="token punctuation">,</span><span class="token string">"finish_reason"</span><span class="token punctuation">:</span><span class="token string">"stop"</span><span class="token punctuation">&#125;</span>]<span class="token punctuation">,</span><span class="token string">"usage"</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span><span class="token string">"prompt_tokens"</span><span class="token punctuation">:</span><span class="token number">89</span><span class="token punctuation">,</span><span class="token string">"completion_tokens"</span><span class="token punctuation">:</span><span class="token number">84</span><span class="token punctuation">,</span><span class="token string">"total_tokens"</span><span class="token punctuation">:</span><span class="token number">173</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>不过，我们的第二列数据的JSON还是没有具体内容，只有结构。不过这个时候，我们离自己想要的答案已经越来越近了。</p>
<h2 id="让AI单独写出提取函数，完成最后的程序"><a href="#让AI单独写出提取函数，完成最后的程序" class="headerlink" title="让AI单独写出提取函数，完成最后的程序"></a>让AI单独写出提取函数，完成最后的程序</h2><p>原先AI生成的解析JSON的代码，使用的是正则表达式，而不是对JSON进行反序列化。而且给运营人员用，我们也不希望再重新拼接成JSON格式。所以，这个时候我们不妨问一问ChatGPT，怎么把JSON反序列化。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/20c9a8929c24b2f458229f698430e9f7.png" alt="图片"></p>
<p>注：对应的整个对话参见链接 <a target="_blank" rel="noopener" href="https://sharegpt.com/c/rAmlkqQ">https://sharegpt.com/c/rAmlkqQ</a></p>
<p>ChatGPT给了我们示例，告诉我们可以在GitHub上找到对应的函数库。如果你按图索骥，就能在 <a target="_blank" rel="noopener" href="https://github.com/VBA-tools/VBA-JSON">VBA-JSON</a> 和 <a target="_blank" rel="noopener" href="https://github.com/VBA-tools/VBA-Dictionary">VBA-Dictionary</a> 找到我们需要的库。并且按照文档的要求，在VBA编辑器里通过 “文件”&#x3D;&gt;“导入文件” 来导入函数库。然后，我们只要按照文档的格式小小修改一下现在的代码，就能提取到我们希望得到的JSON格式了。</p>
<pre class="line-numbers language-vbnet" data-language="vbnet"><code class="language-vbnet">……
    <span class="token keyword">Dim</span> requestJSON <span class="token keyword">As</span> <span class="token keyword">String</span>
    <span class="token keyword">Dim</span> Json <span class="token keyword">As</span> <span class="token keyword">Object</span>

    <span class="token comment">'Set variables</span>
……

    <span class="token comment">'Loop through each row in column A</span>
    <span class="token keyword">For</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">To</span> lastRow
……

        <span class="token keyword">Set</span> Json <span class="token operator">=</span> JsonConverter.ParseJson<span class="token punctuation">(</span>response<span class="token punctuation">)</span>

        <span class="token comment">'Insert the JSON output into column B</span>
        ws.Cells<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> Json<span class="token punctuation">(</span><span class="token string">"choices"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">)</span>
        ws.Cells<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> response
        ws.Cells<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> requestJSON

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>再运行一下，第二列里就是我们想要的JSON了。</p>
<pre class="line-numbers language-vbnet" data-language="vbnet"><code class="language-vbnet"><span class="token punctuation">&#123;</span>  <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Glow In The Dark Inflatable PVC Frog Pool Toy For Kids"</span><span class="token punctuation">,</span>  <span class="token string">"selling_points"</span><span class="token punctuation">:</span> [      <span class="token string">"Made of durable and safe PVC material"</span><span class="token punctuation">,</span>      <span class="token string">"Inflatable and easy to store"</span><span class="token punctuation">,</span>      <span class="token string">"Comes with glow in the dark effect"</span><span class="token punctuation">,</span>      <span class="token string">"Ideal for both outdoor and indoor fun"</span><span class="token punctuation">,</span>      <span class="token string">"Perfect for kids of all ages"</span>  ]<span class="token punctuation">,</span>  <span class="token string">"price_range"</span><span class="token punctuation">:</span> <span class="token string">"$8 - $12"</span><span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>那接下来，问题就很简单了。我们只需要进一步把这个JSON字符串也解析一下，然后把title、selling_points 以及 price_range解析出来，分别放到不同的列里面就可以了。如果有想不明白怎么写的代码你还是可以继续问ChatGPT。</p>
<p>我把要修改的代码列在了下面。</p>
<pre class="line-numbers language-vbnet" data-language="vbnet"><code class="language-vbnet"><span class="token keyword">Option</span> Explicit

<span class="token keyword">Sub</span> GetOpenAIResults<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">'Declare variables</span>
    <span class="token keyword">Dim</span> wb <span class="token keyword">As</span> Workbook
    <span class="token keyword">Dim</span> ws <span class="token keyword">As</span> Worksheet
    <span class="token keyword">Dim</span> lastRow <span class="token keyword">As</span> <span class="token keyword">Long</span>
    <span class="token keyword">Dim</span> i <span class="token keyword">As</span> <span class="token keyword">Long</span>
    <span class="token keyword">Dim</span> productTitle <span class="token keyword">As</span> <span class="token keyword">String</span>
    <span class="token keyword">Dim</span> response <span class="token keyword">As</span> <span class="token keyword">String</span>
    <span class="token keyword">Dim</span> request <span class="token keyword">As</span> <span class="token keyword">Object</span>
    <span class="token keyword">Dim</span> url <span class="token keyword">As</span> <span class="token keyword">String</span>
    <span class="token keyword">Dim</span> apiKey <span class="token keyword">As</span> <span class="token keyword">String</span>
    <span class="token keyword">Dim</span> requestJSON <span class="token keyword">As</span> <span class="token keyword">String</span>
    <span class="token keyword">Dim</span> Json <span class="token keyword">As</span> <span class="token keyword">Object</span>

    <span class="token comment">'Set variables</span>
    <span class="token keyword">Set</span> wb <span class="token operator">=</span> ThisWorkbook
    <span class="token keyword">Set</span> ws <span class="token operator">=</span> wb.ActiveSheet
    lastRow <span class="token operator">=</span> ws.Cells<span class="token punctuation">(</span>ws.Rows.Count<span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">)</span>.<span class="token keyword">End</span><span class="token punctuation">(</span>xlUp<span class="token punctuation">)</span>.Row
    apiKey <span class="token operator">=</span> <span class="token string">"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"</span>
    url <span class="token operator">=</span> <span class="token string">"https://api.openai.com/v1/engines/text-davinci-003/completions"</span>


    <span class="token comment">'Loop through each row in column A</span>
    <span class="token keyword">For</span> i <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">To</span> lastRow

        <span class="token comment">'Get the product title from column A</span>
        productTitle <span class="token operator">=</span> ws.Cells<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>.Value

        <span class="token comment">'Set up the OpenAI API request</span>
        <span class="token keyword">Set</span> request <span class="token operator">=</span> CreateObject<span class="token punctuation">(</span><span class="token string">"MSXML2.XMLHTTP"</span><span class="token punctuation">)</span>
        request.<span class="token keyword">Open</span> <span class="token string">"POST"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token keyword">False</span>
        request.setRequestHeader <span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span>
        request.setRequestHeader <span class="token string">"Authorization"</span><span class="token punctuation">,</span> <span class="token string">"Bearer "</span> <span class="token operator">&amp;</span> apiKey

        <span class="token comment">'Send the request to OpenAI API</span>
        requestJSON <span class="token operator">=</span> <span class="token string">"&#123;""prompt"": ""Consideration proudct : "</span> <span class="token operator">&amp;</span> productTitle <span class="token operator">&amp;</span> <span class="token string">"\r\n1. Compose human readable product title used on Amazon in english within 20 words.\r\n2. Write 5 selling points for the products in Amazon.\r\n3. Evaluate a price range for this product in U.S.\r\n\r\nOutput the result in json format with three properties called title, selling_points and price_range.\r\n"",""temperature"": 0.7,""max_tokens"": 1024&#125;"</span>
        request.send requestJSON
        <span class="token comment">'Get the response from OpenAI API</span>
        response <span class="token operator">=</span> request.responseText

        <span class="token keyword">Set</span> Json <span class="token operator">=</span> JsonConverter.ParseJson<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        <span class="token keyword">Set</span> Json <span class="token operator">=</span> JsonConverter.ParseJson<span class="token punctuation">(</span>Json<span class="token punctuation">(</span><span class="token string">"choices"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">'Insert the JSON output into column B</span>
        ws.Cells<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> Json<span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">)</span>
        ws.Cells<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> ConcatenateArrayToString<span class="token punctuation">(</span>Json<span class="token punctuation">(</span><span class="token string">"selling_points"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        ws.Cells<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> Json<span class="token punctuation">(</span><span class="token string">"price_range"</span><span class="token punctuation">)</span>

    <span class="token keyword">Next</span> i

<span class="token keyword">End</span> <span class="token keyword">Sub</span>

<span class="token keyword">Function</span> ConcatenateArrayToString<span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token keyword">As</span> <span class="token keyword">String</span>
    <span class="token keyword">Dim</span> result <span class="token keyword">As</span> <span class="token keyword">String</span>
    <span class="token keyword">Dim</span> i <span class="token keyword">As</span> <span class="token keyword">Long</span>

    <span class="token comment">'Assuming the array is stored in a variable named "arr"</span>

    <span class="token keyword">For</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">To</span> <span class="token number">5</span>
        result <span class="token operator">=</span> result <span class="token operator">&amp;</span> arr<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> vbCrLf  <span class="token comment">'Use vbCrLf to add a line break after each element</span>
    <span class="token keyword">Next</span> i

    <span class="token comment">'The "result" variable now contains the concatenated string</span>
    ConcatenateArrayToString <span class="token operator">=</span> result
<span class="token keyword">End</span> <span class="token keyword">Function</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后的代码我们做了几处小的更改。</p>
<ol>
<li>遍历列表的第一列的时候，我们跳过了第一行的标题行。</li>
<li>去除了不再需要使用的临时变量，以及不再需要的之前AI自动生成的函数。</li>
<li>selling_points是一个5个元素的数组，通过一个单独的函数封装了从数组到字符串的拼装。</li>
</ol>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/668d97a02c3501552c890d8f7976d1f5.png" alt="图片"></p>
<p>VBA数组拼接字符串的工作，我们也是让ChatGPT指导我们做的</p>
<p>修改之后再执行一下，我们终于得到了理想的结果。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/b62c9e9c7e403f6e3c80395c349daf83.png" alt="图片"></p>
<p>最后整个完整功能的VBA代码，我也放在了GitHub里，你可以直接拿去运行。不过记得在运行之前，需要先安装VBA-JSON库和VBA-Dictionary库。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>好了，这一讲到这里也就结束了。设计这节课的目的是给你演示一下 <strong>如何和ChatGPT协同编写代码</strong>，完成一个对你有价值的小插件。我们通过ChatGPT的帮助，完成了一个使用VBA来编写的Excel小插件。</p>
<p>我自己上一次使用VBA也大概是20年前了，所以我相信如果你有一些代码基础的话，应该和我一样，能够通过ChatGPT完成这个插件的开发。</p>
<p>在这个开发的过程中，我们没有去重新学习VB.NET这样的编程语言，也没有使用Google来搜索解决问题。而是完全让ChatGPT主导，只是在遇到问题的时候，我们通过缩小和简化问题来进行Debug。唯一需要撰写的一点代码，也是最后简单阅读了ChatGPT推荐给我们的VBA-JSON的示例，加了一点点JSON解析的代码而已。</p>
<p>希望这一讲能够打开你的思路，帮助你善用ChatGPT更快、更好地完成写代码的任务。</p>
<h2 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h2><p>最后，按照惯例还是给你留一道思考题。你有什么想要实现的插件小功能吗？无论是在Excel、浏览器或者是其他什么场景下，请试着一步一步向ChatGPT输入你的需求，让它帮你写代码，来做一个属于你自己的插件吧！</p>
<p>期待你把自己的体验分享到评论区，也欢迎你把这一讲分享给需要的朋友，我们下一讲再见！</p>
<h2 id="推荐体验"><a href="#推荐体验" class="headerlink" title="推荐体验"></a>推荐体验</h2><p>最近有一个很火的新的代码编辑器，叫做cursor.so。它背后也是GPT的模型，能够快速根据你输入的需求描述生成Python和Typescript代码。如果你没有订阅GitHub Copilot，也可以去尝试一下这个应用。</p>
</article><div class="tag_share"><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#12%EF%BD%9C%E8%AE%A9AI%E5%B8%AE%E4%BD%A0%E5%86%99%E4%B8%AA%E5%B0%8F%E6%8F%92%E4%BB%B6%EF%BC%8C%E8%BD%BB%E6%9D%BE%E5%A4%84%E7%90%86Excel%E6%96%87%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text">12｜让AI帮你写个小插件，轻松处理Excel文件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A9%E6%88%91%E4%BB%AC%E5%86%8D%E6%9D%A5%E7%9C%8B%E7%9C%8B%E9%82%A3%E5%8F%AA%E5%8F%91%E5%85%89%E7%9A%84%E9%9D%92%E8%9B%99"><span class="toc-number">1.1.</span> <span class="toc-text">让我们再来看看那只发光的青蛙</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%88%E6%9D%A5%E8%AF%95%E4%B8%80%E8%AF%95%E7%AE%80%E5%8D%95%E7%9A%84%E6%8F%92%E4%BB%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.2.</span> <span class="toc-text">先来试一试简单的插件任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%86%E8%A7%A3%E6%83%B3%E8%A6%81%E5%AE%8C%E6%88%90%E7%9A%84%E4%BB%A3%E7%A0%81%E5%8A%9F%E8%83%BD%EF%BC%8C%E5%88%86%E6%AD%A5%E9%AA%A4%E8%AE%A9AI%E5%AE%8C%E6%88%90%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.3.</span> <span class="toc-text">拆解想要完成的代码功能，分步骤让AI完成程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8C%96%E9%97%AE%E9%A2%98%E5%AF%BB%E6%89%BE%E6%80%9D%E8%B7%AF"><span class="toc-number">1.4.</span> <span class="toc-text">简化问题寻找思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A9AI%E5%8D%95%E7%8B%AC%E5%86%99%E5%87%BA%E6%8F%90%E5%8F%96%E5%87%BD%E6%95%B0%EF%BC%8C%E5%AE%8C%E6%88%90%E6%9C%80%E5%90%8E%E7%9A%84%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.5.</span> <span class="toc-text">让AI单独写出提取函数，完成最后的程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.6.</span> <span class="toc-text">小结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%80%83%E9%A2%98"><span class="toc-number">1.7.</span> <span class="toc-text">思考题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E4%BD%93%E9%AA%8C"><span class="toc-number">1.8.</span> <span class="toc-text">推荐体验</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2024 By 码农张三</div></div><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/9.4.0/mermaid.min.js"></script></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div></div></body></html>