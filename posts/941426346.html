<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>14｜链式调用，用LangChain简化多步提示语 | geekbang</title><meta name="author" content="码农张三"><meta name="copyright" content="码农张三"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="14｜链式调用，用LangChain简化多步提示语你好，我是徐文浩。 OpenAI的大语言模型，只是提供了简简单单的Completion和Embedding这样两个核心接口。但是你也看到了，在过去的13讲里，通过合理使用这两个接口，我们完成了各种各样复杂的任务。  通过提示语（Prompt）里包含历史的聊天记录，我们能够让AI根据上下文正确地回答问题。 通过将Embedding提前索引好存起来，我">
<meta property="og:type" content="article">
<meta property="og:title" content="14｜链式调用，用LangChain简化多步提示语">
<meta property="og:url" content="https://zhuansun.github.io/geekbang/posts/941426346.html">
<meta property="og:site_name" content="geekbang">
<meta property="og:description" content="14｜链式调用，用LangChain简化多步提示语你好，我是徐文浩。 OpenAI的大语言模型，只是提供了简简单单的Completion和Embedding这样两个核心接口。但是你也看到了，在过去的13讲里，通过合理使用这两个接口，我们完成了各种各样复杂的任务。  通过提示语（Prompt）里包含历史的聊天记录，我们能够让AI根据上下文正确地回答问题。 通过将Embedding提前索引好存起来，我">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg">
<meta property="article:published_time" content="2023-10-20T09:48:40.000Z">
<meta property="article:modified_time" content="2023-12-11T12:04:44.318Z">
<meta property="article:author" content="码农张三">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhuansun.github.io/geekbang/posts/941426346"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '14｜链式调用，用LangChain简化多步提示语',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-12-11 12:04:44'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="geekbang" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://pic.imgdb.cn/item/653470a0c458853aef5813f1.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">587</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">geekbang</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">14｜链式调用，用LangChain简化多步提示语</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-10-20T09:48:40.000Z" title="发表于 2023-10-20 09:48:40">2023-10-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AI%E5%A4%A7%E6%A8%A1%E5%9E%8B%E4%B9%8B%E7%BE%8E/">AI大模型之美</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="14｜链式调用，用LangChain简化多步提示语"><a href="#14｜链式调用，用LangChain简化多步提示语" class="headerlink" title="14｜链式调用，用LangChain简化多步提示语"></a>14｜链式调用，用LangChain简化多步提示语</h1><p>你好，我是徐文浩。</p>
<p>OpenAI的大语言模型，只是提供了简简单单的Completion和Embedding这样两个核心接口。但是你也看到了，在过去的13讲里，通过合理使用这两个接口，我们完成了各种各样复杂的任务。</p>
<ul>
<li>通过提示语（Prompt）里包含历史的聊天记录，我们能够让AI根据上下文正确地回答问题。</li>
<li>通过将Embedding提前索引好存起来，我们能够让AI根据外部知识回答问题。</li>
<li>而通过多轮对话，将AI返回的答案放在新的问题里，我们能够让AI帮我们给自己的代码撰写单元测试。</li>
</ul>
<p>这些方法，也是一个实用的自然语言类应用里常见的模式。我之前也都通过代码为你演示过具体的做法。但是，如果我们每次写应用的时候，都需要自己再去OpenAI提供的原始API里做一遍，那就太麻烦了。于是，开源社区就有人将这些常见的需求和模式抽象了出来，开发了一个叫做Langchain的开源库。那么接下来，我们就来看看如何使用LangChain来快速实现之前我们利用大语言模型实现过的功能。以及我们如何进一步地，将Langchain和我们的业务系统整合，完成更复杂、更有实用价值的功能。</p>
<h2 id="使用Langchain的链式调用"><a href="#使用Langchain的链式调用" class="headerlink" title="使用Langchain的链式调用"></a>使用Langchain的链式调用</h2><p>如果你观察得比较仔细的话，你会发现在 <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/646363">第 11 讲</a> 我们使用llama-index的时候，就已经装好LangChain了。llama-index专注于为大语言模型的应用构建索引，虽然Langchain也有类似的功能，但这一点并不是Langchain的主要卖点。Langchain的第一个卖点其实就在它的名字里，也就是 <strong>链式调用</strong>。</p>
<p>我们先来看一个使用ChatGPT的例子，你就能理解为什么会有链式调用的需求了。我们知道，GPT-3的基础模型里面，中文的语料很少。用中文问它问题，很多时候它回答得不好。所以有时候，我会迂回处理一下，先把中文问题给AI，请它翻译成英文，然后再把英文问题贴进去提问，得到一个英文答案。最后，再请AI把英文答案翻译回中文。很多时候，问题的答案会更准确一点。比如，下面的截图里，我就请它简单介绍一下Stable Diffusion的原理是什么。</p>
<p>注：Stable Diffusion是一个热门的开源AI画图工具，后面我们在介绍用AI生成图片的时候会用到。</p>
<h3 id="人工链式调用"><a href="#人工链式调用" class="headerlink" title="人工链式调用"></a>人工链式调用</h3><p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/b904189cc5e23c5015aae7f6736f5dba.png" alt="图片"></p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/272869ac3fb95c57674843264eb62c44.png" alt="图片"></p>
<p>如果用API来实现这个过程，其实就是一个链式调用的过程。</p>
<ol>
<li>我们先调用OpenAI，把翻译请求和原始问题组合在一起发送给AI，完成问题的中译英。</li>
<li>然后再把拿到的翻译好的英文问题发送给OpenAI，得到英文答案。</li>
<li>最后再把英文答案，和对应要求AI翻译答案的请求组合在一起，完成答案的英译中。</li>
</ol>
<h3 id="使用LLMChain进行链式调用"><a href="#使用LLMChain进行链式调用" class="headerlink" title="使用LLMChain进行链式调用"></a>使用LLMChain进行链式调用</h3><p>如果我们用代码，可以像下面这样，一步步进行。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> openai<span class="token punctuation">,</span> os
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> PromptTemplate
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>llms <span class="token keyword">import</span> OpenAI
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains <span class="token keyword">import</span> LLMChain

openai<span class="token punctuation">.</span>api_key <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"OPENAI_API_KEY"</span><span class="token punctuation">)</span>

llm <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>model_name<span class="token operator">=</span><span class="token string">"text-davinci-003"</span><span class="token punctuation">,</span> max_tokens<span class="token operator">=</span><span class="token number">2048</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>

en_to_zh_prompt <span class="token operator">=</span> PromptTemplate<span class="token punctuation">(</span>
    template<span class="token operator">=</span><span class="token string">"请把下面这句话翻译成英文： \n\n &#123;question&#125;?"</span><span class="token punctuation">,</span> input_variables<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"question"</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>

question_prompt <span class="token operator">=</span> PromptTemplate<span class="token punctuation">(</span>
    template <span class="token operator">=</span> <span class="token string">"&#123;english_question&#125;"</span><span class="token punctuation">,</span> input_variables<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"english_question"</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>

zh_to_cn_prompt <span class="token operator">=</span> PromptTemplate<span class="token punctuation">(</span>
    input_variables<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"english_answer"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    template<span class="token operator">=</span><span class="token string">"请把下面这一段翻译成中文： \n\n&#123;english_answer&#125;?"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

question_translate_chain <span class="token operator">=</span> LLMChain<span class="token punctuation">(</span>llm<span class="token operator">=</span>llm<span class="token punctuation">,</span> prompt<span class="token operator">=</span>en_to_zh_prompt<span class="token punctuation">,</span> output_key<span class="token operator">=</span><span class="token string">"english_question"</span><span class="token punctuation">)</span>
english <span class="token operator">=</span> question_translate_chain<span class="token punctuation">.</span>run<span class="token punctuation">(</span>question<span class="token operator">=</span><span class="token string">"请你作为一个机器学习的专家，介绍一下CNN的原理。"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>english<span class="token punctuation">)</span>

qa_chain <span class="token operator">=</span> LLMChain<span class="token punctuation">(</span>llm<span class="token operator">=</span>llm<span class="token punctuation">,</span> prompt<span class="token operator">=</span>question_prompt<span class="token punctuation">,</span> output_key<span class="token operator">=</span><span class="token string">"english_answer"</span><span class="token punctuation">)</span>
english_answer <span class="token operator">=</span> qa_chain<span class="token punctuation">.</span>run<span class="token punctuation">(</span>english_question<span class="token operator">=</span>english<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>english_answer<span class="token punctuation">)</span>

answer_translate_chain <span class="token operator">=</span> LLMChain<span class="token punctuation">(</span>llm<span class="token operator">=</span>llm<span class="token punctuation">,</span> prompt<span class="token operator">=</span>zh_to_cn_prompt<span class="token punctuation">)</span>
answer <span class="token operator">=</span> answer_translate_chain<span class="token punctuation">.</span>run<span class="token punctuation">(</span>english_answer<span class="token operator">=</span>english_answer<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出结果：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">Please explain the principles of CNN as an expert in Machine Learning.

A Convolutional Neural Network (CNN) is a type of deep learning algorithm that is used to analyze visual imagery. It is modeled after the structure of the human visual cortex and is composed of multiple layers of neurons that process and extract features from an image. The main principle behind a CNN is that it uses convolutional layers to detect patterns in an image. Each convolutional layer is comprised of a set of filters that detect specific features in an image. These filters are then used to extract features from the image and create a feature map. The feature map is then passed through a pooling layer which reduces the size of the feature map and helps to identify the most important features in the image. Finally, the feature map is passed through a fully-connected layer which classifies the image and outputs the result.

卷积神经网络（CNN）是一种深度学习算法，用于分析视觉图像。它模仿人类视觉皮层的结构，由多层神经元组成，可以处理和提取图像中的特征。CNN的主要原理是使用卷积层来检测图像中的模式。每个卷积层由一组滤波器组成，可以检测图像中的特定特征。然后使用这些滤波器从图像中提取特征，并创建特征图。然后，将特征图通过池化层传递，该层可以减小特征图的大小，并有助于识别图像中最重要的特征。最后，将特征图传递给完全连接的层，该层将对图像进行分类，并输出结果。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里的代码，我们使用了Langchain这个库，不过还没有动用它的链式调用过程。我们主要用了Langchain的三个包。</p>
<ol>
<li>LLM，也就是我们使用哪个大语言模型，来回答我们提出的问题。在这里，我们还是使用OpenAIChat，也就是最新放出来的 gpt-3.5-turbo 模型。</li>
<li>PromptTemplate，和我们在 <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/646363">第 11 讲</a> 里看到的llama-index的PromptTemplate是一个东西。它可以定义一个提示语模版，里面能够定义一些可以动态替换的变量。比如，代码里的question_prompt这个模版里，我们就定义了一个叫做question的变量，因为我们每次问的问题都会不一样。事实上，llamd-index里面的PromptTemplate就是对Langchain的PromptTemplate做了一层简单的封装。</li>
<li>主角 LLMChain，它的构造函数接收一个LLM和一个PromptTemplate作为参数。构造完成之后，可以直接调用里面的run方法，将PromptTemplate需要的变量，用K&#x3D;&gt;V对的形式传入进去。返回的结果，就是LLM给我们的答案。</li>
</ol>
<p>不过如果看上面这段代码，我们似乎只是对OpenAI的API做了一层封装而已。我们构建了3个LLMChain，然后按照顺序调用，每次拿到答案之后，再作为输入，交给下一个LLM调用。感觉好像更麻烦了，没有减少什么工作量呀？</p>
<p>别着急，这是因为我们还没有真正用上LLMChain的“链式调用”功能，而用这个功能，只需要加上一行小小的代码。我们用一个叫做SimpleSequentialChain的LLMChain类，把我们要按照顺序依次调用的三个LLMChain放在一个数组里，传给这个类的构造函数。</p>
<p>然后对于这个对象，我们调用run方法，把我们用中文问的问题交给它。这个时候，这个SimpleSequentialChain，就会按照顺序开始调用chains这个数组参数里面包含的其他LLMChain。并且，每一次调用的结果，会存储在这个Chain构造时定义的output_key参数里。而下一个调用的LLMChain，里面模版内的变量如果有和之前的output_key名字相同的，就会用output_key里存入的内容替换掉模版内变量所在的占位符。</p>
<p>这次，我们只向这个SimpleSequentialChain调用一次run方法，把一开始的问题交给它就好了。后面根据答案去问新的问题，这个LLMChain会自动地链式搞定。我在这里把日志的Verbose模式打开了，你在输出的过程中，可以看到其实这个LLMChain是调用了三次，并且中间两次的返回结果你也可以一并看到。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains <span class="token keyword">import</span> SimpleSequentialChain

chinese_qa_chain <span class="token operator">=</span> SimpleSequentialChain<span class="token punctuation">(</span>
    chains<span class="token operator">=</span><span class="token punctuation">[</span>question_translate_chain<span class="token punctuation">,</span> qa_chain<span class="token punctuation">,</span> answer_translate_chain<span class="token punctuation">]</span><span class="token punctuation">,</span> input_key<span class="token operator">=</span><span class="token string">"question"</span><span class="token punctuation">,</span>
    verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
answer <span class="token operator">=</span> chinese_qa_chain<span class="token punctuation">.</span>run<span class="token punctuation">(</span>question<span class="token operator">=</span><span class="token string">"请你作为一个机器学习的专家，介绍一下CNN的原理。"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Verbose日志信息：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">> Entering new SimpleSequentialChain chain...

Please introduce the principle of CNN as a machine learning expert.

Convolutional Neural Networks (CNNs) are a type of artificial neural network that are commonly used in image recognition and classification tasks. They are inspired by the structure of the human brain and are composed of multiple layers of neurons connected in a specific pattern. The neurons in the first layer of a CNN are connected to the input image, and the neurons in the last layer are connected to the output. The neurons in between the input and output layers are called feature maps and are responsible for extracting features from the input image. CNNs use convolutional layers to detect patterns in the input image and pooling layers to reduce the size of the feature maps. This allows the CNN to learn the most important features in the image and use them to make predictions.

卷积神经网络（CNN）是一种常用于图像识别和分类任务的人工神经网络。它们受到人脑结构的启发，由多层神经元以特定模式连接而成。CNN的第一层神经元与输入图像连接，最后一层神经元与输出连接。输入和输出层之间的神经元称为特征映射，负责从输入图像中提取特征。CNN使用卷积层检测输入图像中的模式，使用池化层减小特征映射的大小。这使得CNN能够学习图像中最重要的特征，并利用它们进行预测。
> Finished chain.
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出结果：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">卷积神经网络（CNN）是一种常用于图像识别和分类任务的人工神经网络。它们受到人脑结构的启发，由多层神经元以特定模式连接而成。CNN的第一层神经元与输入图像连接，最后一层神经元与输出连接。输入和输出层之间的神经元称为特征映射，负责从输入图像中提取特征。CNN使用卷积层检测输入图像中的模式，使用池化层减小特征映射的大小。这使得CNN能够学习图像中最重要的特征，并利用它们进行预测。
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在使用这样的链式调用的时候，有一点需要注意，就是一个LLMChain里，所使用的PromptTemplate里的输入参数， <strong>之前必须在LLMChain里，通过 output_key 定义过。</strong> 不然，这个变量没有值，程序就会报错。</p>
<h3 id="支持多个变量输入的链式调用"><a href="#支持多个变量输入的链式调用" class="headerlink" title="支持多个变量输入的链式调用"></a>支持多个变量输入的链式调用</h3><p>事实上，因为使用变量的输入输出，是用这些参数定义的。所以我们不是只能用前一个LLMChain的输出作为后一个LLMChain的输入。我们完全可以连续问多个问题，然后把这些问题的答案，作为后续问题的输入来继续处理。下面我就给你看一个例子。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains <span class="token keyword">import</span> SequentialChain

q1_prompt <span class="token operator">=</span> PromptTemplate<span class="token punctuation">(</span>
    input_variables<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"year1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    template<span class="token operator">=</span><span class="token string">"&#123;year1&#125;年的欧冠联赛的冠军是哪支球队，只说球队名称。"</span>
<span class="token punctuation">)</span>
q2_prompt <span class="token operator">=</span> PromptTemplate<span class="token punctuation">(</span>
    input_variables<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"year2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    template<span class="token operator">=</span><span class="token string">"&#123;year2&#125;年的欧冠联赛的冠军是哪支球队，只说球队名称。"</span>
<span class="token punctuation">)</span>
q3_prompt <span class="token operator">=</span> PromptTemplate<span class="token punctuation">(</span>
    input_variables<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"team1"</span><span class="token punctuation">,</span> <span class="token string">"team2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    template<span class="token operator">=</span><span class="token string">"&#123;team1&#125;和&#123;team2&#125;哪只球队获得欧冠的次数多一些？"</span>
<span class="token punctuation">)</span>
chain1 <span class="token operator">=</span> LLMChain<span class="token punctuation">(</span>llm<span class="token operator">=</span>llm<span class="token punctuation">,</span> prompt<span class="token operator">=</span>q1_prompt<span class="token punctuation">,</span> output_key<span class="token operator">=</span><span class="token string">"team1"</span><span class="token punctuation">)</span>
chain2 <span class="token operator">=</span> LLMChain<span class="token punctuation">(</span>llm<span class="token operator">=</span>llm<span class="token punctuation">,</span> prompt<span class="token operator">=</span>q2_prompt<span class="token punctuation">,</span> output_key<span class="token operator">=</span><span class="token string">"team2"</span><span class="token punctuation">)</span>
chain3 <span class="token operator">=</span> LLMChain<span class="token punctuation">(</span>llm<span class="token operator">=</span>llm<span class="token punctuation">,</span> prompt<span class="token operator">=</span>q3_prompt<span class="token punctuation">)</span>

sequential_chain <span class="token operator">=</span> SequentialChain<span class="token punctuation">(</span>chains<span class="token operator">=</span><span class="token punctuation">[</span>chain1<span class="token punctuation">,</span> chain2<span class="token punctuation">,</span> chain3<span class="token punctuation">]</span><span class="token punctuation">,</span> input_variables<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"year1"</span><span class="token punctuation">,</span> <span class="token string">"year2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
answer <span class="token operator">=</span> sequential_chain<span class="token punctuation">.</span>run<span class="token punctuation">(</span>year1<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span> year2<span class="token operator">=</span><span class="token number">2010</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出结果：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">> Entering new SequentialChain chain...
> Finished chain.

西班牙皇家马德里队获得欧冠的次数更多，共13次，而拜仁慕尼黑只有5次。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这个例子里，我们定义了两个PromptTemplate和对应的LLMChain，各自接收一个年份作为输入，回答这两个年份的欧冠冠军。然后将两个队名作为输入，放到第三个问题里，让AI告诉我们这两支球队哪一支获得欧冠的次数多一些。只需要在我们的SequentialChain里输入两个年份，就能通过三次回答得到答案。</p>
<h2 id="通过Langchain实现自动化撰写单元测试"><a href="#通过Langchain实现自动化撰写单元测试" class="headerlink" title="通过Langchain实现自动化撰写单元测试"></a>通过Langchain实现自动化撰写单元测试</h2><p>看到这里，不知道你有没有想起我们上一讲刚刚讲过的通过多步提示语自动给代码写单元测试。没错，Langchain可以顺序地通过多个Prompt调用OpenAI的GPT模型。这个能力拿来实现上一讲的自动化测试的功能是再合适不过的了。下面，我就拿Langchain重新实现了一遍上一讲的这个功能，并且给它补上了AST语法解析失败之后自动重试的能力。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains <span class="token keyword">import</span> SequentialChain

<span class="token keyword">def</span> <span class="token function">write_unit_test</span><span class="token punctuation">(</span>function_to_test<span class="token punctuation">,</span> unit_test_package <span class="token operator">=</span> <span class="token string">"pytest"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 解释源代码的步骤</span>
    explain_code <span class="token operator">=</span> <span class="token triple-quoted-string string">""""# How to write great unit tests with &#123;unit_test_package&#125;

    In this advanced tutorial for experts, we'll use Python 3.10 and `&#123;unit_test_package&#125;` to write a suite of unit tests to verify the behavior of the following function.
    ```python
    &#123;function_to_test&#125;
    ```

    Before writing any unit tests, let's review what each element of the function is doing exactly and what the author's intentions may have been.
    - First,"""</span>

    explain_code_template <span class="token operator">=</span> PromptTemplate<span class="token punctuation">(</span>
        input_variables<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"unit_test_package"</span><span class="token punctuation">,</span> <span class="token string">"function_to_test"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        template<span class="token operator">=</span>explain_code
    <span class="token punctuation">)</span>
    explain_code_llm <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>model_name<span class="token operator">=</span><span class="token string">"text-davinci-002"</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">,</span> max_tokens<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
            top_p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stop<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"\n\n"</span><span class="token punctuation">,</span> <span class="token string">"\n\t\n"</span><span class="token punctuation">,</span> <span class="token string">"\n    \n"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    explain_code_step <span class="token operator">=</span> LLMChain<span class="token punctuation">(</span>llm<span class="token operator">=</span>explain_code_llm<span class="token punctuation">,</span> prompt<span class="token operator">=</span>explain_code_template<span class="token punctuation">,</span> output_key<span class="token operator">=</span><span class="token string">"code_explaination"</span><span class="token punctuation">)</span>

    <span class="token comment"># 创建测试计划示例的步骤</span>
    test_plan <span class="token operator">=</span> <span class="token triple-quoted-string string">"""

    A good unit test suite should aim to:
    - Test the function's behavior for a wide range of possible inputs
    - Test edge cases that the author may not have foreseen
    - Take advantage of the features of `&#123;unit_test_package&#125;` to make the tests easy to write and maintain
    - Be easy to read and understand, with clean code and descriptive names
    - Be deterministic, so that the tests always pass or fail in the same way

    `&#123;unit_test_package&#125;` has many convenient features that make it easy to write and maintain unit tests. We'll use them to write unit tests for the function above.

    For this particular function, we'll want our unit tests to handle the following diverse scenarios (and under each scenario, we include a few examples as sub-bullets):
    -"""</span>
    test_plan_template <span class="token operator">=</span> PromptTemplate<span class="token punctuation">(</span>
        input_variables<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"unit_test_package"</span><span class="token punctuation">,</span> <span class="token string">"function_to_test"</span><span class="token punctuation">,</span> <span class="token string">"code_explaination"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        template<span class="token operator">=</span> explain_code <span class="token operator">+</span> <span class="token string">"&#123;code_explaination&#125;"</span> <span class="token operator">+</span> test_plan
    <span class="token punctuation">)</span>
    test_plan_llm <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>model_name<span class="token operator">=</span><span class="token string">"text-davinci-002"</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">,</span> max_tokens<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
            top_p<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stop<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"\n\n"</span><span class="token punctuation">,</span> <span class="token string">"\n\t\n"</span><span class="token punctuation">,</span> <span class="token string">"\n    \n"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    test_plan_step <span class="token operator">=</span> LLMChain<span class="token punctuation">(</span>llm<span class="token operator">=</span>test_plan_llm<span class="token punctuation">,</span> prompt<span class="token operator">=</span>test_plan_template<span class="token punctuation">,</span> output_key<span class="token operator">=</span><span class="token string">"test_plan"</span><span class="token punctuation">)</span>

    <span class="token comment"># 撰写测试代码的步骤</span>
    starter_comment <span class="token operator">=</span> <span class="token string">"Below, each test case is represented by a tuple passed to the @pytest.mark.parametrize decorator"</span>
    prompt_to_generate_the_unit_test <span class="token operator">=</span> <span class="token triple-quoted-string string">"""

Before going into the individual tests, let's first look at the complete suite of unit tests as a cohesive whole. We've added helpful comments to explain what each line does.
```python
import &#123;unit_test_package&#125;  # used for our unit tests

&#123;function_to_test&#125;

#&#123;starter_comment&#125;"""</span>

    unit_test_template <span class="token operator">=</span> PromptTemplate<span class="token punctuation">(</span>
        input_variables<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"unit_test_package"</span><span class="token punctuation">,</span> <span class="token string">"function_to_test"</span><span class="token punctuation">,</span> <span class="token string">"code_explaination"</span><span class="token punctuation">,</span> <span class="token string">"test_plan"</span><span class="token punctuation">,</span> <span class="token string">"starter_comment"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        template<span class="token operator">=</span> explain_code <span class="token operator">+</span> <span class="token string">"&#123;code_explaination&#125;"</span> <span class="token operator">+</span> test_plan <span class="token operator">+</span> <span class="token string">"&#123;test_plan&#125;"</span> <span class="token operator">+</span> prompt_to_generate_the_unit_test
    <span class="token punctuation">)</span>
    unit_test_llm <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>model_name<span class="token operator">=</span><span class="token string">"text-davinci-002"</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">,</span> max_tokens<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> stop<span class="token operator">=</span><span class="token string">"```"</span><span class="token punctuation">)</span>
    unit_test_step <span class="token operator">=</span> LLMChain<span class="token punctuation">(</span>llm<span class="token operator">=</span>unit_test_llm<span class="token punctuation">,</span> prompt<span class="token operator">=</span>unit_test_template<span class="token punctuation">,</span> output_key<span class="token operator">=</span><span class="token string">"unit_test"</span><span class="token punctuation">)</span>

    sequential_chain <span class="token operator">=</span> SequentialChain<span class="token punctuation">(</span>chains<span class="token operator">=</span><span class="token punctuation">[</span>explain_code_step<span class="token punctuation">,</span> test_plan_step<span class="token punctuation">,</span> unit_test_step<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                    input_variables<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"unit_test_package"</span><span class="token punctuation">,</span> <span class="token string">"function_to_test"</span><span class="token punctuation">,</span> <span class="token string">"starter_comment"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    answer <span class="token operator">=</span> sequential_chain<span class="token punctuation">.</span>run<span class="token punctuation">(</span>unit_test_package<span class="token operator">=</span>unit_test_package<span class="token punctuation">,</span> function_to_test<span class="token operator">=</span>function_to_test<span class="token punctuation">,</span> starter_comment<span class="token operator">=</span>starter_comment<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"""#</span><span class="token interpolation"><span class="token punctuation">&#123;</span>starter_comment<span class="token punctuation">&#125;</span></span><span class="token string">"""</span></span> <span class="token operator">+</span> answer

code <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
def format_time(seconds):
    minutes, seconds = divmod(seconds, 60)
    hours, minutes = divmod(minutes, 60)
    if hours > 0:
        return f"&#123;hours&#125;h&#123;minutes&#125;min&#123;seconds&#125;s"
    elif minutes > 0:
        return f"&#123;minutes&#125;min&#123;seconds&#125;s"
    else:
        return f"&#123;seconds&#125;s"
"""</span>

<span class="token keyword">import</span> ast

<span class="token keyword">def</span> <span class="token function">write_unit_test_automatically</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> retry<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    unit_test_code <span class="token operator">=</span> write_unit_test<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    all_code <span class="token operator">=</span> code <span class="token operator">+</span> unit_test_code
    tried <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> tried <span class="token operator">&lt;</span> retry<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>all_code<span class="token punctuation">)</span>
            <span class="token keyword">return</span> all_code
        <span class="token keyword">except</span> SyntaxError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Syntax error in generated code: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            all_code <span class="token operator">=</span> code <span class="token operator">+</span> write_unit_test<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
            tried <span class="token operator">+=</span> <span class="token number">1</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>write_unit_test_automatically<span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出结果：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token keyword">def</span> <span class="token function">format_time</span><span class="token punctuation">(</span>seconds<span class="token punctuation">)</span><span class="token punctuation">:</span>
    minutes<span class="token punctuation">,</span> seconds <span class="token operator">=</span> <span class="token builtin">divmod</span><span class="token punctuation">(</span>seconds<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>
    hours<span class="token punctuation">,</span> minutes <span class="token operator">=</span> <span class="token builtin">divmod</span><span class="token punctuation">(</span>minutes<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> hours <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>hours<span class="token punctuation">&#125;</span></span><span class="token string">h</span><span class="token interpolation"><span class="token punctuation">&#123;</span>minutes<span class="token punctuation">&#125;</span></span><span class="token string">min</span><span class="token interpolation"><span class="token punctuation">&#123;</span>seconds<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span>
    <span class="token keyword">elif</span> minutes <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>minutes<span class="token punctuation">&#125;</span></span><span class="token string">min</span><span class="token interpolation"><span class="token punctuation">&#123;</span>seconds<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>seconds<span class="token punctuation">&#125;</span></span><span class="token string">s"</span></span>
<span class="token comment">#Below, each test case is represented by a tuple passed to the @pytest.mark.parametrize decorator.</span>
<span class="token comment">#The first element of the tuple is the name of the test case, and the second element is a list of tuples,</span>
<span class="token comment">#where each tuple contains the input values for the format_time() function and the expected output.</span>
<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>parametrize</span><span class="token punctuation">(</span><span class="token string">"test_case, input_values, expected_output"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token comment"># Test cases for when the seconds parameter is an integer</span>
    <span class="token punctuation">(</span><span class="token string">"seconds is positive"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"42s"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">"seconds is negative"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"-42s"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">"seconds is 0"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"0s"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># Test cases for when the seconds parameter is not an integer</span>
    <span class="token punctuation">(</span><span class="token string">"seconds is a float"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">42.0</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"42.0s"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">"seconds is a string"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"42"</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"42s"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">"seconds is None"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"None"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># Test cases for when the seconds parameter is an integer, but it is not in the range 0-3600</span>
    <span class="token punctuation">(</span><span class="token string">"seconds is too small"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"-1s"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">"seconds is too large"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3601</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"1h0min1s"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">test_format_time</span><span class="token punctuation">(</span>test_case<span class="token punctuation">,</span> input_values<span class="token punctuation">,</span> expected_output<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># We use the pytest.raises context manager to assert that the function raises a TypeError</span>
    <span class="token comment"># if the input is not an integer.</span>
    <span class="token keyword">with</span> pytest<span class="token punctuation">.</span>raises<span class="token punctuation">(</span>TypeError<span class="token punctuation">)</span><span class="token punctuation">:</span>
        format_time<span class="token punctuation">(</span>input_values<span class="token punctuation">)</span>
    <span class="token comment"># We use the pytest.approx context manager to assert that the output is approximately equal</span>
    <span class="token comment"># to the expected output, within a certain tolerance.</span>
    <span class="token keyword">assert</span> format_time<span class="token punctuation">(</span>input_values<span class="token punctuation">)</span> <span class="token operator">==</span> pytest<span class="token punctuation">.</span>approx<span class="token punctuation">(</span>expected_output<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个代码的具体功能，其实和上一讲是一模一样的，只是通过Langchain做了封装，使它更加容易维护了。我们把解释代码、生成测试计划，以及最终生成测试代码，变成了三个LLMChain。每一步的输入，都来自上一步的输出。这个输入既包括上一步的Prompt Template和这一步的Prompt Template的组合，也包括过程中的一些变量，这些变量是上一步执行的结果作为输入变量传递进来的。最终，我们可以使用SequentialChain来自动地按照这三个步骤，执行OpenAI的API调用。</p>
<p>这整个过程通过write_unit_test这个函数给封装起来了。对于重试，我们则是通过一个while循环来调用 write_unit_test。拿到的结果和输入的代码拼装在一起，交给AST库做解析。如果解析通不过，则重试整个单元测试生成的过程，直到达到我们最大的重试次数为止。</p>
<p>LangChain的这个分多个步骤调用OpenAI模型的能力，能够帮助我们通过AI完成复杂的任务，并且将整个任务的完成过程定义成了一个固定的流程模版。在下一讲里，我们还会进一步看到，通过这样一个链式组合多个LLMChain的方法，如何完成更复杂并且更具有现实意义的工作。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>好了，相信到这里，你脑子里应该有了更多可以利用大语言模型的好点子。这一讲，我带你学会了如何通过Langchain这个开源库，对大语言模型进行链式调用。想要通过大语言模型，完成一个复杂的任务，往往需要我们多次向AI提问，并且前面提问的答案，可能是后面问题输入的一部分。LangChain通过将多个LLMChain组合成一个SequantialChain并顺序执行，大大简化了这类任务的开发工作。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/36916e57fc0618e5cb8ce49991e423da.png" alt="图片"></p>
<p>Langchain还有很多更强大的功能，我们不仅能调用语言模型，还能调用外部系统，甚至我们还能直接让AI做决策，决定该让我们的系统做什么。在后面的几讲里，我们会覆盖这些内容，并最终给你一个完整的电商聊天机器人。</p>
<h2 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h2><p>最后，给你留一道思考题。你能试着通过Langchain组合多个问题，并且利用前面问题的回答结果，触发新的问题找到你想要的答案吗？欢迎你把你的例子拿出来分享在评论区，也欢迎你把这一讲分享给需要的朋友，我们下一讲再见。</p>
<h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><p>和之前介绍过的llama-index这个项目一样，Langchain这个项目也在快速地发展和迭代过程中。我推荐你去看一看他们的 <a target="_blank" rel="noopener" href="https://langchain.readthedocs.io/en/latest/">官方文档</a>，好知道他们提供的最新功能。此外，这个我们之前提到过的向量数据库公司Pinecone，也制作了一份 <a target="_blank" rel="noopener" href="https://www.pinecone.io/learn/langchain/">Langchain AI Handbook</a>，你也可以去看一看。</p>
</article><div class="tag_share"><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#14%EF%BD%9C%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%EF%BC%8C%E7%94%A8LangChain%E7%AE%80%E5%8C%96%E5%A4%9A%E6%AD%A5%E6%8F%90%E7%A4%BA%E8%AF%AD"><span class="toc-number">1.</span> <span class="toc-text">14｜链式调用，用LangChain简化多步提示语</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Langchain%E7%9A%84%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text">使用Langchain的链式调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%BA%E5%B7%A5%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.1.</span> <span class="toc-text">人工链式调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8LLMChain%E8%BF%9B%E8%A1%8C%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.2.</span> <span class="toc-text">使用LLMChain进行链式调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%AF%E6%8C%81%E5%A4%9A%E4%B8%AA%E5%8F%98%E9%87%8F%E8%BE%93%E5%85%A5%E7%9A%84%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.3.</span> <span class="toc-text">支持多个变量输入的链式调用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87Langchain%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E5%8C%96%E6%92%B0%E5%86%99%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.</span> <span class="toc-text">通过Langchain实现自动化撰写单元测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.3.</span> <span class="toc-text">小结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%80%83%E9%A2%98"><span class="toc-number">1.4.</span> <span class="toc-text">思考题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB"><span class="toc-number">1.5.</span> <span class="toc-text">推荐阅读</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By 码农张三</div></div><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/9.4.0/mermaid.min.js"></script></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div></div></body></html>