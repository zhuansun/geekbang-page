<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>26｜Visual ChatGPT是如何做到边聊边画的？ | geekbang</title><meta name="author" content="码农张三"><meta name="copyright" content="码农张三"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="26｜Visual ChatGPT是如何做到边聊边画的？你好，我是徐文浩。 过去三讲里，我们分别体验了CLIP、Stable Diffusion和ControlNet这三个模型。我们用这些模型来识别图片的内容，或者通过输入一段文本指令来画图。这些模型都是所谓的多模态模型，能够把图片和文本信息联系在一起。 不过，如果我们不仅仅是要随便找几个关键词画两张画玩个票，而是要在实际的工作环境里生成能用的图片">
<meta property="og:type" content="article">
<meta property="og:title" content="26｜Visual ChatGPT是如何做到边聊边画的？">
<meta property="og:url" content="https://zhuansun.github.io/geekbang/posts/1714578286.html">
<meta property="og:site_name" content="geekbang">
<meta property="og:description" content="26｜Visual ChatGPT是如何做到边聊边画的？你好，我是徐文浩。 过去三讲里，我们分别体验了CLIP、Stable Diffusion和ControlNet这三个模型。我们用这些模型来识别图片的内容，或者通过输入一段文本指令来画图。这些模型都是所谓的多模态模型，能够把图片和文本信息联系在一起。 不过，如果我们不仅仅是要随便找几个关键词画两张画玩个票，而是要在实际的工作环境里生成能用的图片">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg">
<meta property="article:published_time" content="2023-10-20T09:48:40.000Z">
<meta property="article:modified_time" content="2023-12-15T09:26:31.132Z">
<meta property="article:author" content="码农张三">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhuansun.github.io/geekbang/posts/1714578286"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '26｜Visual ChatGPT是如何做到边聊边画的？',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-12-15 09:26:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="geekbang" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://pic.imgdb.cn/item/653470a0c458853aef5813f1.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">870</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">geekbang</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">26｜Visual ChatGPT是如何做到边聊边画的？</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-10-20T09:48:40.000Z" title="发表于 2023-10-20 09:48:40">2023-10-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AI%E5%A4%A7%E6%A8%A1%E5%9E%8B%E4%B9%8B%E7%BE%8E/">AI大模型之美</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="26｜Visual-ChatGPT是如何做到边聊边画的？"><a href="#26｜Visual-ChatGPT是如何做到边聊边画的？" class="headerlink" title="26｜Visual ChatGPT是如何做到边聊边画的？"></a>26｜Visual ChatGPT是如何做到边聊边画的？</h1><p>你好，我是徐文浩。</p>
<p>过去三讲里，我们分别体验了CLIP、Stable Diffusion和ControlNet这三个模型。我们用这些模型来识别图片的内容，或者通过输入一段文本指令来画图。这些模型都是所谓的多模态模型，能够把图片和文本信息联系在一起。</p>
<p>不过，如果我们不仅仅是要随便找几个关键词画两张画玩个票，而是要在实际的工作环境里生成能用的图片，那么现在的体验还是远远不够的。对于画出来的图我们总有各种各样的修改和编辑的需求。比如，我们总是会遇到各个团队的人对着设计师的图指手画脚地提出各种各样的意见：“能不能把小狗移到图片的右边？”“能不能把背景从草地改成森林？”“我想要一个色彩斑斓的黑。”等等。</p>
<p>所以， <strong>理想中的AI画画的功能，最好还能配上一个听得懂人话的AI，能够根据我们这些外行的指手画脚来修改生成的图片。</strong> 针对这个需求，我们就来介绍一下微软开源的Visual ChatGPT。</p>
<p>和之前我们自己写代码不同，这一讲我们一起来读一读 <a target="_blank" rel="noopener" href="https://github.com/microsoft/TaskMatrix">Visual ChatGPT</a> 这个开源项目的代码，看看它是如何做到能让我们聊着天就把图片给修改完了的。</p>
<h2 id="体验-Visual-ChatGPT"><a href="#体验-Visual-ChatGPT" class="headerlink" title="体验 Visual ChatGPT"></a>体验 Visual ChatGPT</h2><p>我们先来体验一下Visual ChatGPT的效果是怎么样的。这一次，Colab里的GPU也不够我们用了。Visual ChatGPT要加载很多个不同的图片相关的模型，这些模型加起来的显存得有40GB以上。</p>
<p>好在，微软通过HuggingFace的Space功能提供了一个 <a target="_blank" rel="noopener" href="https://huggingface.co/spaces/microsoft/visual_chatgpt">免费的 Space</a>，让你可以直接体验Visual ChatGPT的功能。不过，考虑到用的人很多，使用的过程中你的请求会被排队处理，往往要等待很长时间才能完成一条指令。所以，我建议你花个几美元的小钱，部署一个自己的Visual ChatGPT的Space来体验一下它的功能。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/3636e392e72ff192301f90668b09d6d0.png" alt="图片"></p>
<p>你可以点击微软提供的Space底部的Duplicate Space，部署一个完全一样的Visual ChatGPT Space到自己的账号下，这样你就不用和其他人排队等着了。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/0759e98e7d596a4b1ecd9da7e96eab90.png" alt="图片"></p>
<p>因为我们复制的是原先的Space，所以对应的硬件配置也是和微软免费提供的一样。通过一块46G显存的A10显卡，我们可以直接装载所有用到的模型。不过，使用A10显卡的Space是有成本的，一个小时就要花去你3.15美元。所以在复制Space的时候，有两个参数你需要注意。</p>
<ul>
<li>第一个是Sleep time settings，我建议你设置成5分钟。这样，一旦5分钟没有人使用这个Space，它就会进入休眠状态。而HuggingFace在休眠状态下就不会收取你任何费用。只是下一次你要使用这个Space的时候，会重新启动整个Space，需要一点点时间。</li>
<li>另一个是Space的Visibility，我建议你选择Private。这样，这个Space只有你能看到。不然的话，就算你设置了自动休眠，也免不了有人看到你的Space上来试一试。如果不断有人来使用你的Space的话，它会一直在线运行，而你就是那个付账单的人。</li>
</ul>
<p>在复制的Space部署完成之后，你就可以先来试一下Visual ChatGPT了。首先你需要在右上角输入你的OpenAI的API Key，并按下回车键。这样，整个窗口的下方就会出现可以输入文本的聊天窗口。你可以选择自由输入你想要画的内容，也可以在下面的Examples里选择预设好的一些指令。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/063369368ccbdce8d2591d5851d967e1.png" alt="图片"></p>
<p>我们可以分别试一下Examples里面给出的指令。</p>
<ol>
<li>我们先让Visual ChatGPT画一幅小猫在花园里奔跑的图片。</li>
</ol>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/661088917d40bf99836184c20d9828a5.png" alt="图片"></p>
<ol>
<li>然后再把画面里的小猫换成小狗。</li>
</ol>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/cc1985b4cc9d0d10bdc6fcea253af716.png" alt="图片"></p>
<ol>
<li>接着去掉画面中的小狗。</li>
</ol>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/33d3b56b982bee56613fbcf3e8dffa68.png" alt="图片"></p>
<ol>
<li>再把图片风格换成水彩画。</li>
</ol>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/e47a2c7695566ae9de6f876b5b9e54aa.png" alt="图片"></p>
<ol>
<li>最后我们让Visual ChatGPT描述一下图片的内容。</li>
</ol>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/756feb6e6f3c6e5858a99e880d5cdc70.png" alt="图片"></p>
<p>可以看到，Visual ChatGPT很好地完成了我们的每一条指令。而这样的交互体验大大提升了我们用AI画画的实际体验。比如，上一讲里我们通过Canny算法获取了“戴珍珠耳环的少女”画像的轮廓，然后通过ControlNet绘制了同样姿势的其他明星的头像。原本这个过程我们是通过一系列的代码来实现的，现在我们完全可以用Visual ChatGPT，通过一系列的对话向AI下达指令来实现。</p>
<p>首先，我们通过Upload按钮把“戴珍珠耳环的少女”图片上传上去。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/97b3e527347f353aaf12a34456934c47.png" alt="图片"></p>
<p>接着，我们在对话框里输入文本 “Generate the canny edge of the image”，Visual ChatGPT就会把上传图片的边缘提取出来，并且生成一张新的图片。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/6323d1b16737c4d0bde69c8a6c94c561.png" alt="图片"></p>
<p>最后，我们在对话框里输入 “Generate a real color Taylor Swift photo from this canny image”，Visual ChatGPT就会基于上面边缘检测的轮廓图生成一个新的人像图。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/64e7cac2d8db67cc36540498byyb2729.png" alt="图片"></p>
<p>这样，我们不需要撰写任何代码，通过一个聊天窗口就能完成对图片的编辑和修改工作。</p>
<h2 id="Visual-ChatGPT的原理与实现"><a href="#Visual-ChatGPT的原理与实现" class="headerlink" title="Visual ChatGPT的原理与实现"></a>Visual ChatGPT的原理与实现</h2><p>Visual ChatGPT的效果非常神奇，但是其实内部原理却非常简单。Visual ChatGPT解决问题的办法就是使用 <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/648461">第 17 讲</a> 我们介绍过的LangChain的ReAct Agent模式，它做了这样几件事情。</p>
<ol>
<li>它把各种各样图像处理的视觉基础模型（Visual Foundation Model）都封装成了一个个Tool。</li>
<li>然后，将这些Tool都交给了一个conversation-react-description类型的Agent。每次你输入文本的时候，其实就是和这个Agent在交流。Agent接收到你的文本，就要判断自己应该使用哪一个Tool，还有应该从输入的内容里提取什么参数给到这个Tool。这些输入参数中既包括需要修改哪一个图片，也包括使用什么样的提示语。这里的Agent背后使用的就是ChatGPT。</li>
<li>最后，Agent会实际去调用这个Tool，生成一张新的图片返回给你。</li>
</ol>
<p>那接下来，我们就进入Visual ChatGPT的代码，来看一下具体的代码是怎么做的。Visual ChatGPT的源代码只有一个文件 <a target="_blank" rel="noopener" href="https://github.com/microsoft/TaskMatrix/blob/main/visual_chatgpt.py">visual_chatgpt.py</a>。整个文件从头到尾可以分成四个部分。</p>
<ol>
<li>一系列预先定义好的ChatGPT的Prompt，以及一些会被调用的辅助函数。</li>
<li>一系列视觉模型的Class，每一个Class都代表了一个或者多个图片处理的工具。</li>
<li>一个叫做ConversationBot的Class，实际封装了通过对话调用各种视觉模型工具的流程。</li>
<li>实际从命令行启动整个应用的入口，其实就是对ConverationBot提供了一个Gradio应用的封装。</li>
</ol>
<h3 id="Visual-ChatGPT的调用入口"><a href="#Visual-ChatGPT的调用入口" class="headerlink" title="Visual ChatGPT的调用入口"></a>Visual ChatGPT的调用入口</h3><p>对于源码，我们可以倒过来从下往上看，从Visual ChatGPT的启动入口来学习代码。对应的启动代码其实很简单，就是干了两件事情。</p>
<ol>
<li>从命令行加载了load参数，并且把对应的字符串解析成一个 <code>load_dict</code>，然后通过 <code>load_dict</code> 创建了ConversationBot。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">"checkpoints"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string">"checkpoints"</span><span class="token punctuation">)</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--load'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"ImageCaptioning_cuda:0,Text2Image_cuda:0"</span><span class="token punctuation">)</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    load_dict <span class="token operator">=</span> <span class="token punctuation">&#123;</span>e<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> e<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> e <span class="token keyword">in</span> args<span class="token punctuation">.</span>load<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    bot <span class="token operator">=</span> ConversationBot<span class="token punctuation">(</span>load_dict<span class="token operator">=</span>load_dict<span class="token punctuation">)</span>
    ……
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>然后将整个ConversationBot做成了一个有界面的Gradio应用。</li>
</ol>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">……
    <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Blocks<span class="token punctuation">(</span>css<span class="token operator">=</span><span class="token string">"#chatbot .overflow-y-auto&#123;height:500px&#125;"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> demo<span class="token punctuation">:</span>
        lang <span class="token operator">=</span> gr<span class="token punctuation">.</span>Radio<span class="token punctuation">(</span>choices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Chinese'</span><span class="token punctuation">,</span><span class="token string">'English'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Language'</span><span class="token punctuation">)</span>
        chatbot <span class="token operator">=</span> gr<span class="token punctuation">.</span>Chatbot<span class="token punctuation">(</span>elem_id<span class="token operator">=</span><span class="token string">"chatbot"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Visual ChatGPT"</span><span class="token punctuation">)</span>
        state <span class="token operator">=</span> gr<span class="token punctuation">.</span>State<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Row<span class="token punctuation">(</span>visible<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token keyword">as</span> input_raws<span class="token punctuation">:</span>
            <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>scale<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                txt <span class="token operator">=</span> gr<span class="token punctuation">.</span>Textbox<span class="token punctuation">(</span>show_label<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> placeholder<span class="token operator">=</span><span class="token string">"Enter text and press enter, or upload an image"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>style<span class="token punctuation">(</span>
                    container<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>scale<span class="token operator">=</span><span class="token number">0.15</span><span class="token punctuation">,</span> min_width<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                clear <span class="token operator">=</span> gr<span class="token punctuation">.</span>Button<span class="token punctuation">(</span><span class="token string">"Clear"</span><span class="token punctuation">)</span>
            <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>scale<span class="token operator">=</span><span class="token number">0.15</span><span class="token punctuation">,</span> min_width<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                btn <span class="token operator">=</span> gr<span class="token punctuation">.</span>UploadButton<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">"🖼️"</span><span class="token punctuation">,</span>file_types<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"image"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        lang<span class="token punctuation">.</span>change<span class="token punctuation">(</span>bot<span class="token punctuation">.</span>init_agent<span class="token punctuation">,</span> <span class="token punctuation">[</span>lang<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>input_raws<span class="token punctuation">,</span> lang<span class="token punctuation">,</span> txt<span class="token punctuation">,</span> clear<span class="token punctuation">]</span><span class="token punctuation">)</span>
        txt<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>bot<span class="token punctuation">.</span>run_text<span class="token punctuation">,</span> <span class="token punctuation">[</span>txt<span class="token punctuation">,</span> state<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>chatbot<span class="token punctuation">,</span> state<span class="token punctuation">]</span><span class="token punctuation">)</span>
        txt<span class="token punctuation">.</span>submit<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> txt<span class="token punctuation">)</span>
        btn<span class="token punctuation">.</span>upload<span class="token punctuation">(</span>bot<span class="token punctuation">.</span>run_image<span class="token punctuation">,</span> <span class="token punctuation">[</span>btn<span class="token punctuation">,</span> state<span class="token punctuation">,</span> txt<span class="token punctuation">,</span> lang<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>chatbot<span class="token punctuation">,</span> state<span class="token punctuation">,</span> txt<span class="token punctuation">]</span><span class="token punctuation">)</span>
        clear<span class="token punctuation">.</span>click<span class="token punctuation">(</span>bot<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>clear<span class="token punctuation">)</span>
        clear<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> chatbot<span class="token punctuation">)</span>
        clear<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    demo<span class="token punctuation">.</span>launch<span class="token punctuation">(</span>server_name<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> server_port<span class="token operator">=</span><span class="token number">7860</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们看一下load参数，其实就是指定了不同的工具类应该使用CPU还是GPU，以及对应的模型应该加载到哪一个GPU上。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">python visual_chatgpt<span class="token punctuation">.</span>py <span class="token operator">-</span><span class="token operator">-</span>load "Text2Box_cuda<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>Segmenting_cuda<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>
    Inpainting_cuda<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>ImageCaptioning_cuda<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span>
    Text2Image_cuda<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>Image2Canny_cpu<span class="token punctuation">,</span>CannyText2Image_cuda<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>
    Image2Depth_cpu<span class="token punctuation">,</span>DepthText2Image_cuda<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>VisualQuestionAnswering_cuda<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>
    InstructPix2Pix_cuda<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>Image2Scribble_cpu<span class="token punctuation">,</span>ScribbleText2Image_cuda<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>
    SegText2Image_cuda<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>Image2Pose_cpu<span class="token punctuation">,</span>PoseText2Image_cuda<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span>
    Image2Hed_cpu<span class="token punctuation">,</span>HedText2Image_cuda<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span>Image2Normal_cpu<span class="token punctuation">,</span>
    NormalText2Image_cuda<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span>Image2Line_cpu<span class="token punctuation">,</span>LineText2Image_cuda<span class="token punctuation">:</span><span class="token number">3</span>"
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ConversationBot，一个Langchain-Agnet"><a href="#ConversationBot，一个Langchain-Agnet" class="headerlink" title="ConversationBot，一个Langchain Agnet"></a>ConversationBot，一个Langchain Agnet</h3><p>接下来我们再来看看控制Visual ChatGPT的核心运转流程的ConversationBot是什么样的。ConversationBot里面包含了四个函数，分别是 <code>__init__</code> 的构造函数、 <code>init_agent</code> 函数、 <code>run_text</code> 和 <code>run_image</code> 函数。</p>
<ul>
<li><code>__init__</code> 的构造函数用来加载使用的各个视觉基础模型（Visual Foundation Model）。</li>
<li><code>init_agent</code> 函数构造了一个LangChain的conversation-react-description类型的Agent，用来实际处理整个AI对话过程。</li>
<li><code>run_text</code> 处理用户的文本输入。</li>
<li><code>run_image</code> 处理用户的图片输入。</li>
</ul>
<h4 id="init-构造函数"><a href="#init-构造函数" class="headerlink" title="__init__ 构造函数"></a><code>__init__</code> 构造函数</h4><p>我们先来看看 <code>__init__</code> 这个构造函数。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> load_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># load_dict = &#123;'VisualQuestionAnswering':'cuda:0', 'ImageCaptioning':'cuda:1',...&#125;</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Initializing VisualChatGPT, load_dict=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>load_dict<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'ImageCaptioning'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> load_dict<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"You have to load ImageCaptioning as a basic function for VisualChatGPT"</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>models <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token comment"># Load Basic Foundation Models</span>
        <span class="token keyword">for</span> class_name<span class="token punctuation">,</span> device <span class="token keyword">in</span> load_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>models<span class="token punctuation">[</span>class_name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>class_name<span class="token punctuation">]</span><span class="token punctuation">(</span>device<span class="token operator">=</span>device<span class="token punctuation">)</span>

        <span class="token comment"># Load Template Foundation Models</span>
        <span class="token keyword">for</span> class_name<span class="token punctuation">,</span> module <span class="token keyword">in</span> <span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token string">'template_model'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                template_required_names <span class="token operator">=</span> <span class="token punctuation">&#123;</span>k <span class="token keyword">for</span> k <span class="token keyword">in</span> inspect<span class="token punctuation">.</span>signature<span class="token punctuation">(</span>module<span class="token punctuation">.</span>__init__<span class="token punctuation">)</span><span class="token punctuation">.</span>parameters<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> k<span class="token operator">!=</span><span class="token string">'self'</span><span class="token punctuation">&#125;</span>
                loaded_names <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">type</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__ <span class="token keyword">for</span> e <span class="token keyword">in</span> self<span class="token punctuation">.</span>models<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> template_required_names<span class="token punctuation">.</span>issubset<span class="token punctuation">(</span>loaded_names<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>models<span class="token punctuation">[</span>class_name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>class_name<span class="token punctuation">]</span><span class="token punctuation">(</span>
                        <span class="token operator">**</span><span class="token punctuation">&#123;</span>name<span class="token punctuation">:</span> self<span class="token punctuation">.</span>models<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token keyword">for</span> name <span class="token keyword">in</span> template_required_names<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"All the Available Functions: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>models<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

……
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>代码其实很简单，首先就是将前面从命令行读入的 <code>load_dict</code> 里面的每一个Class都实例化，后面我们会看到，在实例化的过程中，这些Class都会把各种预训练好的模型加载到CPU或者GPU里面来。</p>
<p>这其中有一个情况需要注意，有些模型Class在我们这里叫做 <strong>template_model，其实就是能够组合多个模型组合，来解决一个单一的任务。</strong> 这些Class不是通过命令行传入的参数名称来加载的，而是去判断这个Class需要的其他模型是否都已经加载了，如果都加载了，那么这个Class自然可以用，不需要额外占用显存或者内存。否则的话，这个Class就不会被加载。</p>
<p>接下来就是遍历所有的这些Class，找到里面以inference开头的函数。每一个函数都会被当作是一个LangChain里面的Tool，放到当前实例的Tools数组中去。</p>
<p>然后就创建了Agent需要的LLM和Memory， <strong>如果你想要用GPT-4来管理对话过程以取得更好的效果，你就可以在这里用GPT-4替换掉LLM来做到这一点</strong>。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">……
        self<span class="token punctuation">.</span>tools <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> instance <span class="token keyword">in</span> self<span class="token punctuation">.</span>models<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> e <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> e<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'inference'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    func <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>append<span class="token punctuation">(</span>Tool<span class="token punctuation">(</span>name<span class="token operator">=</span>func<span class="token punctuation">.</span>name<span class="token punctuation">,</span> description<span class="token operator">=</span>func<span class="token punctuation">.</span>description<span class="token punctuation">,</span> func<span class="token operator">=</span>func<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>llm <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>memory <span class="token operator">=</span> ConversationBufferMemory<span class="token punctuation">(</span>memory_key<span class="token operator">=</span><span class="token string">"chat_history"</span><span class="token punctuation">,</span> output_key<span class="token operator">=</span><span class="token string">'output'</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="init-agent-函数"><a href="#init-agent-函数" class="headerlink" title="init_agent 函数"></a><code>init_agent</code> 函数</h4><p>接下来的 <code>init_agent</code> 函数就特别简单了，它其实就是利用上面我们加载的Tools、Memory 以及 LLM 创建了一个 conversational-react-description类型的Agent。这个Agent我们在 <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/648461">第 17 讲</a> 其实已经介绍过了一遍。</p>
<p>不过，这里我们通过 <code>agent_kwargs</code> 为这个Agent专门定制了对应的提示语。这部分提示语我们晚一点再介绍。这里，对于中文和英文Visual ChatGPT只是通过简单的 <code>if...else</code> 提供了一组不同的提示语而已。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">init_agent</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lang<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#clear previous history</span>
    <span class="token keyword">if</span> lang<span class="token operator">==</span><span class="token string">'English'</span><span class="token punctuation">:</span>
        PREFIX<span class="token punctuation">,</span> FORMAT_INSTRUCTIONS<span class="token punctuation">,</span> SUFFIX <span class="token operator">=</span> VISUAL_CHATGPT_PREFIX<span class="token punctuation">,</span> VISUAL_CHATGPT_FORMAT_INSTRUCTIONS<span class="token punctuation">,</span> VISUAL_CHATGPT_SUFFIX
        place <span class="token operator">=</span> <span class="token string">"Enter text and press enter, or upload an image"</span>
        label_clear <span class="token operator">=</span> <span class="token string">"Clear"</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        PREFIX<span class="token punctuation">,</span> FORMAT_INSTRUCTIONS<span class="token punctuation">,</span> SUFFIX <span class="token operator">=</span> VISUAL_CHATGPT_PREFIX_CN<span class="token punctuation">,</span> VISUAL_CHATGPT_FORMAT_INSTRUCTIONS_CN<span class="token punctuation">,</span> VISUAL_CHATGPT_SUFFIX_CN
        place <span class="token operator">=</span> <span class="token string">"输入文字并回车，或者上传图片"</span>
        label_clear <span class="token operator">=</span> <span class="token string">"清除"</span>
    self<span class="token punctuation">.</span>agent <span class="token operator">=</span> initialize_agent<span class="token punctuation">(</span>
        self<span class="token punctuation">.</span>tools<span class="token punctuation">,</span>
        self<span class="token punctuation">.</span>llm<span class="token punctuation">,</span>
        agent<span class="token operator">=</span><span class="token string">"conversational-react-description"</span><span class="token punctuation">,</span>
        verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        memory<span class="token operator">=</span>self<span class="token punctuation">.</span>memory<span class="token punctuation">,</span>
        return_intermediate_steps<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        agent_kwargs<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'prefix'</span><span class="token punctuation">:</span> PREFIX<span class="token punctuation">,</span> <span class="token string">'format_instructions'</span><span class="token punctuation">:</span> FORMAT_INSTRUCTIONS<span class="token punctuation">,</span>
                      <span class="token string">'suffix'</span><span class="token punctuation">:</span> SUFFIX<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> gr<span class="token punctuation">.</span>update<span class="token punctuation">(</span>visible <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gr<span class="token punctuation">.</span>update<span class="token punctuation">(</span>visible <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gr<span class="token punctuation">.</span>update<span class="token punctuation">(</span>placeholder<span class="token operator">=</span>place<span class="token punctuation">)</span><span class="token punctuation">,</span> gr<span class="token punctuation">.</span>update<span class="token punctuation">(</span>value<span class="token operator">=</span>label_clear<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="run-text-和-run-image-函数"><a href="#run-text-和-run-image-函数" class="headerlink" title="run_text 和 run_image 函数"></a><code>run_text</code> 和 <code>run_image</code> 函数</h4><p>实际处理对话的 <code>run_text</code> 和 <code>run_image</code> 函数也非常简单。 <code>run_text</code> 函数就是先确保Memory不要超出我们设置的上下文长度的限制。然后直接调用Agent来应对用户输入的文本。并且对于输出的结果，它只是做了一些文件名上的字符串显示的处理而已。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">run_text</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>memory<span class="token punctuation">.</span><span class="token builtin">buffer</span> <span class="token operator">=</span> cut_dialogue_history<span class="token punctuation">(</span>self<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>memory<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">,</span> keep_last_n_words<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">)</span>
    res <span class="token operator">=</span> self<span class="token punctuation">.</span>agent<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"input"</span><span class="token punctuation">:</span> text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    res<span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\\"</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">'(image/[-\w]*.png)'</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> m<span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f'![](file=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">)*</span><span class="token interpolation"><span class="token punctuation">&#123;</span>m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">*'</span></span><span class="token punctuation">,</span> res<span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    state <span class="token operator">=</span> state <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\nProcessed run_text, Input text: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>text<span class="token punctuation">&#125;</span></span><span class="token string">\nCurrent state: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>state<span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span>
          <span class="token string-interpolation"><span class="token string">f"Current Memory: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>memory<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> state<span class="token punctuation">,</span> state
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而 <code>run_image</code> 函数，则是把用户上传的图片转换成完全相同的尺寸和格式。此外，它还会使用ImageCaptioning这个模型拿到图片的描述。最后，模型将图片名称和描述等信息也作为一轮对话拼接到Agent的memory里面去。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token keyword">def</span> <span class="token function">run_image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">,</span> state<span class="token punctuation">,</span> txt<span class="token punctuation">,</span> lang<span class="token punctuation">)</span><span class="token punctuation">:</span>
    image_filename <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'image'</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">8]</span><span class="token punctuation">&#125;</span></span><span class="token string">.png"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"======>Auto Resize Image..."</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    width<span class="token punctuation">,</span> height <span class="token operator">=</span> img<span class="token punctuation">.</span>size
    ratio <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">512</span> <span class="token operator">/</span> width<span class="token punctuation">,</span> <span class="token number">512</span> <span class="token operator">/</span> height<span class="token punctuation">)</span>
    width_new<span class="token punctuation">,</span> height_new <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>width <span class="token operator">*</span> ratio<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">round</span><span class="token punctuation">(</span>height <span class="token operator">*</span> ratio<span class="token punctuation">)</span><span class="token punctuation">)</span>
    width_new <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>width_new <span class="token operator">/</span> <span class="token number">64.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">64</span>
    height_new <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>height_new <span class="token operator">/</span> <span class="token number">64.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">64</span>
    img <span class="token operator">=</span> img<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>width_new<span class="token punctuation">,</span> height_new<span class="token punctuation">)</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> img<span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>
    img<span class="token punctuation">.</span>save<span class="token punctuation">(</span>image_filename<span class="token punctuation">,</span> <span class="token string">"PNG"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Resize image form </span><span class="token interpolation"><span class="token punctuation">&#123;</span>width<span class="token punctuation">&#125;</span></span><span class="token string">x</span><span class="token interpolation"><span class="token punctuation">&#123;</span>height<span class="token punctuation">&#125;</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token punctuation">&#123;</span>width_new<span class="token punctuation">&#125;</span></span><span class="token string">x</span><span class="token interpolation"><span class="token punctuation">&#123;</span>height_new<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    description <span class="token operator">=</span> self<span class="token punctuation">.</span>models<span class="token punctuation">[</span><span class="token string">'ImageCaptioning'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>inference<span class="token punctuation">(</span>image_filename<span class="token punctuation">)</span>
    <span class="token keyword">if</span> lang <span class="token operator">==</span> <span class="token string">'Chinese'</span><span class="token punctuation">:</span>
        Human_prompt <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'\nHuman: 提供一张名为 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>image_filename<span class="token punctuation">&#125;</span></span><span class="token string">的图片。它的描述是: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>description<span class="token punctuation">&#125;</span></span><span class="token string">。 这些信息帮助你理解这个图像，但是你应该使用工具来完成下面的任务，而不是直接从我的描述中想象。 如果你明白了, 说 \"收到\". \n'</span></span>
        AI_prompt <span class="token operator">=</span> <span class="token string">"收到。  "</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        Human_prompt <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'\nHuman: provide a figure named </span><span class="token interpolation"><span class="token punctuation">&#123;</span>image_filename<span class="token punctuation">&#125;</span></span><span class="token string">. The description is: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>description<span class="token punctuation">&#125;</span></span><span class="token string">. This information helps you to understand this image, but you should use tools to finish following tasks, rather than directly imagine from my description. If you understand, say \"Received\". \n'</span></span>
        AI_prompt <span class="token operator">=</span> <span class="token string">"Received.  "</span>
    self<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>memory<span class="token punctuation">.</span><span class="token builtin">buffer</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>memory<span class="token punctuation">.</span><span class="token builtin">buffer</span> <span class="token operator">+</span> Human_prompt <span class="token operator">+</span> <span class="token string">'AI: '</span> <span class="token operator">+</span> AI_prompt
    state <span class="token operator">=</span> state <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"![](file=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>image_filename<span class="token punctuation">&#125;</span></span><span class="token string">)*</span><span class="token interpolation"><span class="token punctuation">&#123;</span>image_filename<span class="token punctuation">&#125;</span></span><span class="token string">*"</span></span><span class="token punctuation">,</span> AI_prompt<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\nProcessed run_image, Input image: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>image_filename<span class="token punctuation">&#125;</span></span><span class="token string">\nCurrent state: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>state<span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span>
          <span class="token string-interpolation"><span class="token string">f"Current Memory: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>memory<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> state<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>txt<span class="token punctuation">&#125;</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">&#123;</span>image_filename<span class="token punctuation">&#125;</span></span><span class="token string"> '</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Visual-Foundation-Model，实际处理图片的工具"><a href="#Visual-Foundation-Model，实际处理图片的工具" class="headerlink" title="Visual Foundation Model，实际处理图片的工具"></a>Visual Foundation Model，实际处理图片的工具</h3><p>看完了ConversationBot，我们就知道其实我们向Visual ChatGPT输入的各种文本指令，都会变成对某一个视觉基础模型（Visual Foundation Model）的调用。那么，我们就挑一两个视觉基础模型，来看看具体里面是如何调用的。</p>
<p>我们还是拿之前我们比较熟悉的通过Canny算法进行边缘检测的CannyText2Image来演示好了。在这个Class的构造函数里，我们还是通过Diffusers的Pipeline加载了Stable Diffusion和ControlNet的模型。这样，后面我们就可以用这个Pipeline来对图片进行处理了。</p>
<p>另外，在构造函数的最后，它还设置了一系列正面和负面的提示语内容。负面的提示语用于排除低质量的照片，而正面的提示语则会和用户输入的提示语拼接到一起，用来生成图片。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">CannyText2Image</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Initializing CannyText2Image to </span><span class="token interpolation"><span class="token punctuation">&#123;</span>device<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>torch_dtype <span class="token operator">=</span> torch<span class="token punctuation">.</span>float16 <span class="token keyword">if</span> <span class="token string">'cuda'</span> <span class="token keyword">in</span> device <span class="token keyword">else</span> torch<span class="token punctuation">.</span>float32
        self<span class="token punctuation">.</span>controlnet <span class="token operator">=</span> ControlNetModel<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span><span class="token string">"fusing/stable-diffusion-v1-5-controlnet-canny"</span><span class="token punctuation">,</span>
                                                          torch_dtype<span class="token operator">=</span>self<span class="token punctuation">.</span>torch_dtype<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pipe <span class="token operator">=</span> StableDiffusionControlNetPipeline<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>
            <span class="token string">"runwayml/stable-diffusion-v1-5"</span><span class="token punctuation">,</span> controlnet<span class="token operator">=</span>self<span class="token punctuation">.</span>controlnet<span class="token punctuation">,</span> safety_checker<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
            torch_dtype<span class="token operator">=</span>self<span class="token punctuation">.</span>torch_dtype<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>scheduler <span class="token operator">=</span> UniPCMultistepScheduler<span class="token punctuation">.</span>from_config<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pipe<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>seed <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        self<span class="token punctuation">.</span>a_prompt <span class="token operator">=</span> <span class="token string">'best quality, extremely detailed'</span>
        self<span class="token punctuation">.</span>n_prompt <span class="token operator">=</span> <span class="token string">'longbody, lowres, bad anatomy, bad hands, missing fingers, extra digit, '</span> \
                            <span class="token string">'fewer digits, cropped, worst quality, low quality'</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>除了构造函数，这个Class还有一个inference函数。这个函数通过Prompts这个decorator定义了name和description属性，这些属性也是我们实际加载Tools的时候使用的参数。Agent就会根据这些描述判断用户输入的文本是否应该使用当前这个工具。比如这里 CannyText2Image的description里，就告诉你用户一般会通过“generate a real image of a object or something from this canny image” 这样的指令来调用当前的工具。</p>
<p>而对应的inference函数的内容，就是简单地根据输入的文本调用模型来处理图片。不过要注意，这里作为输入的Inputs文本，并不是用户原始输入的内容。而是通过ConversationBot的Agent，经过“思考”之后拿到的Action Inputs。这个Inputs里面，既会包含需要处理的图片路径，也会包含对应的Prompts。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@prompts</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"Generate Image Condition On Canny Image"</span><span class="token punctuation">,</span>
         description<span class="token operator">=</span><span class="token string">"useful when you want to generate a new real image from both the user description and a canny image."</span>
                     <span class="token string">" like: generate a real image of a object or something from this canny image,"</span>
                     <span class="token string">" or generate a new real image of a object or something from this edge image. "</span>
                     <span class="token string">"The input to this tool should be a comma separated string of two, "</span>
                     <span class="token string">"representing the image_path and the user description. "</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">inference</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    image_path<span class="token punctuation">,</span> instruct_text <span class="token operator">=</span> inputs<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>inputs<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>seed <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">65535</span><span class="token punctuation">)</span>
    seed_everything<span class="token punctuation">(</span>self<span class="token punctuation">.</span>seed<span class="token punctuation">)</span>
    prompt <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>instruct_text<span class="token punctuation">&#125;</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>a_prompt<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span>
    image <span class="token operator">=</span> self<span class="token punctuation">.</span>pipe<span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> image<span class="token punctuation">,</span> num_inference_steps<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> eta<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> negative_prompt<span class="token operator">=</span>self<span class="token punctuation">.</span>n_prompt<span class="token punctuation">,</span>
                      guidance_scale<span class="token operator">=</span><span class="token number">9.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    updated_image_path <span class="token operator">=</span> get_new_image_name<span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> func_name<span class="token operator">=</span><span class="token string">"canny2image"</span><span class="token punctuation">)</span>
    image<span class="token punctuation">.</span>save<span class="token punctuation">(</span>updated_image_path<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\nProcessed CannyText2Image, Input Canny: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>image_path<span class="token punctuation">&#125;</span></span><span class="token string">, Input Text: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>instruct_text<span class="token punctuation">&#125;</span></span><span class="token string">, "</span></span>
          <span class="token string-interpolation"><span class="token string">f"Output Text: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>updated_image_path<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> updated_image_path
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当然，不是所有模型Class的inference函数都这么简单。有些Class，特别是我们前面介绍过的template_model的Class，它的inference函数会复杂一些，需要多次调用多个模型组合来完成任务。比如InfinityOutPainting这个Class，就需要不断循环调用VisualQuestionAnswering和ImageCaption来获取图片的描述，然后通过Inpainting来补全图片中没有画出来的部分，最终实现把图片无限扩大，补全扩大出来的部分背景的能力。</p>
<h3 id="复盘Prompt，理解Task-Matrix机制"><a href="#复盘Prompt，理解Task-Matrix机制" class="headerlink" title="复盘Prompt，理解Task Matrix机制"></a>复盘Prompt，理解Task Matrix机制</h3><p>我们刚才说过，每个Class模型拿到的inputs输入都是模型“思考”之后根据用户输入提取出来的Action Inputs。这一点，其实还是要归功于ChatGPT强大的逻辑推理能力。我们只要回到代码的开头，看一下对应的Prompts其实就能知道Visual ChatGPT是怎么做到的了。实际上，每次用户输入的内容，都是通过VISUAL_CHATGPT_PREFIX、VISUAL_CHATGPT_FORMAT_INSTRUCTIONS和VISUAL_CHATGPT_SUFFIX这三段Prompts拼接而成的。</p>
<p>而AI的思考过程，其实就是VISUAL_CHATGPT_FORMAT_INSTRUCTIONS这一小段。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">VISUAL_CHATGPT_FORMAT_INSTRUCTIONS <span class="token operator">=</span> <span class="token triple-quoted-string string">"""To use a tool, please use the following format:

Thought: Do I need to use a tool? Yes
Action: the action to take, should be one of [&#123;tool_names&#125;]
Action Input: the input to the action
Observation: the result of the action

When you have a response to say to the Human, or if you do not need to use a tool, you MUST use the format:

Thought: Do I need to use a tool? No
&#123;ai_prefix&#125;: [your response here]

"""</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个其实就是我在 <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/648461">第 17 讲</a> 里给你看过的MRKL的提示语模版。AI通过Thought、Action、Action Input 和 Observation 这样的四轮循环，完成一次Tools的判定与调用。并且，每次给到Agent的输入里，都可以包含多个迭代的Action和Action Input，调用多次模型Class来解决问题。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>看完这个代码之后，相信你完全有能力修改代码满足自己的需求了。如果有一天出现了一个更好用的视觉基础模型，你完全可以把这个新的模型Class加入到Visual ChatGPT中。你只需要通过 <code>__init__</code> 函数加载模型，然后定义好它对应的提示语以及inference函数，就能让Visual ChatGPT支持一种新的图片编辑和绘制功能了。</p>
<p><img src="https://note-1252548816.cos.ap-nanjing.myqcloud.com/uPic/202312/a8073d98yy964983cc03c35deb0a42f8.png"></p>
<p>回顾整个Visual ChatGPT的代码，其实并不复杂。它就是将 <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/648461">第 17 讲</a> 我们介绍过的LangChain的Agent，和过去3讲我们介绍的各种视觉大模型组合起来，通过ChatGPT的语言和逻辑推理能力处理用户输入，通过LangChain的Agent机制来调度推理过程和工具的使用，通过视觉大模型实际来处理图片以及理解图片的内容。</p>
<p>这样的机制其实不仅可以用来处理图片，也可以用在其他机器学习的模型里，比如语音、视频，甚至你还可以利用它再去调用别的大语言模型。而这个机制，后来也被微软进一步扩展到Task Matrix这个概念里。Visual ChatGPT的代码库的名称今天也被改成了Task Matrix，也就是“任务矩阵”的意思。</p>
<h2 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h2><p>最后，按照惯例还是给你留一道思考题。</p>
<p>Stable Diffusion的提示语是不支持中文的，但是Visual ChatGPT支持你通过中文输入你对图片的绘制和修改要求。你觉得它目前的实现有没有什么问题？如果我们想要让它不只支持中文和英文，也能支持德文、法文、西班牙文等各个语种，我们可以怎么做？欢迎你把思考后的结果分享到评论区，我们一起讨论，也欢迎你把这一讲分享给需要的朋友，我们下一讲再见！</p>
<h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><p>在Visual ChatGPT之后，微软更进一步将这个概念扩展成为Task Matrix，也对应发表了一篇 <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2303.16434">论文</a>。你有兴趣的话，可以去阅读一下。</p>
</article><div class="tag_share"><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#26%EF%BD%9CVisual-ChatGPT%E6%98%AF%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E8%BE%B9%E8%81%8A%E8%BE%B9%E7%94%BB%E7%9A%84%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">26｜Visual ChatGPT是如何做到边聊边画的？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%93%E9%AA%8C-Visual-ChatGPT"><span class="toc-number">1.1.</span> <span class="toc-text">体验 Visual ChatGPT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Visual-ChatGPT%E7%9A%84%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.</span> <span class="toc-text">Visual ChatGPT的原理与实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Visual-ChatGPT%E7%9A%84%E8%B0%83%E7%94%A8%E5%85%A5%E5%8F%A3"><span class="toc-number">1.2.1.</span> <span class="toc-text">Visual ChatGPT的调用入口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConversationBot%EF%BC%8C%E4%B8%80%E4%B8%AALangchain-Agnet"><span class="toc-number">1.2.2.</span> <span class="toc-text">ConversationBot，一个Langchain Agnet</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#init-%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">__init__ 构造函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#init-agent-%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">init_agent 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#run-text-%E5%92%8C-run-image-%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">run_text 和 run_image 函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Visual-Foundation-Model%EF%BC%8C%E5%AE%9E%E9%99%85%E5%A4%84%E7%90%86%E5%9B%BE%E7%89%87%E7%9A%84%E5%B7%A5%E5%85%B7"><span class="toc-number">1.2.3.</span> <span class="toc-text">Visual Foundation Model，实际处理图片的工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E7%9B%98Prompt%EF%BC%8C%E7%90%86%E8%A7%A3Task-Matrix%E6%9C%BA%E5%88%B6"><span class="toc-number">1.2.4.</span> <span class="toc-text">复盘Prompt，理解Task Matrix机制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.3.</span> <span class="toc-text">小结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%80%83%E9%A2%98"><span class="toc-number">1.4.</span> <span class="toc-text">思考题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB"><span class="toc-number">1.5.</span> <span class="toc-text">推荐阅读</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2023/10/21/vq13okXnTbxDG2R.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By 码农张三</div></div><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/9.4.0/mermaid.min.js"></script></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div></div></body></html>